<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>下载 Ensembl 里面所有鸟类的 基因组……</title>
      <link href="/2020/05/25/wget_Ensembl/"/>
      <url>/2020/05/25/wget_Ensembl/</url>
      
        <content type="html"><![CDATA[<h1 id="如何从ENSEMBL数据库-下载里面所有鸟类的-基因组-蛋白序列-cds序列-和gff3注释文件"><a href="#如何从ENSEMBL数据库-下载里面所有鸟类的-基因组-蛋白序列-cds序列-和gff3注释文件" class="headerlink" title="如何从ENSEMBL数据库 下载里面所有鸟类的 基因组 蛋白序列 cds序列 和gff3注释文件"></a>如何从ENSEMBL数据库 下载里面所有鸟类的 基因组 蛋白序列 cds序列 和gff3注释文件</h1><p>去年下过一次 但是当时没有存下过程<br>首先进入Ensmbl数据库下载 all Species list (首页给出的Sp list 只有动物的)<br>然后根据图片和common name挑选出哪些是鸟类，并把前两列存在一个新的txt文件中</p><p>38bird.ensembl.list.txt</p><p>然后观察ftp网址发现，只需要有scientific name就可以下载，但是所有字母都为小写，且string之间有下划线</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sed -i &apos;&apos; &apos;s/ /_/g&apos; 38bird.ensembl.list.txt</span><br><span class="line">awk &apos;&#123;print $2&#125;&apos; 38bird.ensembl.list.txt &gt; specific_name.list</span><br><span class="line">cat scientific_name.list | tr  &apos;[A-Z]&apos; &apos;[a-z]&apos; &gt; xiaoxie.scientific.list</span><br></pre></td></tr></table></figure><p>然后就可以根据 xiaoxie.scientific.list 循环输出wget下载命令,用wget -c 可以续传，因为下载速度实在太慢了</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">less xiaoxie.scientific.list | while read line</span><br><span class="line">do</span><br><span class="line">echo &apos;wget -c ftp://ftp.ensembl.org/pub/release-100/fasta/&apos;$&#123;line&#125;&apos;/cds/*.cds.all.fa.gz&apos;</span><br><span class="line">done &gt; download_cds.sh</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">less xiaoxie.scientific.list | while read line</span><br><span class="line">do</span><br><span class="line">echo &apos;wget -c  ftp://ftp.ensembl.org/pub/release-100/gff3/&apos;$&#123;line&#125;&apos;/*.100.gff3.gz&apos;</span><br><span class="line">done &gt; download_gff3.sh</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">less xiaoxie.scientific.list | while read line</span><br><span class="line">do</span><br><span class="line">echo &apos;wget -c  ftp://ftp.ensembl.org/pub/release-100/fasta/&apos;$&#123;line&#125;&apos;/pep/*.100.gff3.gz&apos;</span><br><span class="line">done &gt; download_protein.sh</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">less xiaoxie.scientific.list | while read line</span><br><span class="line">do</span><br><span class="line">echo &apos;wget -c ftp://ftp.ensembl.org/pub/release-100/fasta/&apos;$&#123;line&#125;&apos;/dna/*.dna_sm.toplevel.fa.gz&apos;</span><br><span class="line">done &gt; download_genome.sh</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">nohup sh *.sh &gt; run_gwt.log</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> Ensembl </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>过滤Ensembl中数据的冗余信息</title>
      <link href="/2020/05/25/Ensembl_filter/"/>
      <url>/2020/05/25/Ensembl_filter/</url>
      
        <content type="html"><![CDATA[<h2 id="Ensembl-格式介绍"><a href="#Ensembl-格式介绍" class="headerlink" title="Ensembl 格式介绍"></a>Ensembl 格式介绍</h2><p>u1s1 真的佩服Emsembl数据库的开发团队，十分想问候他们怎么做的这么详细的</p><hr><p>sudo killall coreaudiod</p><p>Ensembl 数据库格式十分简洁明了，每一个基因都有对应的 gene id, 每一个转录本有对应的<br>trasncript id, 每一个蛋白有对应的 protein id, 而且这三个id之间。。没有规律</p><p>比如 这是鸡中的一个蛋白序列的简化stable的信息</p><blockquote><p>ENSGALG00000009622    ENSGALT00000032268     ENSGALP00000031632<br>其实在真实的序列中，也不是上面的样子而是如下这样包含了stableeversion的</p><blockquote><p>ENSGALP00000073247.1 pep chromosome:GRCg6a:15:8238927:8239208:1<br>gene:ENSGALG00000049010.1 transcript:ENSGALT00000103863.1<br>gene_biotype:IG_V_gene transcript_biotype:IG_V_gene</p></blockquote></blockquote><p>在biomart中 除了stable id 还有很多label .. awesome～</p><h3 id="我想要得到蛋白序列中同一个gene-id中最长的蛋白序列"><a href="#我想要得到蛋白序列中同一个gene-id中最长的蛋白序列" class="headerlink" title="我想要得到蛋白序列中同一个gene id中最长的蛋白序列"></a>我想要得到蛋白序列中同一个gene id中最长的蛋白序列</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$PATH:OrthoFinder/tools/primary_transcript.py</span><br></pre></td></tr></table></figure><p>orthofinder 中已经给出了怎么提取最长转录本的python脚本。并且最长的转录本的id被替换为gene id输出</p><p>提蛋白真的很方便，但是，老师还需要对应基因的intron序列<br>intron序列就需要gff文件中的exon信息和mRNA信息</p><p>怎么通过带着gene id的最长转录本去过滤gff文件呢。</p><blockquote><p>经过一系列的测试。。比如带gene id的蛋白序列blastp回去找到transcript id。但是blast的算法导致 multi match的情况不好去除</p></blockquote><p>所以还是得写个脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">from</span> operator <span class="keyword">import</span> itemgetter</span><br><span class="line"></span><br><span class="line">lst = []</span><br><span class="line">Sequence = &#123;&#125;</span><br><span class="line"></span><br><span class="line">transcript2gene = &#123;&#125;</span><br><span class="line">pep2gene = &#123;&#125;</span><br><span class="line"><span class="keyword">with</span> open(sys.argv[<span class="number">1</span>]) <span class="keyword">as</span> input_emsembl_fasta:</span><br><span class="line">    <span class="keyword">for</span> row <span class="keyword">in</span> input_emsembl_fasta:</span><br><span class="line">        <span class="keyword">if</span> row.startswith(<span class="string">'&gt;'</span>):</span><br><span class="line">            lst = row.split(<span class="string">" "</span>)</span><br><span class="line">            pep_id = lst[<span class="number">0</span>].replace(<span class="string">'&gt;'</span>,<span class="string">''</span>)</span><br><span class="line">            gene_id = lst[<span class="number">3</span>].replace(<span class="string">'gene:'</span>,<span class="string">''</span>)</span><br><span class="line">            transcript_id = lst[<span class="number">4</span>].replace(<span class="string">'transcript:'</span>,<span class="string">''</span>)</span><br><span class="line">            Sequence[transcript_id] = <span class="string">''</span></span><br><span class="line">            transcript2gene[transcript_id] = gene_id</span><br><span class="line">            pep2gene[transcript_id] = pep_id</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            Sequence[transcript_id] += row.strip()</span><br><span class="line"><span class="keyword">with</span> open(<span class="string">"t1.temp"</span>,<span class="string">'w'</span>) <span class="keyword">as</span> Out:</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> Sequence.keys():</span><br><span class="line">        Out.write(i+<span class="string">"\t"</span>+str(len(Sequence[i]))+<span class="string">"\t"</span>+transcript2gene[i]+<span class="string">'\t'</span>+pep2gene[i]+<span class="string">"\n"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> operator <span class="keyword">import</span> itemgetter</span><br><span class="line">gene_id_len=open(<span class="string">"t1.temp"</span>,<span class="string">"r"</span>)</span><br><span class="line">table = []</span><br><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> gene_id_len:</span><br><span class="line">    col = line.strip().split(<span class="string">"\t"</span>)</span><br><span class="line">    col[<span class="number">0</span>] = str(col[<span class="number">0</span>])</span><br><span class="line">    col[<span class="number">1</span>] = int(col[<span class="number">1</span>])</span><br><span class="line">    col[<span class="number">2</span>] = str(col[<span class="number">2</span>])</span><br><span class="line">    col[<span class="number">3</span>] = str(col[<span class="number">3</span>])</span><br><span class="line">    table.append(col)</span><br><span class="line"><span class="comment">#print(table)</span></span><br><span class="line">table_sorted = sorted(table, key=itemgetter(<span class="number">2</span>, <span class="number">1</span>),reverse=<span class="literal">True</span>)</span><br><span class="line"><span class="comment">#print(table_sorted)</span></span><br><span class="line">output_file = open(<span class="string">"t2.temp"</span>,<span class="string">"w"</span>)</span><br><span class="line"><span class="keyword">for</span> row <span class="keyword">in</span> table_sorted:</span><br><span class="line">    row = [str(x) <span class="keyword">for</span> x <span class="keyword">in</span> row]</span><br><span class="line">    output_file.write(<span class="string">"\t"</span>.join(row) + <span class="string">'\n'</span>)</span><br><span class="line">output_file.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">input_file=open(<span class="string">"t2.temp"</span>,<span class="string">"r"</span>)</span><br><span class="line">dict2=&#123;&#125;</span><br><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> input_file.readlines():</span><br><span class="line">    col = line.strip().split(<span class="string">"\t"</span>)</span><br><span class="line">    col[<span class="number">0</span>] = str(col[<span class="number">0</span>])</span><br><span class="line">    col[<span class="number">1</span>] = int(col[<span class="number">1</span>])</span><br><span class="line">    col[<span class="number">2</span>] = str(col[<span class="number">2</span>])</span><br><span class="line">    col[<span class="number">3</span>] = str(col[<span class="number">3</span>])</span><br><span class="line">    <span class="keyword">if</span> col[<span class="number">2</span>] <span class="keyword">not</span> <span class="keyword">in</span> dict2:</span><br><span class="line">        dict2[col[<span class="number">2</span>]]=col[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        dict2[col[<span class="number">2</span>]]+= <span class="string">'\t'</span>+col[<span class="number">0</span>]</span><br><span class="line"><span class="comment">#print(dict2)</span></span><br><span class="line"><span class="comment">#print(dict2.values())</span></span><br><span class="line">list_values=list(dict2.values())</span><br><span class="line"><span class="comment">#print(list_values)</span></span><br><span class="line">result_file = open(<span class="string">"final.fa"</span>,<span class="string">"w"</span>)</span><br><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> list_values:</span><br><span class="line">    col = line.strip().split(<span class="string">"\t"</span>)</span><br><span class="line">    col[<span class="number">0</span>] = str(col[<span class="number">0</span>])</span><br><span class="line">    <span class="comment">#print(col[0])</span></span><br><span class="line"></span><br><span class="line">    result_file.write(col[<span class="number">0</span>]+<span class="string">"\n"</span>)</span><br><span class="line">result_file.close()</span><br></pre></td></tr></table></figure><p>专为Ensembl设计，结果会保存最长转录本的 transcript id， gene id， pep id</p><p>然后再过滤gff</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">import sys</span><br><span class="line"></span><br><span class="line">ab = &#123;&#125;</span><br><span class="line">with open(sys.argv[1]) as  rename_file:</span><br><span class="line">    for row in rename_file:</span><br><span class="line">        lst1 = row.strip().split(&apos;\t&apos;)</span><br><span class="line">        ab[lst1[0]] = lst1[1]</span><br><span class="line"></span><br><span class="line">with open(sys.argv[2]) as gff_file:</span><br><span class="line">    for row in gff_file:</span><br><span class="line">for key,value in ab.items():</span><br><span class="line">           if &quot;ID=gene:&quot;+key in row:</span><br><span class="line">                print(row.strip())</span><br><span class="line">            elif value in row:</span><br><span class="line">                print(row.strip())</span><br></pre></td></tr></table></figure><p>这样就得到了只包含最长转录本的gff文件</p><p>再用张老师的提取intron的脚本就可以得到intron文件</p><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/perl -w</span></span><br><span class="line"><span class="keyword">use</span> warnings;</span><br><span class="line"><span class="keyword">use</span> strict;</span><br><span class="line"><span class="keyword">use</span> Set::IntSpan;</span><br><span class="line"><span class="keyword">use</span> Bio::DB::Fasta;</span><br><span class="line"></span><br><span class="line"><span class="comment"># date, 2016-12-30, zhanglei</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">my</span> $ref       = $ARGV[<span class="number">0</span>];</span><br><span class="line"><span class="keyword">my</span> $gene2pep  = $ARGV[<span class="number">1</span>];</span><br><span class="line"><span class="keyword">my</span> $gene2tran = $ARGV[<span class="number">2</span>];</span><br><span class="line"><span class="keyword">my</span> $gtf       = $ARGV[<span class="number">3</span>];</span><br><span class="line"><span class="keyword">my</span> $out       = $ARGV[<span class="number">4</span>];</span><br><span class="line"><span class="keyword">die</span> <span class="string">"Usage: $0 ref.fa gene2pep gene2transcript file.gff3 out.fa</span></span><br><span class="line"><span class="string">This script is used to extract intron from the gff3 file(NOT GTF file!)\n"</span> <span class="keyword">if</span> @ARGV &lt; <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> <span class="string">"Loading the ID file\t"</span>;</span><br><span class="line"><span class="keyword">my</span> %gene2peps;</span><br><span class="line"><span class="keyword">my</span> %trans2gene;</span><br><span class="line"><span class="keyword">open</span> IN, <span class="string">"&lt;$gene2pep"</span>;</span><br><span class="line"><span class="keyword">while</span> (&lt;IN&gt;) &#123;</span><br><span class="line"><span class="keyword">chomp</span>;</span><br><span class="line"><span class="keyword">my</span> @array = (<span class="keyword">split</span> <span class="regexp">/\s+/</span>);</span><br><span class="line">$gene2peps&#123;$array[<span class="number">0</span>]&#125; = $array[<span class="number">1</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">close</span> IN;</span><br><span class="line"></span><br><span class="line"><span class="keyword">open</span> IN, <span class="string">"&lt;$gene2tran"</span>;</span><br><span class="line"><span class="keyword">while</span> (&lt;IN&gt;) &#123;</span><br><span class="line"><span class="keyword">chomp</span>;</span><br><span class="line"><span class="keyword">my</span> @array = (<span class="keyword">split</span> <span class="regexp">/\s+/</span>);</span><br><span class="line">$trans2gene&#123;$array[<span class="number">1</span>]&#125; = $array[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">close</span> IN;</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> <span class="string">"Extracting gff3 file\t"</span>;</span><br><span class="line"><span class="comment"># extract gtf</span></span><br><span class="line"><span class="keyword">open</span> IN, <span class="string">"&lt;$gtf"</span>;</span><br><span class="line"><span class="keyword">my</span> @lines;</span><br><span class="line"><span class="keyword">while</span> (&lt;IN&gt;) &#123;</span><br><span class="line"><span class="keyword">my</span> @array = (<span class="keyword">split</span> <span class="regexp">/\s+/</span>, $_);</span><br><span class="line"><span class="keyword">if</span> ($array[<span class="number">2</span>] eq <span class="string">'mRNA'</span> || $array[<span class="number">2</span>] eq <span class="string">'exon'</span>) &#123;</span><br><span class="line"><span class="keyword">push</span> @lines, $_;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">close</span> IN;</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> <span class="string">"done\n"</span>;</span><br><span class="line"><span class="keyword">print</span> <span class="string">"Formatdb $ref\t"</span>;</span><br><span class="line"><span class="comment"># sequence DB</span></span><br><span class="line"><span class="keyword">my</span> $ref_db = Bio::DB::Fasta -&gt; new($ref);</span><br><span class="line"><span class="keyword">print</span> <span class="string">"done\n"</span>;</span><br><span class="line"><span class="keyword">print</span> <span class="string">"Get gene id from gff3\t"</span>;</span><br><span class="line"><span class="comment"># load the gff file</span></span><br><span class="line"><span class="keyword">open</span> OUT, <span class="string">"&gt;$out"</span>;</span><br><span class="line"><span class="keyword">my</span> %hash;</span><br><span class="line"><span class="keyword">foreach</span> (@lines) &#123;</span><br><span class="line"><span class="keyword">chomp</span>;</span><br><span class="line"><span class="keyword">next</span> <span class="keyword">if</span> /^<span class="comment">#/;</span></span><br><span class="line"><span class="keyword">next</span> <span class="keyword">if</span> /^\<span class="keyword">s</span>+<span class="regexp">/;</span></span><br><span class="line"><span class="regexp">my @cols = (split /</span>\<span class="keyword">s</span>+<span class="regexp">/, $_);</span></span><br><span class="line"><span class="regexp">my $gene_id = my $trans_id = my $pep_id;</span></span><br><span class="line"><span class="regexp">if ($cols[2] eq 'mRNA') &#123;</span></span><br><span class="line"><span class="regexp">($gene_id) = (/</span>Parent\=gene\:(\w+);<span class="regexp">/);   #Parent=gene:ENSGALG00000053455</span></span><br><span class="line"><span class="regexp">($trans_id) = (/</span>ID\=transcript\:(\w+);<span class="regexp">/);</span></span><br><span class="line"><span class="regexp">#print "mRNA $gene_id $trans_id\n";</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp">elsif ($cols[2] eq 'exon') &#123;</span></span><br><span class="line"><span class="regexp">($trans_id) = (/</span>Parent\=transcript\:(\w+);<span class="regexp">/);  #Parent=transcript:</span></span><br><span class="line"><span class="regexp">$gene_id = $trans2gene&#123;$trans_id&#125;;</span></span><br><span class="line"><span class="regexp">#print "exon $gene_id $trans_id\n";</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp">$pep_id = $gene2peps&#123;$gene_id&#125;;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">next unless $gene_id;</span></span><br><span class="line"><span class="regexp"># chr, strand, gene start and end</span></span><br><span class="line"><span class="regexp"># chr, strand, gene start and end</span></span><br><span class="line"><span class="regexp">if ($cols[2] eq 'mRNA' ) &#123;</span></span><br><span class="line"><span class="regexp">$hash&#123;$gene_id&#125;&#123;chr&#125; = $cols[0];</span></span><br><span class="line"><span class="regexp">$hash&#123;$gene_id&#125;&#123;strand&#125; = $cols[6];</span></span><br><span class="line"><span class="regexp">$hash&#123;$gene_id&#125;&#123;start&#125; = $cols[3];</span></span><br><span class="line"><span class="regexp">$hash&#123;$gene_id&#125;&#123;end&#125; = $cols[4];</span></span><br><span class="line"><span class="regexp">$hash&#123;$gene_id&#125;&#123;ex_num&#125; = 0;</span></span><br><span class="line"><span class="regexp">$hash&#123;$gene_id&#125;&#123;pep_id&#125; = $pep_id;</span></span><br><span class="line"><span class="regexp">$hash&#123;$gene_id&#125;&#123;trans_id&#125; = $trans_id;</span></span><br><span class="line"><span class="regexp">$hash&#123;$gene_id&#125;&#123;exon&#125; = new Set::IntSpan;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"># exon number</span></span><br><span class="line"><span class="regexp">if ($cols[2] eq 'exon' &amp;&amp; exists $hash&#123;$gene_id&#125;) &#123;</span></span><br><span class="line"><span class="regexp">my ( $start, $end ) = @cols[3, 4];</span></span><br><span class="line"><span class="regexp">$hash&#123;$gene_id&#125;&#123;exon&#125;-&gt;U("$start-$end");</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp">print "done\n";</span></span><br><span class="line"><span class="regexp">print "Extract introns from $ref\t";</span></span><br><span class="line"><span class="regexp"># get the exon sequence</span></span><br><span class="line"><span class="regexp">foreach my $gene_id (sort keys %hash) &#123;</span></span><br><span class="line"><span class="regexp">my $chr = $hash&#123;$gene_id&#125;&#123;chr&#125;;</span></span><br><span class="line"><span class="regexp">my $strand = $hash&#123;$gene_id&#125;&#123;strand&#125;;</span></span><br><span class="line"><span class="regexp">my $start = $hash&#123;$gene_id&#125;&#123;start&#125;;</span></span><br><span class="line"><span class="regexp">my $end   = $hash&#123;$gene_id&#125;&#123;end&#125;;</span></span><br><span class="line"><span class="regexp">my $pep_id = $hash&#123;$gene_id&#125;&#123;pep_id&#125;;</span></span><br><span class="line"><span class="regexp">my $trans_id = $hash&#123;$gene_id&#125;&#123;trans_id&#125;;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">my $all_set = new Set::IntSpan "$start-$end";</span></span><br><span class="line"><span class="regexp">my $exon_set = $hash&#123;$gene_id&#125;&#123;exon&#125;;</span></span><br><span class="line"><span class="regexp">my $intron_set = diff $all_set $exon_set;</span></span><br><span class="line"><span class="regexp">my @array_intron = sets $intron_set;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">my $seq;</span></span><br><span class="line"><span class="regexp"># upstream and downstream, 0 bp</span></span><br><span class="line"><span class="regexp">#my $min = min $set;</span></span><br><span class="line"><span class="regexp">#$min = $min - 1;</span></span><br><span class="line"><span class="regexp">#my $s_min = 1 + $min - 0;</span></span><br><span class="line"><span class="regexp">#my $max = max $set;</span></span><br><span class="line"><span class="regexp">#$max = $max + 1;</span></span><br><span class="line"><span class="regexp">#my $e_max = $max - 1 + 0;</span></span><br><span class="line"><span class="regexp">#my $upstream = $ref_db-&gt;seq($chr, $s_min =&gt; $min);</span></span><br><span class="line"><span class="regexp">#my $downstream = $ref_db-&gt;seq($chr, $max =&gt; $e_max);</span></span><br><span class="line"><span class="regexp">#$downstream = $upstream = "";</span></span><br><span class="line"><span class="regexp">#   $seq = "$upstream";</span></span><br><span class="line"><span class="regexp"># exon region</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">@array_intron = reverse @array_intron if $strand eq '-';</span></span><br><span class="line"><span class="regexp">foreach my $intron (@array_intron) &#123;</span></span><br><span class="line"><span class="regexp">my ($start, $end) = (split /</span>\-<span class="regexp">/, $intron);</span></span><br><span class="line"><span class="regexp">$end = $start unless defined $end;</span></span><br><span class="line"><span class="regexp">my $seq = $ref_db-&gt;seq($chr, $start =&gt; $end);</span></span><br><span class="line"><span class="regexp">$seq = reverse_complement($seq) if $strand eq '-';</span></span><br><span class="line"><span class="regexp">my $new_strand;</span></span><br><span class="line"><span class="regexp">if ($strand eq '-') &#123;</span></span><br><span class="line"><span class="regexp">$new_strand = "minus_strand";</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp">elsif ($strand eq '+') &#123;</span></span><br><span class="line"><span class="regexp">$new_strand = "positive_strand";</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp">else &#123;</span></span><br><span class="line"><span class="regexp">print "Warning $gene_id $strand not defined\n";</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp">print OUT "&gt;Gene_ID:$gene_id#Transcript_ID:$trans_id#Protein_ID:$pep_id#intron#$new_strand#$chr\:$start-$end\n$seq\n";</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp">close OUT;</span></span><br><span class="line"><span class="regexp">print "done\n";</span></span><br><span class="line"><span class="regexp">### sub routines ###</span></span><br><span class="line"><span class="regexp">sub reverse_complement &#123;</span></span><br><span class="line"><span class="regexp">        my $dna = shift;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp"># reverse the DNA sequence</span></span><br><span class="line"><span class="regexp">        my $revcomp = reverse($dna);</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp"># complement the reversed DNA sequence</span></span><br><span class="line"><span class="regexp">        $revcomp =~ tr/</span>ACGTacgt/TGCAtgca/;</span><br><span class="line">        <span class="keyword">return</span> $revcomp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>cds也就比较好提了。毕竟各个id都有了</p>]]></content>
      
      
      
        <tags>
            
            <tag> Ensembl </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/2020/05/22/%E8%AF%A6%E7%BB%86%E6%B3%A8%E9%87%8A%E7%9A%84OrthoFinder/"/>
      <url>/2020/05/22/%E8%AF%A6%E7%BB%86%E6%B3%A8%E9%87%8A%E7%9A%84OrthoFinder/</url>
      
        <content type="html"><![CDATA[<h1 id="ortholog-identification"><a href="#ortholog-identification" class="headerlink" title="ortholog identification"></a>ortholog identification</h1><h2 id="filter-Prunella-strophiata"><a href="#filter-Prunella-strophiata" class="headerlink" title="filter Prunella strophiata"></a>filter Prunella strophiata</h2><h3 id="in-order-to-keep-gene-id-format-consistantly-use-awk-and-python-scripts-and-gffread-and-transeq-for-refomating"><a href="#in-order-to-keep-gene-id-format-consistantly-use-awk-and-python-scripts-and-gffread-and-transeq-for-refomating" class="headerlink" title="in order to keep gene id format consistantly, use awk and python scripts and gffread and transeq for refomating"></a>in order to keep gene id format consistantly, use awk and python scripts and gffread and transeq for refomating</h3><h3 id="1-gene-and-mRNA-will-cause-redirect-error-remove-first"><a href="#1-gene-and-mRNA-will-cause-redirect-error-remove-first" class="headerlink" title="1. gene and mRNA will cause redirect error, remove first"></a>1. gene and mRNA will cause redirect error, remove first</h3><h4 id="因为原始的Prunella-strophiata的注释文件中，gene-id-的格式如下"><a href="#因为原始的Prunella-strophiata的注释文件中，gene-id-的格式如下" class="headerlink" title="因为原始的Prunella strophiata的注释文件中，gene id 的格式如下"></a>因为原始的Prunella strophiata的注释文件中，gene id 的格式如下</h4><blockquote><p>contig1000      EVM     gene    23218   23970   .       +       .       ID=evm.TU.contig1000.2;Name=EVM%20prediction%20contig1000.2<br>contig1000      EVM     mRNA    23218   23970   .       +       .       ID=evm.model.contig1000.2;Parent=evm.TU.contig1000.2;Name=EVM%20predicti<br>on%20contig1000.2<br>contig1000      EVM     exon    23218   23970   .       +       .       ID=evm.model.contig1000.2.exon1;Parent=evm.model.contig1000.2<br>contig1000      EVM     CDS     23218   23970   .       +       0       ID=cds.evm.model.contig1000.2;Parent=evm.model.contig1000.2</p></blockquote><h4 id="但是为了在最终结果的-Orthogroups-中能清楚的看出来group中包含哪些物种，所以把注释文件中的-gene-id-替换为物种名加序号的格式"><a href="#但是为了在最终结果的-Orthogroups-中能清楚的看出来group中包含哪些物种，所以把注释文件中的-gene-id-替换为物种名加序号的格式" class="headerlink" title="但是为了在最终结果的 Orthogroups 中能清楚的看出来group中包含哪些物种，所以把注释文件中的 gene id 替换为物种名加序号的格式"></a>但是为了在最终结果的 Orthogroups 中能清楚的看出来group中包含哪些物种，所以把注释文件中的 gene id 替换为物种名加序号的格式</h4><h4 id="如Prunella-strophiata中的基因，需要修改命名为-Prunella-strophiata-best-assembled-1-Prunella-strophiata-best-assembled-2"><a href="#如Prunella-strophiata中的基因，需要修改命名为-Prunella-strophiata-best-assembled-1-Prunella-strophiata-best-assembled-2" class="headerlink" title="如Prunella strophiata中的基因，需要修改命名为 Prunella_strophiata_best_assembled_1, Prunella_strophiata_best_assembled_2"></a>如Prunella strophiata中的基因，需要修改命名为 Prunella_strophiata_best_assembled_1, Prunella_strophiata_best_assembled_2</h4><h4 id="因为gene和的信息内容是一致的，使用下面的命令先去除包含mrna的行"><a href="#因为gene和的信息内容是一致的，使用下面的命令先去除包含mrna的行" class="headerlink" title="因为gene和的信息内容是一致的，使用下面的命令先去除包含mrna的行"></a>因为gene和的信息内容是一致的，使用下面的命令先去除包含mrna的行</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">awk '&#123;if($3 != "mRNA")print $0&#125;' Prunella_strophiata_assemble.evm.gff3  &gt; Prunella_strophiata_assemble.remove_mRNA.gff3</span><br></pre></td></tr></table></figure><h3 id="2-replace-gene-id"><a href="#2-replace-gene-id" class="headerlink" title="2. replace gene id"></a>2. replace gene id</h3><h4 id="使用-reformat-py2-脚本去替换原始的gff3文件中的-gene-id"><a href="#使用-reformat-py2-脚本去替换原始的gff3文件中的-gene-id" class="headerlink" title="使用 reformat.py2 脚本去替换原始的gff3文件中的 gene id"></a>使用 reformat.py2 脚本去替换原始的gff3文件中的 gene id</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python reformat.py2 Prunella_strophiata_assemble.remove_mRNA.gff3 &gt;  Prunella_strophiata.best_assembled.gff3</span><br></pre></td></tr></table></figure><h4 id="修改后的注释文件如下-差别只在最后一列，这样输出还有一个目的是为了gffread软件的读取"><a href="#修改后的注释文件如下-差别只在最后一列，这样输出还有一个目的是为了gffread软件的读取" class="headerlink" title="修改后的注释文件如下,差别只在最后一列，这样输出还有一个目的是为了gffread软件的读取"></a>修改后的注释文件如下,差别只在最后一列，这样输出还有一个目的是为了gffread软件的读取</h4><blockquote><p>contig1000      EVM     gene    23218   23970   .       +       .       ID=Prunella_strophita_best_assembled_1<br>contig1000      EVM     exon    23218   23970   .       +       .       Parent=Prunella_strophita_best_assembled_1<br>contig1000      EVM     CDS     23218   23970   .       +       0       Parent=Prunella_strophita_best_assembled_1</p></blockquote><h3 id="3-extract-cds-sequence"><a href="#3-extract-cds-sequence" class="headerlink" title="3. extract cds sequence"></a>3. extract cds sequence</h3><h4 id="使用-gffread-软件，输入修改过的gff文件和基因组序列，提取出其中的cds序列，gffread在提取的时候会识别第七列的正负链信息取反向互补"><a href="#使用-gffread-软件，输入修改过的gff文件和基因组序列，提取出其中的cds序列，gffread在提取的时候会识别第七列的正负链信息取反向互补" class="headerlink" title="使用 gffread 软件，输入修改过的gff文件和基因组序列，提取出其中的cds序列，gffread在提取的时候会识别第七列的正负链信息取反向互补"></a>使用 gffread 软件，输入修改过的gff文件和基因组序列，提取出其中的cds序列，gffread在提取的时候会识别第七列的正负链信息取反向互补</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gffread Prunella_strophiata.best_assembled.gff3 -g Prunella_strophiata_assemble.fa -x Prunella_strophiata.best_assembled.cds.fa</span><br></pre></td></tr></table></figure><h3 id="4-cds2protein"><a href="#4-cds2protein" class="headerlink" title="4. cds2protein"></a>4. cds2protein</h3><h4 id="使用EMBOSS数据包中的-transeq-程序对上一步提取出来的cds序列进行翻译"><a href="#使用EMBOSS数据包中的-transeq-程序对上一步提取出来的cds序列进行翻译" class="headerlink" title="使用EMBOSS数据包中的 transeq 程序对上一步提取出来的cds序列进行翻译"></a>使用EMBOSS数据包中的 transeq 程序对上一步提取出来的cds序列进行翻译</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">transeq -sequence Prunella_strophiata.best_assembled.cds.fa -outseq Prunella_strophaita.best_assembled.pep.fa</span><br></pre></td></tr></table></figure><h3 id="5-remove-the-info-added-by-transeq"><a href="#5-remove-the-info-added-by-transeq" class="headerlink" title="5. remove the info added by transeq"></a>5. remove the info added by transeq</h3><h4 id="因为EMBOSS-中的-transeq-软件会对-gene-id-进行修改，将Prunella-strophiata-best-assembled-1改为了Prunella-strophiata-best-assembled-1-1"><a href="#因为EMBOSS-中的-transeq-软件会对-gene-id-进行修改，将Prunella-strophiata-best-assembled-1改为了Prunella-strophiata-best-assembled-1-1" class="headerlink" title="因为EMBOSS 中的 transeq 软件会对 gene id 进行修改，将Prunella_strophiata_best_assembled_1改为了Prunella_strophiata_best_assembled_1_1"></a>因为EMBOSS 中的 transeq 软件会对 gene id 进行修改，将Prunella_strophiata_best_assembled_1改为了Prunella_strophiata_best_assembled_1_1</h4><h4 id="所以使用sed命令去除掉gene-id末尾的-1-同时就得到了最终的蛋白文件"><a href="#所以使用sed命令去除掉gene-id末尾的-1-同时就得到了最终的蛋白文件" class="headerlink" title="所以使用sed命令去除掉gene id末尾的_1 同时就得到了最终的蛋白文件"></a>所以使用sed命令去除掉gene id末尾的_1 同时就得到了最终的蛋白文件</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -i 's/\(.*\)_1\(.*\)/\1\2/g' Prunella_strophiata.best_assembled.pep.fa</span><br></pre></td></tr></table></figure><h2 id="filter-Du’s-file"><a href="#filter-Du’s-file" class="headerlink" title="filter Du’s file"></a>filter Du’s file</h2><h4 id="杜老师的16个岩鹨基因组的原始注释文件中即没有包含cds的信息，也没有包含gene-id的信息"><a href="#杜老师的16个岩鹨基因组的原始注释文件中即没有包含cds的信息，也没有包含gene-id的信息" class="headerlink" title="杜老师的16个岩鹨基因组的原始注释文件中即没有包含cds的信息，也没有包含gene id的信息"></a>杜老师的16个岩鹨基因组的原始注释文件中即没有包含cds的信息，也没有包含gene id的信息</h4><h4 id="原始注释如下"><a href="#原始注释如下" class="headerlink" title="原始注释如下"></a>原始注释如下</h4><blockquote><p>C26941125       exonerate:protein2genome:local  gene    1346    2626    1492    -       .       gene_id 1 ; sequence evm.model.contig1003.2 ; gene_orientation + ; identity 99.30 ; similarity 99.30<br>C26941125       exonerate:protein2genome:local  exon    2490    2626    .       -       .       insertions 0 ; deletions 0 ; identity 95.56 ; similarity 95.56<br>C26941125       exonerate:protein2genome:local  intron  2378    2489    .       -       .       intron_id 1<br>C26941125       exonerate:protein2genome:local  exon    2235    2377    .       -       .       insertions 0 ; deletions 1 ; identity 100.00 ; similarity 100.00 ; frameshifts 2<br>C26941125       exonerate:protein2genome:local  intron  2148    2234    .       -       .       intron_id 2<br>C26941125       exonerate:protein2genome:local  exon    2116    2147    .       -       .       insertions 0 ; deletions 0 ; identity 100.00 ; similarity 100.00<br>C26941125       exonerate:protein2genome:local  intron  1897    2115    .       -       .       intron_id 3<br>C26941125       exonerate:protein2genome:local  exon    1346    1896    .       -       .       insertions 0 ; deletions 0 ; identity 100.00 ; similarity 100.00<br>scaffold175008  exonerate:protein2genome:local  gene    1423    2438    1202    +       .       gene_id 1 ; sequence evm.model.contig1003.1 ; gene_orientation + ; identity 89.45 ; similarity 89.84<br>scaffold175008  exonerate:protein2genome:local  exon    1423    2014    .       +       .       insertions 0 ; deletions 0 ; identity 86.80 ; similarity 86.80<br>scaffold175008  exonerate:protein2genome:local  intron  2015    2259    .       +       .       intron_id 1<br>scaffold175008  exonerate:protein2genome:local  exon    2260    2438    .       +       .       insertions 0 ; deletions 0 ; identity 98.31 ; similarity 100.00</p></blockquote><h4 id="所以首先要做的是先添加gene-id的信息，然后再根据注释文件中的exon的位置信息，提取出所有转录本"><a href="#所以首先要做的是先添加gene-id的信息，然后再根据注释文件中的exon的位置信息，提取出所有转录本" class="headerlink" title="所以首先要做的是先添加gene id的信息，然后再根据注释文件中的exon的位置信息，提取出所有转录本"></a>所以首先要做的是先添加gene id的信息，然后再根据注释文件中的exon的位置信息，提取出所有转录本</h4><h4 id="再用transdecoder软件，对所有的转录本去预测ORF，得到最长ORF"><a href="#再用transdecoder软件，对所有的转录本去预测ORF，得到最长ORF" class="headerlink" title="再用transdecoder软件，对所有的转录本去预测ORF，得到最长ORF"></a>再用transdecoder软件，对所有的转录本去预测ORF，得到最长ORF</h4><h3 id="1-get-cdna-file-and-transdecoder-commands"><a href="#1-get-cdna-file-and-transdecoder-commands" class="headerlink" title="1. get cdna file and transdecoder commands"></a>1. get cdna file and transdecoder commands</h3><h3 id="This-step-aims-at-reformat-16-genome-annotation-of-Du-by-adding-gene-id"><a href="#This-step-aims-at-reformat-16-genome-annotation-of-Du-by-adding-gene-id" class="headerlink" title="This step aims at reformat 16 genome annotation of Du by adding gene id"></a>This step aims at reformat 16 genome annotation of Du by adding gene id</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ls *gff3 | sed 's/.gff3//g' | while read line;</span><br><span class="line">do python reformat.py $&#123;line&#125;.gff3  &gt; $&#123;line&#125;.refomat.gff3;</span><br><span class="line">gffread $&#123;line&#125;.refomat.gff3 -g $&#123;line&#125;.fa  -w $&#123;line&#125;.cdna.fa;</span><br><span class="line">echo "TransDecoder.LongOrfs -t "$&#123;line&#125;".cdna.fa &amp;" &gt;&gt; run_TransDecoder.LongOrfs.sh</span><br><span class="line">echo "TransDecoder.Predict -t "$&#123;line&#125;".cdna.fa &amp;" &gt;&gt; run_TransDecoder.Predict.sh</span><br><span class="line">done</span><br></pre></td></tr></table></figure><h4 id="在上面的循环中，执行了4个循环的命令，在下面分四个说明"><a href="#在上面的循环中，执行了4个循环的命令，在下面分四个说明" class="headerlink" title="在上面的循环中，执行了4个循环的命令，在下面分四个说明"></a>在上面的循环中，执行了4个循环的命令，在下面分四个说明</h4><h4 id="1-使用reformat-py脚本修改gene-id的格式"><a href="#1-使用reformat-py脚本修改gene-id的格式" class="headerlink" title="1. 使用reformat.py脚本修改gene id的格式"></a>1. 使用reformat.py脚本修改gene id的格式</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python reformat.py $&#123;line&#125;.gff3  &gt; $&#123;line&#125;.refomat.gff3;</span><br></pre></td></tr></table></figure><h4 id="reformat-py-脚本如下，各部分代表的意义与上面的-reformat-py2-类似"><a href="#reformat-py-脚本如下，各部分代表的意义与上面的-reformat-py2-类似" class="headerlink" title="reformat.py 脚本如下，各部分代表的意义与上面的 reformat.py2 类似"></a>reformat.py 脚本如下，各部分代表的意义与上面的 reformat.py2 类似</h4><h4 id="修改后的gff文件格式如下，差别只在最后一列"><a href="#修改后的gff文件格式如下，差别只在最后一列" class="headerlink" title="修改后的gff文件格式如下，差别只在最后一列"></a>修改后的gff文件格式如下，差别只在最后一列</h4><blockquote><p>C26941125       exonerate:protein2genome:local  gene    1346    2626    1492    -       .       ID=Prunella_atrogularis_141230_1<br>C26941125       exonerate:protein2genome:local  exon    2490    2626    .       -       .       Parent=Prunella_atrogularis_141230_1<br>C26941125       exonerate:protein2genome:local  intron  2378    2489    .       -       .       Parent=Prunella_atrogularis_141230_1<br>C26941125       exonerate:protein2genome:local  exon    2235    2377    .       -       .       Parent=Prunella_atrogularis_141230_1<br>C26941125       exonerate:protein2genome:local  intron  2148    2234    .       -       .       Parent=Prunella_atrogularis_141230_1<br>C26941125       exonerate:protein2genome:local  exon    2116    2147    .       -       .       Parent=Prunella_atrogularis_141230_1<br>C26941125       exonerate:protein2genome:local  intron  1897    2115    .       -       .       Parent=Prunella_atrogularis_141230_1<br>C26941125       exonerate:protein2genome:local  exon    1346    1896    .       -       .       Parent=Prunella_atrogularis_141230_1</p></blockquote><h4 id="2-使用gffread提取exons组成的cdna序列"><a href="#2-使用gffread提取exons组成的cdna序列" class="headerlink" title="2.使用gffread提取exons组成的cdna序列"></a>2.使用gffread提取exons组成的cdna序列</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gffread $&#123;line&#125;.refomat.gff3 -g $&#123;line&#125;.fa  -w $&#123;line&#125;.cdna.fa;</span><br></pre></td></tr></table></figure><h4 id="3-与-4-的命令的目的就是生成TransDecoder软件所诉需要的命令行，即软件名字-cdna序列名字"><a href="#3-与-4-的命令的目的就是生成TransDecoder软件所诉需要的命令行，即软件名字-cdna序列名字" class="headerlink" title="3. 与 4. 的命令的目的就是生成TransDecoder软件所诉需要的命令行，即软件名字+cdna序列名字"></a>3. 与 4. 的命令的目的就是生成TransDecoder软件所诉需要的命令行，即软件名字+cdna序列名字</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;TransDecoder.LongOrfs -t &quot;$&#123;line&#125;&quot;.cdna.fa &amp;&quot; &gt;&gt; run_TransDecoder.LongOrfs.sh</span><br><span class="line">echo &quot;TransDecoder.Predict -t &quot;$&#123;line&#125;&quot;.cdna.fa &amp;&quot; &gt;&gt; run_TransDecoder.Predict.sh</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">### 2. use TransDecoder to predict ORF region</span><br><span class="line">#### 运行上一步保存的命令行，TransDecoder使用cdna序列预测cds序列</span><br><span class="line">nohup sh run_TransDecoder.LongOrfs.sh &gt; run_TransDecoder.LongOrfs.log</span><br><span class="line">nohup sh run_TransDecoder.Predict.sh &gt; run_TransDecoder.Predict.log</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">### 3. generate longest transcripts and remove duplicated sequence in pep file</span><br><span class="line">```shell</span><br><span class="line">ls *.transdecoder.pep | while read line</span><br><span class="line">do</span><br><span class="line">/usr/bin/perl retrive_longest_splicing_variant.pl $&#123;line&#125; longest.$&#123;line&#125;</span><br><span class="line">/usr/bin/perl rm_dup_fasta.pl longest.$&#123;line&#125; temp.longest.$&#123;line&#125;</span><br><span class="line">awk -F &apos;#&apos; &apos;&#123;if($0 ~&quot;^&gt;&quot;)&#123;print $1&#125;else&#123;print $0&#125;&#125;&apos; temp.$&#123;line&#125; &gt;   final.$&#123;line&#125;</span><br><span class="line">done</span><br></pre></td></tr></table></figure><h4 id="在上面的循环中，执行了3个循环的命令，在下面分三个说明"><a href="#在上面的循环中，执行了3个循环的命令，在下面分三个说明" class="headerlink" title="在上面的循环中，执行了3个循环的命令，在下面分三个说明"></a>在上面的循环中，执行了3个循环的命令，在下面分三个说明</h4><h4 id="1-对TransDecoder的结果中的蛋白文件进行提取最长转录本"><a href="#1-对TransDecoder的结果中的蛋白文件进行提取最长转录本" class="headerlink" title="1. 对TransDecoder的结果中的蛋白文件进行提取最长转录本"></a>1. 对TransDecoder的结果中的蛋白文件进行提取最长转录本</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/bin/perl retrive_longest_splicing_variant.pl $&#123;line&#125; longest.$&#123;line&#125;</span><br></pre></td></tr></table></figure><h4 id="2-对TransDecoder的结果中的蛋白文件进行去重复"><a href="#2-对TransDecoder的结果中的蛋白文件进行去重复" class="headerlink" title="2. 对TransDecoder的结果中的蛋白文件进行去重复"></a>2. 对TransDecoder的结果中的蛋白文件进行去重复</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/bin/perl rm_dup_fasta.pl longest.$&#123;line&#125; temp.longest.$&#123;line&#125;</span><br></pre></td></tr></table></figure><h4 id="3-对蛋白文件的gene-id进行修改，将冗余的部分去掉"><a href="#3-对蛋白文件的gene-id进行修改，将冗余的部分去掉" class="headerlink" title="3. 对蛋白文件的gene id进行修改，将冗余的部分去掉"></a>3. 对蛋白文件的gene id进行修改，将冗余的部分去掉</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">awk -F '#' '&#123;if($0 ~"^&gt;")&#123;print $1&#125;else&#123;print $0&#125;&#125;' temp.$&#123;line&#125; &gt;   final.$&#123;line&#125;</span><br></pre></td></tr></table></figure><h2 id="filter-BGI-file"><a href="#filter-BGI-file" class="headerlink" title="filter BGI file"></a>filter BGI file</h2><h3 id="因为BGI的gff注释文件中，已经有了原始的基因名，所以先提取出原始的基因名，再添加一个对应的基因名，再将原始的注释文件替换"><a href="#因为BGI的gff注释文件中，已经有了原始的基因名，所以先提取出原始的基因名，再添加一个对应的基因名，再将原始的注释文件替换" class="headerlink" title="因为BGI的gff注释文件中，已经有了原始的基因名，所以先提取出原始的基因名，再添加一个对应的基因名，再将原始的注释文件替换"></a>因为BGI的gff注释文件中，已经有了原始的基因名，所以先提取出原始的基因名，再添加一个对应的基因名，再将原始的注释文件替换</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ls *BGI*  | while read line</span><br><span class="line">do</span><br><span class="line">grep '&gt;' $&#123;line&#125;.pep | sed 's/&gt;//g' &gt; $&#123;line&#125;.modify.seqid</span><br><span class="line">awk '&#123;if($3 =="gene")&#123;a=index($0,"~~");b=index($0,";");print substr($0,a+2,b-a-2)&#125;&#125;' &gt; $&#123;line&#125;.origin.seqid</span><br><span class="line">paste -d '\t' $&#123;line&#125;.origin.seqid $&#123;line&#125;.modify.seqid &gt; $&#123;line&#125;_coress.seqid</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">python  replace_gff_gene_id.py Prunella_fulvescens_BGI_coress.seqid Prunella_fulvescens.homolog.gff &gt; Prunella_fulvescens.modify.gff3</span><br><span class="line">python  replace_gff_gene_id.py Prunella_himalayana_BGI_coress.seqid Prunella_himalayana.homolog.gff &gt;  Prunella_himalayana.modify.gff3</span><br></pre></td></tr></table></figure><h2 id="download-Gallus-genome-from-Ensembl-database-and-remove-reduant-transcripts"><a href="#download-Gallus-genome-from-Ensembl-database-and-remove-reduant-transcripts" class="headerlink" title="download Gallus genome from Ensembl database and remove reduant transcripts"></a>download Gallus genome from Ensembl database and remove reduant transcripts</h2><h3 id="1-下载人和鸡的蛋白序列"><a href="#1-下载人和鸡的蛋白序列" class="headerlink" title="1. 下载人和鸡的蛋白序列"></a>1. 下载人和鸡的蛋白序列</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">wget ftp://ftp.ensembl.org/pub/release-100/fasta/gallus_gallus/pep/Gallus_gallus.GRCg6a.pep.all.fa.gz</span><br><span class="line">gunzip Gallus_gallus.GRCg6a.pep.all.fa.gz</span><br><span class="line"></span><br><span class="line">wget ftp://ftp.ensembl.org/pub/release-100/fasta/homo_sapiens/pep/Homo_sapiens.GRCh38.pep.all.fa.gz</span><br><span class="line">gunzip Homo_sapiens.GRCh38.pep.all.fa.gz</span><br></pre></td></tr></table></figure><h3 id="2-过滤掉同一gene-id中短的mrna序列"><a href="#2-过滤掉同一gene-id中短的mrna序列" class="headerlink" title="2. 过滤掉同一gene id中短的mrna序列"></a>2. 过滤掉同一gene id中短的mrna序列</h3><h3 id="retrive-longest-transcripts-from-above-protein-fasta-file"><a href="#retrive-longest-transcripts-from-above-protein-fasta-file" class="headerlink" title="retrive longest transcripts from above protein fasta file"></a>retrive longest transcripts from above protein fasta file</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ls *fa | while read line</span><br><span class="line">do</span><br><span class="line">python ~/software/OrthoFinder/tools/primary_transcript.py $&#123;line&#125;</span><br><span class="line">done</span><br></pre></td></tr></table></figure><h1 id="CORE-PROGRAM"><a href="#CORE-PROGRAM" class="headerlink" title="CORE PROGRAM"></a>CORE PROGRAM</h1><h2 id="run-OrthoFinder-and-get-the-Orthogroups"><a href="#run-OrthoFinder-and-get-the-Orthogroups" class="headerlink" title="run OrthoFinder and get the Orthogroups"></a>run OrthoFinder and get the Orthogroups</h2><h3 id="将上述所有蛋白序列文件作为输入去预测Orthogroups"><a href="#将上述所有蛋白序列文件作为输入去预测Orthogroups" class="headerlink" title="将上述所有蛋白序列文件作为输入去预测Orthogroups"></a>将上述所有蛋白序列文件作为输入去预测Orthogroups</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~/software/OrthoFinder/orthofinder -f pep -S diamond</span><br></pre></td></tr></table></figure><h2 id="published-info"><a href="#published-info" class="headerlink" title="published info"></a>published info</h2><h3 id="OrthoFinder发表在GB的文章，引用次数一年内已经有69次"><a href="#OrthoFinder发表在GB的文章，引用次数一年内已经有69次" class="headerlink" title="OrthoFinder发表在GB的文章，引用次数一年内已经有69次"></a>OrthoFinder发表在GB的文章，引用次数一年内已经有69次</h3><blockquote><p>Emms D.M. &amp; Kelly S. OrthoFinder: phylogenetic orthology inference for comparative<br>genomics (2019), Genome Biology 20:238</p></blockquote><h2 id="use-longest-transcripts-gene-ids-filter-gff-file-and-get-intron-sequences"><a href="#use-longest-transcripts-gene-ids-filter-gff-file-and-get-intron-sequences" class="headerlink" title="use longest transcripts gene ids filter gff file and get intron sequences"></a>use longest transcripts gene ids filter gff file and get intron sequences</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">less *.seqid |sed 's/seqid//g'| while read line</span><br><span class="line">do cat $&#123;line&#125; | while read row</span><br><span class="line">grep -w $&#123;row&#125; $&#123;line&#125;.gff3</span><br><span class="line">done &gt; $&#123;line&#125;.reformat.gff3</span><br><span class="line">/usr/bin/perl extract_intron_from_gff3_based_on_exon.pl $&#123;line&#125;.fa $&#123;line&#125;.reformat.gff3 $&#123;line&#125;.intron.fa</span><br><span class="line">done</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>PAML and MCScanX-transposed</title>
      <link href="/2020/05/15/PAML/"/>
      <url>/2020/05/15/PAML/</url>
      
        <content type="html"><![CDATA[<p>通常师姐她们做的PAML选择压力检验 是为了分析一个基因，或者多个基因串联，构建的系统发育树中，收选择的物种是谁，在不同的物种当中是否具有不同的选择方向。</p><p>意思也就是在这篇文章中Molecular Evolution of the TET Gene Family in Mammals，TET有三个直系同源基因，然后把这三个基因对应的20个物种分别建树，先用sites model中的模型M0（假设比对中所有密码子位点都为一个ω）看每个基因的进化速率</p><p>Selection pressure causes differentiation of the SPL gene family in the Juglandaceae</p><p>这一篇用branch sites model的</p><p>branch sites model 是相对于集合了branch model和sites model的，因为他允许了在model中sites的omega值不同的同时也允许了branch的omega也不相同。即反馈到ctl文件中就是 Model =2 Nsite =2，代表了branch model中的foreground ： background 和Sites Model中的M2 model W0 = 0 ;W1 = 1; W2 &gt; 1</p><p>对于ModelA和ModelA null 的比较，Null 在检测中强制fix omega =1，就代表着backgroud的sites均处于negative selection,.foreground中的sites均处于neutral selection 而在modelA中 foreground 的sites全部处于positive selection </p><p>但是但是但是 PAML这个软件的目的就是检测正选择，而当输入的序列过于相似的时候，很少量的正选择的位点就很难反馈到模型上，十分容易造成正选择模型和凌假设模型差异不显著</p><p>NOTE:NG86 assumes no transition-transversion rate difference and no codon usage bias.</p><p>####1.WGD</p><p>Whole-genome duplications (WGDs) have occurred in thelineages of plants [1], animals [2,3] and fungi [4,5], with possibleconsequences including evolution of novel or modified genefunctions [6,7,8,9], and/or provision of ‘‘buffer capacity’’ [10,11]or  genetic  redundancy  that  increases  genetic  robustness[12,13,14,15,16,17].  Genome  duplication  may  also  increaseopportunities for nonreciprocal recombination [18,19,20], permit-ting or causing duplicated genes to evolve in concert for a period oftime. Rapid DNA loss and restructuring of low-copy DNA[21,22,23,24], retrotransposon activation [25,26,27] and epigeneticchanges [28,29,30,31,32,33] following WGD may further providematerials for evolutionary change</p><p>全基因组重复，基因组复制也可能增加不可逆重组的机会[18，19，20]，允许或导致复制的基因在一段时间内协同进化</p><p>####2.Tandem and Proximal</p><p>Tandem duplicates  are  consecutive  in  the  genome  while  proximal duplicates are near one another but separated by a few gene</p><p>These two gene duplication modes are presumed to arise throughunequal crossing over [36] or localized transposon activitie</p><p>####3.Dispersed</p><p>Dispersed duplicates are neither adjacent to each other in thegenome nor within homeologous chromosome segments </p><p>####4.Transposed</p><p>DNA  transposons  such  aspackmules  (rice)  [39],  helitrons  (maize)  [40],  and  CACTAelements (sorghum) [27] may relocate duplicated genes or genesegments to new chromosomal positions (referred to as DNA basedtransposed duplication). RNA based transposed duplication, oftenreferred to as retrotransposition, typically creates a single-exonretrocopy from a multi-exon parental gene, by reverse transcrip-tion of a spliced messenger RNA. It is presumed that the retrocopyduplicates only the transcribed sequence of the parental gene,detached from the parental promoter. The new retrogene is oftendeposited in a novel chromosomal environment with new (i.e. non-ancestral) neighboring genes and, having lost its native promoter,is only likely to survive as a functional gene if a new promoter is acquired [41,42]</p><p>NOTE！</p><p>A transposed duplicate pairs must be meet the following criteria: one gene existed in its ancestral locus, and the other was located in a non-ancestral locus (<a href="https://www.frontiersin.org/articles/10.3389/fpls.2018.00161/full#B87" target="_blank" rel="noopener">Wang Y. et al., 2011</a>).</p><p>NOTE！</p><p>If a pair of transposed duplicated genes comprised an ancestral gene with more than two exons and a novel transposed copy without an intron, then this pair was inferred to be derived from RNA-based transposition (retro transposition).</p>]]></content>
      
      
      
        <tags>
            
            <tag> gene duplication </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>KaKs 计算进化速率</title>
      <link href="/2020/05/15/KaKs_calculator/"/>
      <url>/2020/05/15/KaKs_calculator/</url>
      
        <content type="html"><![CDATA[<p>KaKs calculator</p><h1 id="首先这里还需要再运行一次pal2nal-nogap版本的"><a href="#首先这里还需要再运行一次pal2nal-nogap版本的" class="headerlink" title="首先这里还需要再运行一次pal2nal nogap版本的"></a>首先这里还需要再运行一次pal2nal nogap版本的</h1><h1 id="因为paml内设-clean-data-会将序列里的gap去掉"><a href="#因为paml内设-clean-data-会将序列里的gap去掉" class="headerlink" title="因为paml内设 clean data  会将序列里的gap去掉"></a>因为paml内设 clean data  会将序列里的gap去掉</h1><h1 id="但是KaKS-calculator他在运行的时候，如果序列碱基不是三的倍数会报错，序列中有gap也会报错"><a href="#但是KaKS-calculator他在运行的时候，如果序列碱基不是三的倍数会报错，序列中有gap也会报错" class="headerlink" title="但是KaKS_calculator他在运行的时候，如果序列碱基不是三的倍数会报错，序列中有gap也会报错"></a>但是KaKS_calculator他在运行的时候，如果序列碱基不是三的倍数会报错，序列中有gap也会报错</h1><h1 id="所以"><a href="#所以" class="headerlink" title="所以"></a>所以</h1><p>perl ~/Downloads/softwares/pal2nal.v14/pal2nal.pl 4fanshu.spl.muscle.pep.fa  4fanshu.spl_id.wid70.cds.fa –nogap &gt; t1</p><h1 id="将clustal格式文件改为AXT格式，即将每一对序列pairwise输出，因为一共有104个序列所以结果就是C-2-5356对"><a href="#将clustal格式文件改为AXT格式，即将每一对序列pairwise输出，因为一共有104个序列所以结果就是C-2-5356对" class="headerlink" title="将clustal格式文件改为AXT格式，即将每一对序列pairwise输出，因为一共有104个序列所以结果就是C 2  5356对"></a>将clustal格式文件改为AXT格式，即将每一对序列pairwise输出，因为一共有104个序列所以结果就是C 2  5356对</h1><pre><code>104</code></pre><p>AXTConvertor t1 t2 </p><h1 id="这里用的估算kaks的方法是平均法-Model-Averaging-on-a-set-of-candidate-models，在一篇frontiersin和BMC-genomics里发现都是这个方法，"><a href="#这里用的估算kaks的方法是平均法-Model-Averaging-on-a-set-of-candidate-models，在一篇frontiersin和BMC-genomics里发现都是这个方法，" class="headerlink" title="这里用的估算kaks的方法是平均法 Model Averaging on a set of candidate models，在一篇frontiersin和BMC genomics里发现都是这个方法，"></a>这里用的估算kaks的方法是平均法 Model Averaging on a set of candidate models，在一篇frontiersin和BMC genomics里发现都是这个方法，</h1><h1 id="但是在苹果的那个里面他用的是ML的方法，ml方法速度很快很快，同时omega值比MA方法的更为发散，但是在这两种方法的结果当中，都没有找到正选择的基因对"><a href="#但是在苹果的那个里面他用的是ML的方法，ml方法速度很快很快，同时omega值比MA方法的更为发散，但是在这两种方法的结果当中，都没有找到正选择的基因对" class="headerlink" title="但是在苹果的那个里面他用的是ML的方法，ml方法速度很快很快，同时omega值比MA方法的更为发散，但是在这两种方法的结果当中，都没有找到正选择的基因对"></a>但是在苹果的那个里面他用的是ML的方法，ml方法速度很快很快，同时omega值比MA方法的更为发散，但是在这两种方法的结果当中，都没有找到正选择的基因对</h1><p>KaKS_calculator -i t2 -o t3 -m MA<br>#</p><h1 id="整理过程-⬇️"><a href="#整理过程-⬇️" class="headerlink" title="整理过程 ⬇️"></a>整理过程 ⬇️</h1><h1 id="首先提取id-和-Ka-Ks"><a href="#首先提取id-和-Ka-Ks" class="headerlink" title="首先提取id 和 Ka/Ks"></a>首先提取id 和 Ka/Ks</h1><p>awk ‘{print $1,$5}’ t3  &gt; t3_filter</p><h1 id="将id列中的两个id分为两列"><a href="#将id列中的两个id分为两列" class="headerlink" title="将id列中的两个id分为两列"></a>将id列中的两个id分为两列</h1><p>awk -v OFS=’\t’ -F ‘&amp;’ ‘{print $1,$2}’ t3_filter &gt; t3_fltered</p><h1 id="用ggtree提取一下树文件中的-Tips-label-生成8个-tips-label文件"><a href="#用ggtree提取一下树文件中的-Tips-label-生成8个-tips-label文件" class="headerlink" title="用ggtree提取一下树文件中的 Tips label 生成8个 tips label文件"></a>用ggtree提取一下树文件中的 Tips label 生成8个 tips label文件</h1><pre><code>library(ggtree)tree &lt;- read.newick(&quot;4fanshu.spl.muscle.gb.pep.meg.nwk&quot;)tree_label &lt;- tree[[&quot;tip.label&quot;]]clade1 &lt;- tree_label[1:31]clade2 &lt;- tree_label[32:40]clade3 &lt;- tree_label[41:46]clade4 &lt;- tree_label[47:59]clade5 &lt;- tree_label[60:75]clade6 &lt;- tree_label[76:83]clade7 &lt;- tree_label[84:87]clade8 &lt;- tree_label[88:104]write.table(tree_label,file=&quot;t4.label&quot;,            quote = FALSE,row.names = FALSE,col.names = FALSE)for(i  in 1:8){  val_name = paste(&quot;clade&quot;,i,sep = &quot;&quot;)  output_name = paste(&quot;t4.&quot;,val_name,&quot;.label&quot;,sep = &quot;&quot;)  clade_id = eval(parse(text = paste(&quot;em &lt;- rbind(&quot;, val_name, &quot;)&quot;, sep = &quot;&quot;)))  write.table(clade_id,file=output_name,sep = &apos;\n&apos;,              quote = FALSE,row.names = FALSE,col.names = FALSE)}```R_script# 对每一个label文件 都把对应的ka ks文件中的基因对提取出来，并且是两个基因都在的ls *clade* | while read linedopython sort_kaks.py  ${line} t3_filtered &gt; ${line}.t5done#对每一个clade生成对角矩阵</code></pre>]]></content>
      
      
      
        <tags>
            
            <tag> KaKscalculator,R </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>OrthoFinder 寻找同源基因</title>
      <link href="/2020/05/15/OrthoFinde/"/>
      <url>/2020/05/15/OrthoFinde/</url>
      
        <content type="html"><![CDATA[<h1 id="ortholog-identification"><a href="#ortholog-identification" class="headerlink" title="ortholog identification"></a>ortholog identification</h1><h2 id="in-order-to-keep-gene-id-format-consistantly-use-awk-and-python-and-gffread-and-transeq-for-refomating"><a href="#in-order-to-keep-gene-id-format-consistantly-use-awk-and-python-and-gffread-and-transeq-for-refomating" class="headerlink" title="in order to keep gene id format consistantly,use awk and python and gffread and transeq for refomating"></a>in order to keep gene id format consistantly,use awk and python and gffread and transeq for refomating</h2><h3 id="base-pipeline"><a href="#base-pipeline" class="headerlink" title="base pipeline"></a>base pipeline</h3><h3 id="1-gene-and-mRNA-will-cause-redirect-error-remove-first"><a href="#1-gene-and-mRNA-will-cause-redirect-error-remove-first" class="headerlink" title="1. gene and mRNA will cause redirect error, remove first"></a>1. gene and mRNA will cause redirect error, remove first</h3><p>awk ‘{if($3 != “mRNA”)print $0}’ Prunella_strophita_assemble.evm.gff3  &gt; Prunella_strophita_assemble.remove_mRNA.gff3</p><h3 id="2-replace-gene-id"><a href="#2-replace-gene-id" class="headerlink" title="2. replace gene id"></a>2. replace gene id</h3><p>python reformat.py2 Prunella_strophita_assemble.remove_mRNA.gff3 &gt;  Prunella_strophita.best_assembled.gff3</p><h3 id="3-extract-cds-sequence"><a href="#3-extract-cds-sequence" class="headerlink" title="3. extract cds sequence"></a>3. extract cds sequence</h3><p>gffread Prunella_strophita.best_assembled.gff3 -g Prunella_strophita_assemble.fa -x Prunella_strophita.best_assembled.cds.fa</p><h3 id="4-cds2protein"><a href="#4-cds2protein" class="headerlink" title="4. cds2protein"></a>4. cds2protein</h3><p>transeq -sequence Prunella_strophita.best_assembled.cds.fa -outseq Prunella_strophita.best_assembled.pep.fa</p><h3 id="5-remove-the-info-added-by-transeq"><a href="#5-remove-the-info-added-by-transeq" class="headerlink" title="5. remove the info added by transeq"></a>5. remove the info added by transeq</h3><p>sed -i ‘s/(.<em>)_1(.</em>)/\1\2/g’ Prunella_strophita.best_assembled.pep.fa</p><h2 id="shell-pipeline"><a href="#shell-pipeline" class="headerlink" title="shell pipeline"></a>shell pipeline</h2><p>ls *gff3 | sed ‘s/.gff3//g’ | while read line;<br>do python reformat.py ${line}.gff3  &gt; ${line}.refomat.gff3;<br>gffread ${line}.refomat.gff3 -g ${line}.fa  -w ${line}.cdna.fa;<br>echo “TransDecoder.LongOrfs -t “${line}”.cdna.fa &amp;” &gt;&gt; run_TransDecoder.LongOrfs.sh<br>echo “TransDecoder.Predict -t “${line}”.cdna.fa &amp;” &gt;&gt; run_TransDecoder.Predict.sh<br>done</p><h1 id="use-TransDecoder-to-predict-ORF-region"><a href="#use-TransDecoder-to-predict-ORF-region" class="headerlink" title="use TransDecoder to predict ORF region"></a>use TransDecoder to predict ORF region</h1><p>nohup sh run_TransDecoder.LongOrfs.sh &gt; run_TransDecoder.LongOrfs.log<br>nohup sh run_TransDecoder.Predict.sh &gt; run_TransDecoder.Predict.log</p><h1 id="generate-longest-transcripts-and-remove-duplicated-sequence-in-pep-file"><a href="#generate-longest-transcripts-and-remove-duplicated-sequence-in-pep-file" class="headerlink" title="generate longest transcripts and remove duplicated sequence in pep file"></a>generate longest transcripts and remove duplicated sequence in pep file</h1><p>ls *.transdecoder.pep | while read line<br>do<br>/usr/bin/perl retrive_longest_splicing_variant.pl ${line} longest.${line}<br>/usr/bin/perl rm_dup_fasta.pl longest.${line} temp.longest.${line}<br>awk -F ‘#’ ‘{if($0 ~”^&gt;”){print $1}else{print $0}}’ temp.${line} &gt;   final.${line}<br>done </p><h1 id="rename-file"><a href="#rename-file" class="headerlink" title="rename file"></a>rename file</h1><p>rename .cdna.fa.transdecoder.pep .pep.fa <em>.cdna.fa.transdecoder.pep<br>rename final.longest.P P final.longest.Prunella_</em></p><h2 id="download-Gallus-genome-from-Ensembl-database-and-remove-reduant-transcripts"><a href="#download-Gallus-genome-from-Ensembl-database-and-remove-reduant-transcripts" class="headerlink" title="download Gallus genome from Ensembl database and remove reduant transcripts"></a>download Gallus genome from Ensembl database and remove reduant transcripts</h2><p>wget <a href="ftp://ftp.ensembl.org/pub/release-100/fasta/gallus_gallus/pep/Gallus_gallus.GRCg6a.pep.all.fa.gz" target="_blank" rel="noopener">ftp://ftp.ensembl.org/pub/release-100/fasta/gallus_gallus/pep/Gallus_gallus.GRCg6a.pep.all.fa.gz</a><br>gunzip Gallus_gallus.GRCg6a.pep.all.fa.gz</p><p>python ~/software/OrthoFinder/tools/primary_transcript.py Gallus_gallus.GRCg6a.pep.all.fa<br>mv /home/sunhaoyun/data/Prunella_genome/primary_transcripts/Gallus_gallus.GRCg6a.pep.all.fa Gallus.pep.fa</p><h2 id="run-OrthoFinder"><a href="#run-OrthoFinder" class="headerlink" title="run OrthoFinder"></a>run OrthoFinder</h2><p>~/software/OrthoFinder/orthofinder -f pep -S diamond</p><h1 id="analyse-result"><a href="#analyse-result" class="headerlink" title="analyse result"></a>analyse result</h1><h3 id="1-overview-how-many-genes-were-assigned-to-orthogroups"><a href="#1-overview-how-many-genes-were-assigned-to-orthogroups" class="headerlink" title="1. overview how many genes were assigned to orthogroups"></a>1. overview how many genes were assigned to orthogroups</h3><h4 id="PATH"><a href="#PATH" class="headerlink" title="PATH"></a>PATH</h4><p>/home/public/Prunella/Prunella_genome/Sunhaoyun_genome/Prunella_sp19_with_Gallus/Comparative_Genomics_Statistics/Statistics_Overall.tsv</p><h3 id="2-check-the-percentages-on-a-per-species-basis-here"><a href="#2-check-the-percentages-on-a-per-species-basis-here" class="headerlink" title="2. check the percentages on a per species basis here"></a>2. check the percentages on a per species basis here</h3><h4 id="PATH-1"><a href="#PATH-1" class="headerlink" title="PATH"></a>PATH</h4><p>/home/public/Prunella/Prunella_genome/Sunhaoyun_genome/OrthoFinder/Prunella_sp19_with_Gallus/CComparative_Genomics_Statistics/Statistics_PerSpecies.tsv</p><h3 id="3-species-tree"><a href="#3-species-tree" class="headerlink" title="3. species tree"></a>3. species tree</h3><p>####PATH<br>/home/public/Prunella/Prunella_genome/Sunhaoyun_genome/OrthoFinder/Prunella_sp19_with_Gallus/Species_Tree/SpeciesTree_rooted.txt</p><h3 id="NOTE"><a href="#NOTE" class="headerlink" title="NOTE"></a>NOTE</h3><h3 id="This-speceis-tree-may-have-some-error"><a href="#This-speceis-tree-may-have-some-error" class="headerlink" title="This speceis tree may have some error"></a>This speceis tree may have some error</h3><h3 id="If-the-species-tree-is-not-correct-then-this-will-not-impact-the-orthogroup-inference"><a href="#If-the-species-tree-is-not-correct-then-this-will-not-impact-the-orthogroup-inference" class="headerlink" title="If the species tree is not correct then this will not impact the orthogroup inference,"></a>If the species tree is not correct then this will not impact the orthogroup inference,</h3><h3 id="but-it-might-affect-the-orthologue-inference-in-some-of-the-gene-trees-which-have-gene-duplication-events"><a href="#but-it-might-affect-the-orthologue-inference-in-some-of-the-gene-trees-which-have-gene-duplication-events" class="headerlink" title="but it might affect the orthologue inference in some of the gene trees which have gene duplication events."></a>but it might affect the orthologue inference in some of the gene trees which have gene duplication events.</h3><h3 id="4-find-out-Gallus-orthologues-are-in-the-other-speceis"><a href="#4-find-out-Gallus-orthologues-are-in-the-other-speceis" class="headerlink" title="4. find out Gallus orthologues are in  the other speceis"></a>4. find out Gallus orthologues are in  the other speceis</h3><h4 id="such-as-methyltransferase-like-21C-gene-METTL21C-plays-an-important-role-in-chicken-muscle-development"><a href="#such-as-methyltransferase-like-21C-gene-METTL21C-plays-an-important-role-in-chicken-muscle-development" class="headerlink" title="such as methyltransferase-like 21C gene (METTL21C) plays an important role in chicken muscle development"></a>such as methyltransferase-like 21C gene (METTL21C) plays an important role in chicken muscle development</h4><h4 id="GgMETTL21C1-corresponding-gene-id-is-ENSGALG00000001790-6"><a href="#GgMETTL21C1-corresponding-gene-id-is-ENSGALG00000001790-6" class="headerlink" title="GgMETTL21C1 corresponding gene id is ENSGALG00000001790.6"></a>GgMETTL21C1 corresponding gene id is ENSGALG00000001790.6</h4><h4 id="PATH-2"><a href="#PATH-2" class="headerlink" title="PATH"></a>PATH</h4><p>/home/public/Prunella/Prunella_genome/Sunhaoyun_genome/OrthoFinder/Prunella_sp19_with_Gallus/Orthologues/Orthologues_Gallus.pep/</p><p>ls *tsv | while read line; do grep ‘ENSGALG00000001790.6’ ${line}; done</p><h3 id="5-Orthogroups-comparisons-across-a-clade-of-species"><a href="#5-Orthogroups-comparisons-across-a-clade-of-species" class="headerlink" title="5. Orthogroups comparisons across a clade of species"></a>5. Orthogroups comparisons across a clade of species</h3><h4 id="overview-file-PATH"><a href="#overview-file-PATH" class="headerlink" title="overview file PATH"></a>overview file PATH</h4><p>/home/public/Prunella/Prunella_genome/Sunhaoyun_genome/OrthoFinder/Prunella_sp19_with_Gallus/Orthogroups/Orthogroups.tsv</p><h4 id="For-each-orthogroup-there-is-a-FASTA-file-in"><a href="#For-each-orthogroup-there-is-a-FASTA-file-in" class="headerlink" title="For each orthogroup there is a FASTA file in"></a>For each orthogroup there is a FASTA file in</h4><p>/home/public/Prunella/Prunella_genome/Sunhaoyun_genome/OrthoFinder/Prunella_sp19_with_Gallus/Orthogroup_Sequences</p><h4 id="which-contains-the-sequences-for-the-genes-in-that-orthogroup"><a href="#which-contains-the-sequences-for-the-genes-in-that-orthogroup" class="headerlink" title="which contains the sequences for the genes in that orthogroup."></a>which contains the sequences for the genes in that orthogroup.</h4><h2 id="Other-scipts"><a href="#Other-scipts" class="headerlink" title="Other scipts"></a>Other scipts</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># reformat.py</span><br><span class="line">import sys</span><br><span class="line">i=1</span><br><span class="line">with open(sys.argv[1]) as input_gff:</span><br><span class="line">    sp_name = input_gff.name.replace(&apos;.gff3&apos;,&apos;&apos;)</span><br><span class="line">    for row in input_gff:</span><br><span class="line">        lst1 = row.split(&apos;\t&apos;)</span><br><span class="line">        if &quot;gene_id&quot; in lst1[8]:</span><br><span class="line">            lst1[8] = &quot;ID=&quot;+sp_name+&quot;_&quot;+str(i)</span><br><span class="line">            new_list=&apos;\t&apos;.join(lst1)</span><br><span class="line">            print(new_list)</span><br><span class="line">            i+=1</span><br><span class="line">        else:</span><br><span class="line">            lst1[8] = &quot;Parent=&quot;+sp_name+&quot;_&quot;+str(i-1)</span><br><span class="line">            new_list=&apos;\t&apos;.join(lst1)</span><br><span class="line">            print(new_list)</span><br><span class="line">```python</span><br></pre></td></tr></table></figure><p>#reformat.py2<br>import sys<br>i=1<br>with open(sys.argv[1]) as input_gff:<br>    sp_name = input_gff.name.replace(‘assemble.remove_mRNA.gff3’,’best_assembled’)<br>    for row in input_gff:<br>        lst1 = row.split(‘\t’)<br>        if “TU” in lst1[8]:<br>            lst1[8] = “ID=”+sp_name+”<em>“+str(i)<br>            new_list=’\t’.join(lst1)<br>            print(new_list)<br>            i+=1<br>        else:<br>            lst1[8] = “Parent=”+sp_name+”</em>“+str(i-1)<br>            new_list=’\t’.join(lst1)<br>            print(new_list)</p><pre><code class="python"></code></pre>]]></content>
      
      
      
        <tags>
            
            <tag> OrthoFinder </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ggsci自动生成适合学术期刊的配色</title>
      <link href="/2020/04/22/Nature%20%E9%85%8D%E8%89%B2%E9%A3%8E%E6%A0%BCpal_npg/"/>
      <url>/2020/04/22/Nature%20%E9%85%8D%E8%89%B2%E9%A3%8E%E6%A0%BCpal_npg/</url>
      
        <content type="html"><![CDATA[<p>最近做了很多图被说不好看。想到ggsci可以自动给分组添加颜色，就想看看他可不可以把颜色的十六进制码输出出来，然后发现是有这个函数的。</p><p>ggsci提供以下颜色</p><blockquote><p>Name    Scales    Palette Types    Palette Generator</p><p>NPG    scale_color_npg() scale_fill_npg()    “nrc”    pal_npg()</p><p>AAAS    scale_color_aaas() scale_fill_aaas()    “default”    pal_aaas()</p><p>NEJM    scale_color_nejm() scale_fill_nejm()    “default”    pal_nejm()</p><p>Lancet    scale_color_lancet() scale_fill_lancet()    “lanonc”    pal_lancet()</p><p>JAMA    scale_color_jama() scale_fill_jama()    “default”    pal_jama()</p><p>JCO    scale_color_jco() scale_fill_jco()    “default”    pal_jco()</p><p>UCSCGB    scale_color_ucscgb() scale_fill_ucscgb()    “default”    pal_ucscgb()</p><p>D3    scale_color_d3()</p></blockquote><a id="more"></a> <p>library(ggsci)<br>library(scales)</p><p>###Nature 配色风格pal_npg</p><p>npg_pal &lt;- pal_npg(“nrc”)(8) #函数中types没有测试有什么功能，可能控制了基础类型，如bright warm等，alpha可以修改颜色的透明度，具体反映在十六进制颜色代码后。如#FF0000为红色#FF0000FF为透明度为1的红色，#FF0000E5为透明度为0.7的红色，但是E5换算十进制后并不是255的70%，具体转换方式有待研究。<br>show_col(npg_pal)<br>npg_pal</p><h3 id="Science-配色风格pal-aaas"><a href="#Science-配色风格pal-aaas" class="headerlink" title="Science 配色风格pal_aaas"></a>Science 配色风格pal_aaas</h3><p>aaas_pal &lt;- pal_aaas(“default”)(8)<br>show_col(aaas_pal)<br>aaas_pal</p><h3 id="NEJM0配色nejm-pal"><a href="#NEJM0配色nejm-pal" class="headerlink" title="NEJM0配色nejm_pal"></a>NEJM0配色nejm_pal</h3><p>nejm_pal &lt;- pal_nejm(“default”)(8)<br>show_col(nejm_pal)<br>nejm_pal</p>]]></content>
      
      
      
        <tags>
            
            <tag> Markdown, maker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/2020/03/09/identify/"/>
      <url>/2020/03/09/identify/</url>
      
        <content type="html"><![CDATA[<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">hmmsearch -o batatas.hmmsearch.log --tblout batatas.hmmsearch.tblout SBP.hmm  longest.renamehead.transcript.fasta.transdecoder.pep</span><br><span class="line"></span><br><span class="line">awk '&#123;if ($1!~/^#/)print $1&#125;' batatas.hmmsearch.tblout &gt; batatas.hmmsearch.seqid</span><br><span class="line"></span><br><span class="line">makeblastdb -in  longest.renamehead.transcript.fasta.transdecoder.pep -title batatas -dbtype prot -parse_seqids -out batatas</span><br><span class="line"></span><br><span class="line">blastp -db batatas -query atspl.pep.fa -evalue 1e-3 -outfmt 6 &gt; batatas.blastp</span><br><span class="line"></span><br><span class="line">awk '&#123;print $2&#125;' batatas.blastp | sort | uniq &gt; batatas.blastp.seqid</span><br><span class="line"></span><br><span class="line">cat batatas*seqid | sort | uniq &gt; batatas.spl.seqid</span><br><span class="line"></span><br><span class="line">perl extract.pl batatas.spl.seqid batatas.pep.fa &gt; batatas.spl.fa</span><br><span class="line"></span><br><span class="line">grep '&gt;' trifida.spl.long.fa &gt; trifida.spl.seqid</span><br><span class="line"></span><br><span class="line">cat batatas.smart.remove batatas.spl.seqid| sort | uniq -u &gt; batatas.smartSBP.seqid</span><br><span class="line"></span><br><span class="line">perl extract.pl batatas.smartSBP.seqid batatas.pep.fa &gt; batatas.spl.smart.fa</span><br><span class="line"></span><br><span class="line">blastp -query batatas.spl.smart.fa -subject trifida.spl.smart.fa -outfmt 6 -max_target_seqs 1 &gt; b2t.log</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">less batatas.spl.seqid | while read line; do grep $&#123;line&#125; transcript.fasta.transdecoder.gff3 | awk -v OFS="\t" '&#123; if ($3 == "mRNA") print $1, $4, $5 &#125;' &gt;&gt; blast_result.bed; done</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>OrthoMCL进行同源基因比对</title>
      <link href="/2019/12/21/mysql/"/>
      <url>/2019/12/21/mysql/</url>
      
        <content type="html"><![CDATA[<h1 id="以root账户登陆mysql"><a href="#以root账户登陆mysql" class="headerlink" title="以root账户登陆mysql"></a>以root账户登陆mysql</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -u root -p</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># 创建本地登录的账户</span><br><span class="line">create user &apos;mysql&apos;@&apos;localhost&apos; identified by &apos;111111&apos;;</span><br><span class="line"></span><br><span class="line"># 创建远程可登录的账户</span><br><span class="line">create user &apos;mysql&apos;@&apos;%&apos; identified by &apos;111111&apos;;</span><br><span class="line"></span><br><span class="line"># 用户创建完成后，刷新授权</span><br><span class="line">flush privileges;</span><br><span class="line"></span><br><span class="line"># 创建一个新的数据库</span><br><span class="line">create database orthomcl DEFAULT CHARSET utf8 COLLATE utf8_general_ci;</span><br><span class="line"></span><br><span class="line"># 授权</span><br><span class="line">GRANT ALL PRIVILEGES ON orthomcl.* TO &apos;orthomcl&apos;@&apos;localhost&apos;   IDENTIFIED BY &apos;111111&apos;;</span><br><span class="line">GRANT ALL PRIVILEGES ON orthomcl.* TO &apos;orthomcl&apos;@&apos;%&apos;   IDENTIFIED BY &apos;111111&apos;;</span><br><span class="line">flush privileges;</span><br><span class="line"></span><br><span class="line"># 查看结果</span><br><span class="line">show databases;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">perl scripts/orthomcl-setup-database.pl --user orthomcl --password 111111 --host 127.0.0.1 --database orthomcl --outfile configure_outfile.conf [--no-create-database]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">perl scripts/orthomcl-pipeline.pl -i ../../data/orthomcl/ -o ../../data/orthomcl_out -m configure_outfile.conf --nocompliant</span><br></pre></td></tr></table></figure><p>Warning: directory “../../data/orthomcl_out” already exists, are you sure you want to store data here [Y]? Y</p><p>Starting OrthoMCL pipeline on: Sun Dec 15 11:12:16 2019</p><p>Git commit: 08bd2baf43db6e35afb3e22e95dce8a3f740729c</p><p>=Stage 1: Validate Files =</p><p>Validating Pcollaris_S26913_per_pep.fasta … 6276 sequences</p><p>Validating Pocularis_EAK479_pep.fasta … 6224 sequences</p><p>Validating Prubeculoides_QHH0839_pep.fasta … 6704 sequences</p><p>Validating Pimmaculata_XZ14285_pep.fasta … 5791 sequences</p><p>Validating Pkoslowi_26923_pep.fasta … 11783 sequences</p><p>Validating Pcollaris_PA20150614-Sichuan_pep.fasta … 8328 sequences</p><p>Validating Prubida_2S_63614_pep.fasta … 12875 sequences</p><p>Validating Pstrophita_assemble_pep.fasta … 20581 sequences</p><p>Validating Pcollaris_130562_Jon_Italy_pep.fasta … 6855 sequences</p><p>Validating Patrogularis_141230_pep.fasta … 10880 sequences</p><p>Validating Pmodularis_117541_pep.fasta … 8978 sequences</p><p>Validating Pmontanella_m80200_pep.fasta … 8534 sequences</p><p>Validating Pcollaris_S1318_taiwan_pep.fasta … 14461 sequences</p><p>Validating Pocularis_MR1290_pep.fasta … 6774 sequences</p><p>Validating Phimalayana_66660_pep.fasta … 6852 sequences</p><p>Validating Phimalayana_57883_pep.fasta … 7552 sequences</p><p>Validating Pfulvescens_QHH0845_pep.fasta … 9746 sequences</p><p>Validating Gallus_gallus_pep.fasta … 28444 sequences</p><p>Validated 18 files</p><p>Stage 1 took 0.17 minutes </p><p>=Stage 2: Validate Database=</p><p>Warning: some tables exist already in database dbi:mysql:orthomcl_new:127.0.0.1:mysql_local_infile, user=root, database_name=orthomcl_new. Do you want to remove (y/n)? y</p><p>Executing: ‘drop database orthomcl_new’</p><p>Executing: ‘create database orthomcl_new’</p><p>Successfully removed old database entries</p><p>Stage 2 took 0.02 minutes </p><p>=Stage 3: Load OrthoMCL Database Schema=</p><p>/home/sunhaoyun/software/orthomcl-pipeline/orthomclSoftware-v2.0.9/bin/orthomclInstallSchema “/home/sunhaoyun/software/orthomcl-pipeline/configure_outfile.conf” “/home/sunhaoyun/data/orthomcl_out/log/orthomclSchema.log” 1&gt;/home/sunhaoyun/data/orthomcl_out/log/3.loadschema.stdout.log 2&gt;/home/sunhaoyun/data/orthomcl_out/log/3.loadschema.stderr.log</p><p>Stage 3 took 0.00 minutes </p><p>=Stage 4: Adjust Fasta=</p><p>/home/sunhaoyun/software/orthomcl-pipeline/orthomclSoftware-v2.0.9/bin/orthomclAdjustFasta Pcollaris_S26913_per_pep “/home/sunhaoyun/data/orthomcl/Pcollaris_S26913_per_pep.fasta” 1</p><p>/home/sunhaoyun/software/orthomcl-pipeline/orthomclSoftware-v2.0.9/bin/orthomclAdjustFasta Pocularis_EAK479_pep “/home/sunhaoyun/data/orthomcl/Pocularis_EAK479_pep.fasta” 1</p><p>/home/sunhaoyun/software/orthomcl-pipeline/orthomclSoftware-v2.0.9/bin/orthomclAdjustFasta Prubeculoides_QHH0839_pep “/home/sunhaoyun/data/orthomcl/Prubeculoides_QHH0839_pep.fasta” 1</p><p>/home/sunhaoyun/software/orthomcl-pipeline/orthomclSoftware-v2.0.9/bin/orthomclAdjustFasta Pimmaculata_XZ14285_pep “/home/sunhaoyun/data/orthomcl/Pimmaculata_XZ14285_pep.fasta” 1</p><p>/home/sunhaoyun/software/orthomcl-pipeline/orthomclSoftware-v2.0.9/bin/orthomclAdjustFasta Pkoslowi_26923_pep “/home/sunhaoyun/data/orthomcl/Pkoslowi_26923_pep.fasta” 1</p><p>/home/sunhaoyun/software/orthomcl-pipeline/orthomclSoftware-v2.0.9/bin/orthomclAdjustFasta Pcollaris_PA20150614-Sichuan_pep “/home/sunhaoyun/data/orthomcl/Pcollaris_PA20150614-Sichuan_pep.fasta” 1</p><p>/home/sunhaoyun/software/orthomcl-pipeline/orthomclSoftware-v2.0.9/bin/orthomclAdjustFasta Prubida_2S_63614_pep “/home/sunhaoyun/data/orthomcl/Prubida_2S_63614_pep.fasta” 1</p><p>/home/sunhaoyun/software/orthomcl-pipeline/orthomclSoftware-v2.0.9/bin/orthomclAdjustFasta Pstrophita_assemble_pep “/home/sunhaoyun/data/orthomcl/Pstrophita_assemble_pep.fasta” 1</p><p>/home/sunhaoyun/software/orthomcl-pipeline/orthomclSoftware-v2.0.9/bin/orthomclAdjustFasta Pcollaris_130562_Jon_Italy_pep “/home/sunhaoyun/data/orthomcl/Pcollaris_130562_Jon_Italy_pep.fasta” 1</p><p>/home/sunhaoyun/software/orthomcl-pipeline/orthomclSoftware-v2.0.9/bin/orthomclAdjustFasta Patrogularis_141230_pep “/home/sunhaoyun/data/orthomcl/Patrogularis_141230_pep.fasta” 1</p><p>/home/sunhaoyun/software/orthomcl-pipeline/orthomclSoftware-v2.0.9/bin/orthomclAdjustFasta Pmodularis_117541_pep “/home/sunhaoyun/data/orthomcl/Pmodularis_117541_pep.fasta” 1</p><p>/home/sunhaoyun/software/orthomcl-pipeline/orthomclSoftware-v2.0.9/bin/orthomclAdjustFasta Pmontanella_m80200_pep “/home/sunhaoyun/data/orthomcl/Pmontanella_m80200_pep.fasta” 1</p><p>/home/sunhaoyun/software/orthomcl-pipeline/orthomclSoftware-v2.0.9/bin/orthomclAdjustFasta Pcollaris_S1318_taiwan_pep “/home/sunhaoyun/data/orthomcl/Pcollaris_S1318_taiwan_pep.fasta” 1</p><p>/home/sunhaoyun/software/orthomcl-pipeline/orthomclSoftware-v2.0.9/bin/orthomclAdjustFasta Pocularis_MR1290_pep “/home/sunhaoyun/data/orthomcl/Pocularis_MR1290_pep.fasta” 1</p><p>/home/sunhaoyun/software/orthomcl-pipeline/orthomclSoftware-v2.0.9/bin/orthomclAdjustFasta Phimalayana_66660_pep “/home/sunhaoyun/data/orthomcl/Phimalayana_66660_pep.fasta” 1</p><p>/home/sunhaoyun/software/orthomcl-pipeline/orthomclSoftware-v2.0.9/bin/orthomclAdjustFasta Phimalayana_57883_pep “/home/sunhaoyun/data/orthomcl/Phimalayana_57883_pep.fasta” 1</p><p>/home/sunhaoyun/software/orthomcl-pipeline/orthomclSoftware-v2.0.9/bin/orthomclAdjustFasta Pfulvescens_QHH0845_pep “/home/sunhaoyun/data/orthomcl/Pfulvescens_QHH0845_pep.fasta” 1</p><p>/home/sunhaoyun/software/orthomcl-pipeline/orthomclSoftware-v2.0.9/bin/orthomclAdjustFasta Gallus_gallus_pep “/home/sunhaoyun/data/orthomcl/Gallus_gallus_pep.fasta” 1</p><p>Stage 4 took 0.08 minutes </p><p>=Stage 5: Filter Fasta=</p><p>/home/sunhaoyun/software/orthomcl-pipeline/orthomclSoftware-v2.0.9/bin/orthomclFilterFasta “/home/sunhaoyun/data/orthomcl_out/compliant_fasta” 10 20</p><p>Stage 5 took 0.12 minutes </p><p>=Stage 6: Split Fasta=</p><p>splitting /home/sunhaoyun/data/orthomcl_out/blast_dir/goodProteins.fasta into 4 pieces</p><p>jStage 6 took 0.42 minutes </p><p>=Stage 7: Format Database=</p><p>/home/sunhaoyun/software/orthomcl-pipeline/blast-2.2.26/bin/formatdb -i “/home/sunhaoyun/data/orthomcl_out/blast_dir/goodProteins.fasta” -p “T” -l “/home/sunhaoyun/data/orthomcl_out/log/formatdb.log” 1&gt;/home/sunhaoyun/data/orthomcl_out/log/7.format-stdout.log 2&gt;/home/sunhaoyun/data/orthomcl_out/log/7.format-stderr.log</p>]]></content>
      
      
      
        <tags>
            
            <tag> Mysql, OrthoMCL </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Genome assemble statistic</title>
      <link href="/2019/12/06/%E5%9F%BA%E5%9B%A0%E7%BB%84%E7%BB%84%E8%A3%85%E8%AF%84%E4%BB%B7/"/>
      <url>/2019/12/06/%E5%9F%BA%E5%9B%A0%E7%BB%84%E7%BB%84%E8%A3%85%E8%AF%84%E4%BB%B7/</url>
      
        <content type="html"><![CDATA[<p>##基因组组装评价</p><p>真的有很多的脚本可以去算这个数，但是，每个软件算出来的数值都不太一样，有的差距很小，有的差距很大，还有把N50 L50搞反的，真的，五花八门，也没有查到文献中推荐哪个好，好像大家都是自己算自己的。</p><blockquote><blockquote><p>N50</p><blockquote><p>the <strong><em>N50</em></strong> is defined as the sequence length of the shortest contig at 50% of the total genome length.</p></blockquote><p>L50</p><blockquote><p>Given a set of contigs, each with its own length, the <strong><em>L50</em></strong> count is defined as the smallest number of contigs whose length sum makes up half of genome size. From the example above the L50=3.</p></blockquote><p>N90</p><blockquote><p>The <strong><em>N90 statistic</em></strong> is less than or equal to the <em>N50</em> statistic; it is the length for which the collection of all contigs of that length or longer contains at least 90% of the sum of the lengths of all contigs, </p></blockquote><p>NG50</p><blockquote><p>Note that <em>N50</em> is calculated in the context of the assembly size rather than the genome size</p></blockquote><p>D50</p><blockquote><p>The <em>D50</em> statistic is the lowest value <em>d</em> for which the sum of the lengths of the largest <em>d</em> lengths is at least 50% of the sum of all of the length</p></blockquote></blockquote><p>统计方法还有很多，参考<a href="https://en.wikipedia.org/wiki/N50%2C_L50%2C_and_related_statistics" target="_blank" rel="noopener">wiki</a></p></blockquote><a id="more"></a> <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/sanger-pathogens/assembly-stats.git</span><br><span class="line">mkdir build</span><br><span class="line">cd build</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">## 非root安装</span></span></span><br><span class="line">cmake -DINSTALL_DIR:PATH=/home/qu/sunhy/sunhy/softwares/assemblystat ..</span><br><span class="line">make &amp;&amp; make install</span><br><span class="line">cp ../assemblystat/* ../bin</span><br><span class="line">source ~/sunhy/source_shy</span><br><span class="line"></span><br><span class="line">cd ~/sunhy/sunhy/data/prunella/genome/genome/</span><br><span class="line">ls *.fa | while read line;do assembly-stats $&#123;line&#125; &gt;&gt; assembly.stat.total; done</span><br></pre></td></tr></table></figure><p>发现如果用这个脚本的话，格式转换起来嗨得自己写脚本，换别的软件试试</p><p>用了quast的方法。发现也不是很好，尤其是其得到的统计图，好难看</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python /home/qu/sunhy/sunhy/softwares/quast-5.0.2/quast.py *.fa</span><br></pre></td></tr></table></figure><p>最后还是用的bbmap的脚本，statswrapper.sh</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> bbmap的输入也比较有意思，先用tr把换行符换为逗号</span></span><br><span class="line">ls *.fa | tr "\n" "," </span><br><span class="line"></span><br><span class="line">sh /home/qu/sunhy/sunhy/softwares/bbmap/statswrapper.sh in=Prunella_atrogularis_141230.fa,Prunella_collaris_130562_J_Italy.fa,Prunella_collaris_PA20150614-Sichuan.fa,Prunella_collaris_S1318_taiwan.fa,Prunella_collaris_S26913_per.fa,Prunella_fulvescens_QHH0845.fa,Prunella_himalayana_57883.fa,Prunella_himalayana_66660.fa,Prunella_immaculata_XZ14285.fa,Prunella_koslowi_26923.fa,Prunella_modularis_117541.fa,Prunella_montanella_m80200.fa,Prunella_ocularis_EAK479.fa,Prunella_ocularis_MR1290.fa,Prunella_rubeculoides_QHH0839.fa,Prunella_rubida_2S_63614.fa,Prunella_strophita_assemble.fa &gt; bbmap.stats.txt</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 统计cds intron exon数量和平均长度</span></span><br><span class="line">ls *.gff3 | while read line</span><br><span class="line">do</span><br><span class="line">echo $&#123;line&#125; &gt;&gt; cei</span><br><span class="line">cat $&#123;line&#125;| awk '&#123; if ($3 == "gene") print $0 &#125;' | awk '&#123; sum += ($5 - $4) &#125; END &#123; print NR, sum / NR &#125;' &gt;&gt; cei</span><br><span class="line">cat $&#123;line&#125;| awk '&#123; if ($3 == "exon") print $0 &#125;' | awk '&#123; sum += ($5 - $4) &#125; END &#123; print NR, sum / NR &#125;' &gt;&gt; cei</span><br><span class="line">cat $&#123;line&#125;| awk '&#123; if ($3 == "intron") print $0 &#125;' | awk '&#123; sum += ($5 - $4) &#125; END &#123; print NR, sum / NR &#125;'&gt;&gt;cei</span><br><span class="line">done</span><br></pre></td></tr></table></figure><p>整理到excel表格里</p><p>###提取序列</p><p>因为有正链和反链，然后又收到命令可能要把exon和intron提出来，写了个比较蠢的python的方法，然后在本地测试和服务器上结果不太一样，也懒得改了，这个也是能用的，主要不一样在row.split(‘\t’)，感觉是本机不能识别换行符的原因？</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">input_gff = sys.argv[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open(input_gff, <span class="string">'r'</span>) <span class="keyword">as</span> intf:</span><br><span class="line">    cds_out = open(str(intf.name) + <span class="string">'.fo.cds'</span>, <span class="string">'w'</span>)</span><br><span class="line">    exon_out = open(str(intf.name) + <span class="string">'.fo.exon'</span>, <span class="string">'w'</span>)</span><br><span class="line">    intron_out = open(str(intf.name) + <span class="string">'.fo.intron'</span>, <span class="string">'w'</span>)</span><br><span class="line">    cds_re_out = open(str(intf.name) + <span class="string">'.re.cds'</span>, <span class="string">'w'</span>)</span><br><span class="line">    exon_re_out = open(str(intf.name) + <span class="string">'.re.exon'</span>, <span class="string">'w'</span>)</span><br><span class="line">    intron_re_out = open(str(intf.name) + <span class="string">'.re.intron'</span>, <span class="string">'w'</span>)</span><br><span class="line">    <span class="keyword">for</span> row <span class="keyword">in</span> intf:</span><br><span class="line">        row = row.strip()</span><br><span class="line">        parttern = row.split(<span class="string">'\t'</span>)</span><br><span class="line">        parttern = [x <span class="keyword">for</span> x <span class="keyword">in</span> parttern <span class="keyword">if</span> x != <span class="string">''</span>]</span><br><span class="line">        parttern2 = str(parttern[<span class="number">6</span>])</span><br><span class="line">        parttern2 = parttern2.strip()</span><br><span class="line">        <span class="keyword">if</span> parttern[<span class="number">2</span>] == <span class="string">'gene'</span> <span class="keyword">and</span> parttern2 == <span class="string">'+'</span>:</span><br><span class="line">            cds_out.write(str(parttern[<span class="number">0</span>])+<span class="string">'\t'</span>+str(parttern[<span class="number">3</span>])+<span class="string">'\t'</span>+str(parttern[<span class="number">4</span>])+<span class="string">'\n'</span>)</span><br><span class="line">        <span class="keyword">elif</span> parttern[<span class="number">2</span>] == <span class="string">'gene'</span> <span class="keyword">and</span> parttern2 == <span class="string">'-'</span>:</span><br><span class="line">            cds_re_out.write(str(parttern[<span class="number">0</span>])+<span class="string">'\t'</span>+str(parttern[<span class="number">3</span>])+<span class="string">'\t'</span>+str(parttern[<span class="number">4</span>])+<span class="string">'\n'</span>)</span><br><span class="line">        <span class="keyword">elif</span> parttern[<span class="number">2</span>] == <span class="string">'exon'</span> <span class="keyword">and</span> parttern2 == <span class="string">'+'</span>:</span><br><span class="line">            exon_out.write(str(parttern[<span class="number">0</span>])+<span class="string">'\t'</span>+str(parttern[<span class="number">3</span>])+<span class="string">'\t'</span>+str(parttern[<span class="number">4</span>])+<span class="string">'\n'</span>)</span><br><span class="line">        <span class="keyword">elif</span> parttern[<span class="number">2</span>] == <span class="string">'exon'</span> <span class="keyword">and</span> parttern2 == <span class="string">'-'</span>:   </span><br><span class="line">            exon_re_out.write(str(parttern[<span class="number">0</span>])+<span class="string">'\t'</span>+str(parttern[<span class="number">3</span>])+<span class="string">'\t'</span>+str(parttern[<span class="number">4</span>])+<span class="string">'\n'</span>)</span><br><span class="line">        <span class="keyword">elif</span> parttern[<span class="number">2</span>] == <span class="string">'intron'</span> <span class="keyword">and</span> parttern2 == <span class="string">'+'</span>:</span><br><span class="line">            intron_out.write(str(parttern[<span class="number">0</span>])+<span class="string">'\t'</span>+str(parttern[<span class="number">3</span>])+<span class="string">'\t'</span>+str(parttern[<span class="number">4</span>])+<span class="string">'\n'</span>)</span><br><span class="line">        <span class="keyword">elif</span> parttern[<span class="number">2</span>] == <span class="string">'intron'</span> <span class="keyword">and</span> parttern2 == <span class="string">'-'</span>:</span><br><span class="line">            intron_re_out.write(str(parttern[<span class="number">0</span>])+<span class="string">'\t'</span>+str(parttern[<span class="number">3</span>])+<span class="string">'\t'</span>+str(parttern[<span class="number">4</span>])+<span class="string">'\n'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cds_out.close()</span><br><span class="line">exon_out.close()</span><br><span class="line">intron_out.close()</span><br><span class="line">cds_re_out.close()</span><br><span class="line">exon_re_out.close()</span><br><span class="line">intron_re_out.close()</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 先做一个只有物种前缀的list</span></span><br><span class="line">ls ../genome/*.fa &gt;list</span><br><span class="line">sed -i 's/..\/genome//g' list </span><br><span class="line">sed -i 's/.fa//g' list </span><br><span class="line"><span class="meta">#</span><span class="bash"> 最后用bedtools getfasta 提取序列</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> follow 链的</span></span><br><span class="line">cat list | while read line; do bedtools getfasta -fi ../genome/$&#123;line&#125;.fa -bed cds/$&#123;line&#125;.gff3.fo.cds -fo cds_fa/$&#123;line&#125;.cds.fa; done</span><br><span class="line"><span class="meta">#</span><span class="bash"> reverse 链的</span></span><br><span class="line">cat list | while read line; do bedtools getfasta -fi ../genome/$&#123;line&#125;.fa -bed cds/$&#123;line&#125;.gff3.re.cds -fo cds_re_fa/$&#123;line&#125;.cds.re.fa; done</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用EMBOSS里的revseq</span></span><br><span class="line">ls *.fa | while read line; do revseq $&#123;line&#125; -outseq $&#123;line&#125;.finish; done</span><br><span class="line"><span class="meta">#</span><span class="bash"> 合并正链和反链</span></span><br><span class="line">cat list | while read line; do cat cds_fa/$&#123;line&#125;.cds.fa cds_re_fa/$&#123;line&#125;.cds.fa.finish &gt; cds_final/$&#123;line&#125;.cds.merge.fa ; done</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 用emboss 的transeq 翻译成蛋白，但是有问题就是里面的N太多了，X和*的差别？</span></span><br><span class="line">ls *.fa | while read line; do transeq $&#123;line&#125; -outseq ../pep_final/$&#123;line&#125;; done</span><br><span class="line">cd ../pep_final</span><br><span class="line">rename cds pep *.fa</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> geome </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>建一颗ML树</title>
      <link href="/2019/12/04/shimei/"/>
      <url>/2019/12/04/shimei/</url>
      
        <content type="html"><![CDATA[<h4 id="流程大概就是"><a href="#流程大概就是" class="headerlink" title="流程大概就是"></a>流程大概就是</h4><p>刘亮老师讲的那个差不多</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">## 安装mafft</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 下载mafft，因为mafft的安装包是.rpm结尾的压缩包，rpm包如果不用管理员安装的话会提示权限错误，但是咱这脑</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 子就别用管理员了，万一删了啥不该删的。rpm2cpio这个工具可以把rpm包在当前目录解压缩，使用方法为</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> rpm2cpio XXX.rpm | cpio -div 解压出来的结果会默认先放在usr里面</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> wget https://mafft.cbrc.jp/alignment/software/mafft-7.450-gcc_fc6.x86_64.rpm</span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">## 由于mac没有rpm2cpio, linux跳过brew install  rpm2cpio这句</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> brew install  rpm2cpio</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> rpm2cpio mafft-7.450-gcc_fc6.x86_64.rpm | cpio -div</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 解压完可以看到出现了一个usr目录，usr里的bin放的是执行文件，mafft要求所有所有执行文件都在环境变量里，</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 所以下一步先添加环境变量，就是快捷方式，首先要查看当前目录在哪儿,<span class="built_in">pwd</span> 获取当前目录,假如说现在目录 </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 在/home/zhengyuno/softwares/mafft</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> usr</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> bin</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">pwd</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">/home/zhengyuno/softwares/mafft/usr/bin</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> vim ~/.bash_profile</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 滚到最下面的空白处把<span class="built_in">pwd</span>的结果加上一些符号粘贴进去，vim编辑器输入时候，摁i是进入insert模式，输入完了摁</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> esc退出insert模式，然后摁 :wq 保存并退出 （左下角会显示状态）。输入的时候一定要记得前后的PATH要不然</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 就啥快捷方式都没了，别问我为啥知道，试过好多次了T.T</span></span><br><span class="line"></span><br><span class="line">export PATH=/home/zhengyuno/softwares/mafft/usr/bin:$PATH</span><br><span class="line"><span class="meta">#</span><span class="bash"> 输入mafft出来这个交互式页面就ok了</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> mafft</span></span><br><span class="line"></span><br><span class="line">---------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">   MAFFT v7.450 (2019/Aug/23)</span><br><span class="line"></span><br><span class="line">        MBE 30:772-780 (2013), NAR 30:3059-3066 (2002)</span><br><span class="line">        https://mafft.cbrc.jp/alignment/software/</span><br><span class="line">---------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Input file? (FASTA format; Folder=/Users/sunhaoyun/temp_dir/usr/bin)</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> ctrl + c 中断当前程序，然后我们就不用交互式的模式了，直接用一行的<span class="built_in">command</span> line模式就行</span></span><br></pre></td></tr></table></figure><p>这里推荐看<a href="http://www.chenlianfu.com/?p=2214" target="_blank" rel="noopener">陈连福老师的博客</a> </p><p>以及<a href="https://mafft.cbrc.jp/alignment/software/manual/manual.html" target="_blank" rel="noopener">官方文档</a>，当然我这种比较懒的官方的manual都没看完过</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">## mafft的使用 首先选一个算法，看一下算法有很多，有的适合差不多长的，有的适合比较近缘的，不会选，</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 用auto，看一下output选项，因为下一步过滤要fasta格式，他默认也是fasta,不用改</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> mafft --auto cds_ENSG00000000419.fasta &gt; cds419_mafft_out.fa</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">运行完了屏幕上的信息可以保存一下</span></span><br></pre></td></tr></table></figure><a id="more"></a> <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">## 安装G-block</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> gblock安装很简单，回到softwares目录. Gblock是tar z 压缩文件 用tar 的xz命令就行</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> wget http://molevol.cmima.csic.es/castresana/Gblocks/Gblocks_Linux64_0.91b.tar.Z</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> tar zxvf Gblocks_Linux64_0.91b.tar.Z</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> Gblocks_0.91b</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ./Gblocks</span></span><br><span class="line">******************************************************</span><br><span class="line">                    GBLOCKS 0.91b                     </span><br><span class="line">SELECTION OF CONSERVED BLOCKS FROM MULTIPLE ALIGNMENTS</span><br><span class="line">        FOR THEIR USE IN PHYLOGENETIC ANALYSIS        </span><br><span class="line">******************************************************</span><br><span class="line"></span><br><span class="line">o. Open File</span><br><span class="line"></span><br><span class="line">b. Block Parameters</span><br><span class="line"></span><br><span class="line">s. Saving Options</span><br><span class="line"></span><br><span class="line">g. (Get Blocks)</span><br><span class="line"></span><br><span class="line">q. Quit</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Your Choice: </span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 应该可以运行 也是交互式的 ctrl + c 退出就行,也添加一下变量吧，</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> vim ~/.bash_profile</span></span><br><span class="line">export PATH=/home/zhengyuno/softwares/Gblocks_0.91b:$PATH</span><br></pre></td></tr></table></figure><p>Gblocks 的<a href="http://molevol.cmima.csic.es/castresana/Gblocks/Gblocks_documentation.html" target="_blank" rel="noopener">官方文档</a></p><p>这个还是得看一下</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">## -t=选择氨基酸还是核酸 -b1几几这些他的默认要求都比较高，所以如果使用默认的在亲缘关系较远的物种，</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 就会什么都不剩下，所以可以选择不过滤或者手动把b12345都设置的低一些，比如我这个有90个物种，</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果都是默认参数在所有物种里都保守的话，就没有保守的可以算进来了，主要还是看研究的问题是什么</span></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> Gblocks cds419_mafft_out.fa -b1=10 -b2=10 -b3=6 -b4=10 -b5=h </span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># 默认是原来的名字加-gb结尾的fa文件</span></span></span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">## 安装raxml</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 其实现在raxml-ng 出来了稳定版，更推荐使用这个新的，因为raxml-ng的wiki写的真的特别好，一步一步的。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 不过当时刘亮老师教的raxml现在用的也很多,就还用raxml把，回到softwares</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> raxml 用git <span class="built_in">clone</span>安装,下好了进去直接编译就好啦,一般编译多线程的版本，就是用起来更快的版本PTHREADS</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 两个都编译好了，因为有时候数据量小的话也不用那么多cpu</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git <span class="built_in">clone</span> https://github.com/stamatak/standard-RAxML.git</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> standard-RAxML</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> make -f Makefile.PTHREADS.gcc</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> make -f Makefile.gcc</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> vim ~/.bash_profile</span></span><br><span class="line">export PATH=/home/zhengyuno/softwares/standard-RAxML/:$PATH</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Raxml 需要的输入文件是phylip，而Gblocks的输出文件是fasta格式，所以就用raxml里面的小工具转换一下格</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 式。这一步时候注意目录</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sh /home/zhengyuno/softwares/standard-RAxML/usefulScripts/convertFasta2Phylip.sh cds419_mafft_out.fa-gb &gt; cds419_mafft_out.phylip</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 运行raxml -<span class="comment">#设置100次bootstrap，-p -b 设置seed，其实raxml-ng的那个说明里面写的更清楚，按照他那个</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 跑一遍会更好</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> raxmlHPC -s cds419_mafft_out.phylip -n out -mGTRGAMMA -p 666 -<span class="comment">#100 -b 666 </span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 然后一个ML法构建的基因树就做好了</span></span><br></pre></td></tr></table></figure><p><a href="https://github.com/stamatak/standard-RAxML" target="_blank" rel="noopener">raxml文档</a></p><p><a href="https://github.com/amkozlov/raxml-ng/wiki" target="_blank" rel="noopener">raxml-ng文档</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> Phylogeny </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>李笑来老板的re part</title>
      <link href="/2019/10/01/re/"/>
      <url>/2019/10/01/re/</url>
      
        <content type="html"><![CDATA[<h1 id="正则表达式"><a href="#正则表达式" class="headerlink" title="正则表达式"></a>正则表达式</h1><p>正则表达式本质上是个独立的语言，短小却格外强悍 —— 乃至于，如果你竟然没学会它的话，你的之前学的编程技能干脆与残疾无异。</p><p>Wikipedia 上对正则表达式的说明如下：</p><blockquote><p><strong>正则表达式</strong>（英语：Regular Expression，在代码中常简写为 regex、regexp 或 RE），又称<em>正规表示式</em>、<em>正规表示法</em>、<em>正规运算式</em>、<em>规则运算式</em>、<em>常规表示法</em>，是计算机科学的一个概念。正则表达式使用单个字符串来描述、匹配一系列符合某个句法规则的字符串。在很多文本编辑器里，正则表达式通常被用来检索、替换那些符合某个模式的文本。许多程序设计语言都支持利用正则表达式进行字符串操作。例如，在 Perl 中就内建了一个功能强大的正则表达式引擎。正则表达式这个概念最初是由 Unix 中的工具软件（例如 sed 和 grep）普及开的。</p></blockquote><a id="more"></a> <p>以下是绝大多数翻译成中文的教程中对正则表达式进行讲解时所使用的描述：</p><blockquote><p>一个正则表达式（Regular Expression）通常被称为一个模式（Pattern）。</p></blockquote><p>我常常觉得当初要是它被翻译成 “规则表达式”，那么很可能初学者不会感到那么大的压力 —— 谁都一样，看着由 “每个都认识的字构成的词组” 却不能直观地想到它究竟是什么东西，都会感到莫名的压力。</p><p><strong>Regular</strong>，其实在它的众多语义中，取以下释义最符合 Regular Expression 的原意<a href="#fn1" name="fn1b"><sup>[1]</sup></a>：</p><blockquote><p>⑭ Linguistics 规则的 ▸ regular verbs 规则动词</p></blockquote><p>而 <strong>Pattern</strong> 这个词，在词典里有好几个对应的中文词汇：</p><blockquote><p>① 图案；② 式样；③ 图样；④ 榜样；⑤ 模式；⑥ 样品；⑦ 模子</p></blockquote><p>在当前语境之下，把 Pattern 翻译成 “模式”，显然不如 “模子” 更好（甚至连 “样品” 感觉都比 “模式” 更恰当）—— “模子” 这个词很直观啊，拿着一个模子去找与它一致的字符串…… “与规则一致”，英文用的是 <strong>Match</strong>，一般被翻译作 “匹配”。</p><p>在自学编程的过程中，处处都是这种语言翻译带来的迷惑、障碍，或者耽误。既然应该把 Regular Expression 理解为 “规则表达式” 更好，那其实吧，把 Pattern 直接理解为中文的 “<em>规则</em>”，可能更直观更准确，理解上更是毫无障碍：</p><blockquote><p>一个规则表达式（Regular Expression）通常被称为一个规则（Pattern）。</p></blockquote><p>那么，<strong>规则表达式</strong>里写的是什么呢？只能是<strong>规则</strong>了…… 到最后好像也就 “捕获”（Capture）这个词没什么歧义。</p><p>现在，我们已经把术语全部 “解密” 了，然后再看看下面的表述：</p><blockquote><p>我们可以用书写特定的规则，用来在文本中捕获与规则一致的字符串，而后对其进行操作……</p></blockquote><p>理解起来相当顺畅。</p><p>以下的 Python 代码中，<a href="https://regexper.com#%5Cwo%5Cw" target="_blank" rel="noopener"><code>\wo\w</code></a> 就是一个<em>规则表达式</em>（或称为<em>规则</em>）；</p><p>而 <code>re.findall(pttn, str)</code> 的作用就是，在 <code>str</code> 里找到所有与这个<strong>规则</strong>（Pattern，模式）<strong>一致</strong>（Match，匹配）的字符串：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line">str = <span class="string">'The quick brown fox jumps over the lazy dog'</span></span><br><span class="line">pttn = re.compile(<span class="string">r'\wo\w'</span>)</span><br><span class="line">re.findall(pttn, str)</span><br></pre></td></tr></table></figure><pre><code>[&apos;row&apos;, &apos;fox&apos;, &apos;dog&apos;]</code></pre><p>总结一下：</p><blockquote><p><strong>规则表达式</strong>（Regular Expressions，通常缩写为 Regex）是最强大且不可或缺的文本处理工具 —— 它的用处就是在文本中<strong>扫描/搜索</strong>（Scan/Search）与某一<strong>规则</strong>（Pattern）<strong>匹配</strong>（Match，即，与规则一致）的所有实例，并且还可以按照规则<strong>捕获</strong>（Capture）其中的部分或者全部，对它们进行<strong>替换</strong>（Replace）。</p></blockquote><p>接下来为了避免歧义，我们干脆用 Regex 这个缩写，以及与它相关的英文单词：pattern, match, capture, replace(ment)……</p><p>有时，使用 Regex 并不是为了 Replace，而是为了检查格式，比如，可以用 Regex 检查用户输入的密码是否过于简单（比如，全部都由数字构成），比如可以用来验证用户输入的电话号码、证件号码是否符合特定格式等等。</p><p>另外，在自学的过程中，想尽一切办法把一切术语用简单直白的 “人话” 重新表述，是特别有效的促进进步的行为模式。</p><h2 id="视觉体验"><a href="#视觉体验" class="headerlink" title="视觉体验"></a>视觉体验</h2><p>所谓百闻不如一见。</p><p>眼见为实 —— 想办法让一个陌生的概念视觉上直观，是突破大多学习障碍的最简单粗暴直接有效的方式。</p><p>我们最好先直接看看 Regex 的工作过程。以下，是用微软发行的代码编辑工具 Visual Studio Code 针对一小段文本使用若干条 Regex 进行匹配的过程：</p><p><img src="https://raw.githubusercontent.com/selfteaching/the-craft-of-selfteaching/master/images/regex-test.gif?raw=true" alt></p><p>Python 的项目代码仓库里有一个很简短的 Demo 程序，叫 <a href="https://github.com/python/cpython/blob/master/Tools/demo/redemo.py" target="_blank" rel="noopener"><code>redemo.py</code></a>，它使用 <a href="https://docs.python.org/3/library/tkinter.html" target="_blank" rel="noopener">Tcl/Tk</a> 作为图形界面，也可以用来测试正则表达式。</p><p>它的代码地址是：</p><blockquote><p><a href="https://raw.githubusercontent.com/python/cpython/master/Tools/demo/redemo.py" target="_blank" rel="noopener">https://raw.githubusercontent.com/python/cpython/master/Tools/demo/redemo.py</a></p></blockquote><p>它运行起来长成这样：</p><p><img src="https://raw.githubusercontent.com/selfteaching/the-craft-of-selfteaching/master/images/redemo.png?raw=true" alt></p><p>目前（2019）网上最方便的 Regex 测试器，是 <a href="https://regex101.com" target="_blank" rel="noopener">regex101.com</a>：</p><p>以下，就是在一段文本中，找出所有首写字母大写的词汇的<em>过程</em>，并将其先全部替换成小写，再将其全部替换为大写的过程；使用的正则表达式是 <code>([A-Z]\w+)</code>，替换表达式分别是 <code>\L$1</code> 和 <code>\U$1</code>：</p><p><img src="https://raw.githubusercontent.com/selfteaching/the-craft-of-selfteaching/master/images/regex101.gif?raw=true" alt></p><p>这个网站太好了，所以，平日里我是用 <a href="https://github.com/jiahaog/nativefier" target="_blank" rel="noopener">Nativefier</a> 工具将这个网站打包为一个 Mac Desktop App 使用。不过，它也有局限，就是被搜索文件略微大点就报错，说 <code>timeout</code>……</p><h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><p>我们需要个文本文件，用来当作练习使用正则表达式去搜索替换的目标。这个文件保存在当前的根目录，文件名称是：<code>regex-target-text-sample.txt</code>。</p><p>以下代码中，<code>pttn = r&#39;beg[iau]ns?&#39;</code> 这一句中的 <a href="https://regexper.com#beg[iau]ns?" target="_blank" rel="noopener"><code>beg[iau]ns?</code></a> 就是 Regex 的 Pattern。</p><p><strong>注意</strong>：在 Python 代码中，写 Pattern 的时候，之所以要在字符串 <code>&#39;...&#39;</code> 之前加上 <code>r</code>，写成 <code>r&#39;...&#39;</code>，是因为如果不用 raw string 的话，那么，每个转义符号都要写成 <code>\\</code>；如果用 raw string，转义符号就可以直接使用 <code>\</code> 本身了…… 当然，如果你想搜索 <code>\</code> 这个符号本身的话，那么还是得写 <code>\\</code>。</p><p>而 <code>re.findall(pttn, str)</code> 的意思是说，把 <code>str</code> 中所有与 <code>pttn</code> 这个规则一致的字符串都找出来：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'regex-target-text-sample.txt'</span>, <span class="string">'r'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    str = f.read()</span><br><span class="line">pttn = <span class="string">r'beg[iau]ns?'</span></span><br><span class="line">re.findall(pttn, str)</span><br></pre></td></tr></table></figure><pre><code>[&apos;begin&apos;, &apos;began&apos;, &apos;begun&apos;, &apos;begin&apos;]</code></pre><p>文件 <code>regex-target-text-sample.txt</code> 中的内容如下：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">ol</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">pre</span>&gt;</span>begin began begun bigins begining<span class="tag">&lt;/<span class="name">pre</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">pre</span>&gt;</span>google gooogle goooogle goooooogle<span class="tag">&lt;/<span class="name">pre</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">pre</span>&gt;</span>coloured color coloring  colouring colored<span class="tag">&lt;/<span class="name">pre</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">pre</span>&gt;</span>never ever verb however everest<span class="tag">&lt;/<span class="name">pre</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">pre</span>&gt;</span>520 52000 5200000 520000000 520000000000<span class="tag">&lt;/<span class="name">pre</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">pre</span>&gt;</span>error wonderer achroiocythaemia achroiocythemia<span class="tag">&lt;/<span class="name">pre</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">pre</span>&gt;</span>The white dog wears a black hat.<span class="tag">&lt;/<span class="name">pre</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">pre</span>&gt;</span>Handel, Händel, Haendel<span class="tag">&lt;/<span class="name">pre</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ol</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dl</span>&gt;</span>(843) 542-4256<span class="tag">&lt;/<span class="name">dl</span>&gt;</span> <span class="tag">&lt;<span class="name">dl</span>&gt;</span>(431) 270-9664<span class="tag">&lt;/<span class="name">dl</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dl</span>&gt;</span>3336741162<span class="tag">&lt;/<span class="name">dl</span>&gt;</span> <span class="tag">&lt;<span class="name">dl</span>&gt;</span>3454953965<span class="tag">&lt;/<span class="name">dl</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">li</span>&gt;</span>peoplesr@live.com<span class="tag">&lt;/<span class="name">li</span>&gt;</span> <span class="tag">&lt;<span class="name">li</span>&gt;</span>jaxweb@hotmail.com<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">li</span>&gt;</span>dhwon@comcast.net<span class="tag">&lt;/<span class="name">li</span>&gt;</span> <span class="tag">&lt;<span class="name">li</span>&gt;</span>krueger@me.com<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h3</span>&gt;</span>URLs<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">https://docs.python.org/3/howto/regex.html</span><br><span class="line">https://docs.python.org/3/library/re.html</span><br><span class="line"><span class="tag">&lt;<span class="name">h3</span>&gt;</span>passwords<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">Pasw0rd~</span><br><span class="line">i*Eh,GF67E</span><br><span class="line">a$4Bh9XE&amp;E</span><br><span class="line"><span class="tag">&lt;<span class="name">h3</span>&gt;</span>duplicate words<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>It's very very big.<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>Keep it simple, simple, simple!<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br></pre></td></tr></table></figure><p>在以下的示例中，有时直接设定了 str 的值，而不是使用以上整个文本文件 —— 因为读者在阅读的时候，最好能直接看到被搜索的字符串。另外，如果使用整个文件，所得到的 Match 太多，也确实影响阅读。</p><h2 id="优先级"><a href="#优先级" class="headerlink" title="优先级"></a>优先级</h2><p>毕竟，你已经不是 “啥都不懂” 的人了。你已经知道一个事实：编程语言无非是用来运算的。</p><p>所谓的运算，就有操作符（Operators）和操作元（Operands）—— 而操作符肯定是有优先级的，不然的话，那么多操作元和操作符放在一起，究竟先操作哪个呢？</p><p>Regex 也一样，它本身就是个迷你语言（Mini Language）。在 Regex 中，操作符肯定也有优先级。它的操作元有个专门的名称，<strong>原子</strong>（Atom）。</p><p>先大致看看它的操作符优先级，你就会对它有相当不错的了解：</p><table><thead><tr><th>排列</th><th>原子与操作符优先级</th><th>（从高到低）</th></tr></thead><tbody><tr><td>1</td><td>转义符号 (Escaping Symbol)</td><td><code>\</code></td></tr><tr><td>2</td><td>分组、捕获 (Grouping or Capturing)</td><td><code>(...)</code> <code>(?:...)</code> <code>(?=...)</code> <code>(?!...)</code> <code>(?&lt;=...)</code> <code>(?&lt;!...)</code></td></tr><tr><td>3</td><td>数量 (Quantifiers)</td><td><code>a*</code> <code>a+</code> <code>a?</code> <code>a{n, m}</code></td></tr><tr><td>4</td><td>序列与定位（Sequence and Anchor）</td><td><code>abc</code> <code>^</code> <code>$</code> <code>\b</code> <code>\B</code></td></tr><tr><td>5</td><td>或（Alternation）</td><td><code>a|b|c</code></td></tr><tr><td>6</td><td>原子 (Atoms)</td><td><code>a</code> <code>[^abc]</code> <code>\t</code> <code>\r</code> <code>\n</code> <code>\d</code> <code>\D</code> <code>\s</code> <code>\S</code> <code>\w</code> <code>\W</code> <code>.</code></td></tr></tbody></table><p>当然，你若是在之前，没有自学过、理解过 Python（或者任何其它编程语言）表达式中的操作符优先级，那么一上来就看上面的表格不仅对你没有帮助，只能让你更迷惑。</p><p>—— 这就是理解能力逐步积累逐步加强的过程。</p><h2 id="原子"><a href="#原子" class="headerlink" title="原子"></a>原子</h2><p>在 Regex 的 Pattern 中，操作元，即，被运算的 “值”，被称为<strong>原子</strong>（Atom）。</p><h3 id="本义字符"><a href="#本义字符" class="headerlink" title="本义字符"></a>本义字符</h3><p>最基本的原子，就是本义字符，它们都是单个字符。</p><p>本义字符包括从 <code>a</code> 到 <code>z</code>，<code>A</code> 到 <code>Z</code>，<code>0</code> 到 <code>9</code>，还有 <code>_</code> —— 它们所代表的就是它们的字面值。</p><p>即，相当于，<code>string.ascii_letters</code> 和 <code>string.digits</code> 以及 <code>_</code>。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> IPython.core.interactiveshell <span class="keyword">import</span> InteractiveShell</span><br><span class="line">InteractiveShell.ast_node_interactivity = <span class="string">"all"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line">string.ascii_letters</span><br><span class="line">string.digits</span><br></pre></td></tr></table></figure><pre><code>&apos;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ&apos;&apos;0123456789&apos;</code></pre><p>以下字符在 Regex 中都有特殊含义：</p><blockquote><p><code>\</code> <code>+</code> <code>*</code> <code>.</code> <code>?</code> <code>-</code> <code>^</code> <code>$</code> <code>|</code> <code>(</code> <code>)</code> <code>[</code> <code>]</code> <code>{</code> <code>}</code> <code>&lt;</code> <code>&gt;</code></p></blockquote><p>当你在写 Regex 的时候，如果你需要搜索的字符不是本义字符，而是以上这些特殊字符时，<em>建议</em>都直接加上转义符号 <code>\</code> 来表示，比如，你想搜索 <code>&#39;</code>，那你就写 <code>\&#39;</code>，或者你想搜索 <code>#</code> 那你就写 <code>\#</code>（事实上，<code>#</code> 并不是 Regex 的特殊符号，所以，它之前的转义符号可有可无）—— 这对初学者来说可能是最安全的策略。</p><p>跟过往一样，所有的细节都很重要，它们就是需要花时间逐步熟悉到牢记。</p><h3 id="集合原子"><a href="#集合原子" class="headerlink" title="集合原子"></a>集合原子</h3><p>集合原子还是原子。</p><p>标示集合原子，使用方括号 <code>[]</code>。<code>[abc]</code> 的意思是说，“<code>a</code> or <code>b</code> or <code>c</code>”，即，<code>abc</code> 中的任意一个字符。</p><p>比如，<a href="https://regexper.com#beg[iau]n" target="_blank" rel="noopener"><code>beg[iau]n</code></a> 能够代表 <code>begin</code>、<code>began</code>，以及 <code>begun</code>。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">str = <span class="string">'begin began begun bigins begining'</span></span><br><span class="line">pttn = <span class="string">r'beg[iau]n'</span></span><br><span class="line">re.findall(pttn, str)</span><br></pre></td></tr></table></figure><pre><code>[&apos;begin&apos;, &apos;began&apos;, &apos;begun&apos;, &apos;begin&apos;]</code></pre><p>在方括号中，我们可以使用两个操作符：<code>-</code>（区间）和 <code>^</code>（非）。</p><ul><li><code>[a-z]</code> 表示从小写字母 <code>a</code> 到小写字母 <code>z</code> 中的任意一个字符。</li><li><code>[^abc]</code> 表示 <code>abc</code> 以外的其它任意字符，即，非 <code>[abc]</code>。</li></ul><p>注意，一个集合原子中，<code>^</code> 符号只能用一次，只能紧跟在 <code>[</code> 之后。否则不起作用。</p><h3 id="类别原子"><a href="#类别原子" class="headerlink" title="类别原子"></a>类别原子</h3><p>类别原子，是指那些能够代表 “一类字符” 的原子，它们都得使用转义符号再加上另外一个符号表达，包括：</p><p><code>\d</code> 任意数字；等价于 <code>[0-9]</code></p><p><code>\D</code> 任意非数字；等价于 <code>[^0-9]</code></p><p><code>\w</code> 任意本义字符；等价于 <code>[a-zA-Z0-9_]</code></p><p><code>\W</code> 任意非本义字符；等价于 <code>[^a-zA-Z0-9_]</code></p><p><code>\s</code> 任意空白；相当于 <code>[ \f\n\r\t\v]</code>（注意，方括号内第一个字符是空格符号）</p><p><code>\S</code> 任意非空白；相当于 <code>[^ \f\n\r\t\v]</code>（注意，紧随 <code>^</code> 之后的是一个空格符号）</p><p><code>.</code> 除 <code>\r</code> <code>\n</code> 之外的任意字符；相当于 <code>[^\r\n]</code></p><p>类别原子挺好记忆的，如果你知道各个字母是哪个词的首字母的话：</p><blockquote><ul><li><code>d</code> 是 digits</li><li><code>w</code> 是 word characters</li><li><code>s</code> 是 spaces</li></ul></blockquote><p>另外，在空白的集合 <code>[ \f\n\r\t\v]</code> 中：<code>\f</code> 是分页符；<code>\n</code> <code>\r</code> 是换行符；<code>\t</code> 是制表符；<code>\v</code> 是纵向制表符（很少用到）。各种关于空白的转义符也同样挺好记忆的，如果你知道各个字母是那个词的首字母的话：</p><blockquote><ul><li><code>f</code> 是 flip</li><li><code>n</code> 是 new line</li><li><code>r</code> 是 return</li><li><code>t</code> 是 tab</li><li><code>v</code> 是 vertical tab</li></ul></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">str = <span class="string">'&lt;dl&gt;(843) 542-4256&lt;/dl&gt; &lt;dl&gt;(431) 270-9664&lt;/dl&gt;'</span></span><br><span class="line">pttn = <span class="string">r'\d\d\d\-'</span></span><br><span class="line">re.findall(pttn, str)</span><br></pre></td></tr></table></figure><pre><code>[&apos;542-&apos;, &apos;270-&apos;]</code></pre><h3 id="边界原子"><a href="#边界原子" class="headerlink" title="边界原子"></a>边界原子</h3><p>我们可以用边界原子指定边界。也可以称作 “定位操作符”。</p><p><code>^</code> 匹配被搜索字符串的开始位置；</p><p><code>$</code> 匹配被搜索字符串的结束位置；</p><p><code>\b</code> 匹配单词的边界；<a href="https://regexper.com#er%5Cb" target="_blank" rel="noopener"><code>er\b</code></a>，能匹配 <code>coder</code> 中的 <code>er</code>，却不能匹配 <code>error</code> 中的 <code>er</code>；</p><p><code>\B</code> 匹配非单词边界；<a href="https://regexper.com#er%5CB" target="_blank" rel="noopener"><code>er\B</code></a>，能匹配 <code>error</code> 中的 <code>er</code>，却不能匹配 <code>coder</code> 中的 <code>er</code>。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">str = <span class="string">'never ever verb however everest'</span></span><br><span class="line">pttn = <span class="string">r'er\b'</span></span><br><span class="line">re.findall(pttn, str)</span><br><span class="line">pttn = <span class="string">r'er\B'</span></span><br><span class="line">re.findall(pttn, str)</span><br></pre></td></tr></table></figure><pre><code>[&apos;er&apos;, &apos;er&apos;, &apos;er&apos;][&apos;er&apos;, &apos;er&apos;]</code></pre><p><strong>注意</strong>：<code>^</code> 和 <code>$</code> 在 Python 语言中被 <code>\A</code> 和 <code>\Z</code> 替代。</p><p>事实上，每种语言或多或少都对 Regex 有自己的定制。不过，本章讨论的绝大多数细节，都是通用的。</p><h3 id="组合原子"><a href="#组合原子" class="headerlink" title="组合原子"></a>组合原子</h3><p>我们可以用圆括号 <code>()</code> 将多个单字符原子组合成一个原子 —— 这么做的结果是，<code>()</code> 内的字符串将被当作一整个原子，可以被随后我们要讲解的数量操作符操作。</p><p>另外，<code>()</code> 这个操作符，有两个作用：<strong>组合</strong>（Grouping），就是我们刚刚讲到的作用；而另外一个作用是<strong>捕获</strong>（Capturing)，后面会讲到。</p><p>注意区别，<a href="https://regexper.com#er" target="_blank" rel="noopener"><code>er</code></a>、<a href="https://regexper.com#[er]" target="_blank" rel="noopener"><code>[er]</code></a> 和 <a href="https://regexper.com#(er" target="_blank" rel="noopener"><code>(er)</code></a> 各不相同。</p><blockquote><ul><li><code>er</code> 是两个原子，<code>&#39;e&#39;</code> 和紧随其后的 <code>&#39;r&#39;</code></li><li><code>[er]</code> 是一个原子，或者 <code>&#39;e&#39;</code> 或者 <code>&#39;r&#39;</code>；</li><li><code>(er)</code> 是一个原子，<code>&#39;er&#39;</code></li></ul></blockquote><p>下一节中讲到数量操作符的时候，会再次强调这点。</p><h2 id="数量操作符"><a href="#数量操作符" class="headerlink" title="数量操作符"></a>数量操作符</h2><p>数量操作符有：<code>+</code> <code>?</code> <code>*</code> <code>{n, m}</code>。</p><p>它们是用来限定位于它们之前的原子允许出现的个数；不加数量限定则代表出现一次且仅出现一次：</p><p><code>+</code> 代表前面的原子必须至少出现一次，即：<code>出现次数 ≧ 1</code></p><blockquote><p>例如，<a href="https://regexper.com#go+gle" target="_blank" rel="noopener"><code>go+gle</code></a>可以匹配 <code>google</code> <code>gooogle</code> <code>goooogle</code> 等；</p></blockquote><p><code>?</code> 代表前面的原子最多只可以出现一次，即：<code>0 ≦ 出现次数 ≦ 1</code></p><blockquote><p>例如，<a href="https://regexper.com#colou?red" target="_blank" rel="noopener"><code>colou?red</code></a>可以匹配 <code>colored</code> 或者 <code>coloured</code>;</p></blockquote><p><code>*</code> 代表前面的原子可以不出现，也可以出现一次或者多次，即：<code>出现次数 ≧ 0</code></p><blockquote><p>例如，<a href="https://regexper.com#520*" target="_blank" rel="noopener"><code>520*</code></a>可以匹配 <code>52</code> <code>520</code> <code>52000</code> <code>5200000</code> <code>520000000000</code> 等。</p></blockquote><p><code>{n}</code> 之前的原子出现确定的 <code>n</code> 次；</p><p><code>{n,}</code> 之前的原子出现至少 <code>n</code> 次；</p><p><code>{n, m}</code> 之前的原子出现至少 <code>n</code> 次，至多 <code>m</code> 次</p><blockquote><p>例如，<a href="https://regexper.com#go%7B2,5%7Dgle" target="_blank" rel="noopener"><code>go{2,5}gle</code></a>，能匹配 <code>google</code> <code>gooogle</code> <code>goooogle</code> 或 <code>gooooogle</code>，但不能匹配 <code>gogle</code> 和 <code>gooooooogle</code></p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> IPython.core.interactiveshell <span class="keyword">import</span> InteractiveShell</span><br><span class="line">InteractiveShell.ast_node_interactivity = <span class="string">"all"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'regex-target-text-sample.txt'</span>, <span class="string">'r'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    str = f.read()</span><br><span class="line"></span><br><span class="line">pttn = <span class="string">r'go+gle'</span></span><br><span class="line">re.findall(pttn, str)</span><br><span class="line"></span><br><span class="line">pttn = <span class="string">r'go&#123;2,5&#125;gle'</span></span><br><span class="line">re.findall(pttn, str)</span><br><span class="line"></span><br><span class="line">pttn = <span class="string">r'colou?red'</span></span><br><span class="line">re.findall(pttn, str)</span><br><span class="line"></span><br><span class="line">pttn = <span class="string">r'520*'</span></span><br><span class="line">re.findall(pttn, str)</span><br></pre></td></tr></table></figure><pre><code>[&apos;google&apos;, &apos;gooogle&apos;, &apos;goooogle&apos;, &apos;goooooogle&apos;][&apos;google&apos;, &apos;gooogle&apos;, &apos;goooogle&apos;][&apos;coloured&apos;, &apos;colored&apos;][&apos;520&apos;, &apos;52000&apos;, &apos;5200000&apos;, &apos;520000000&apos;, &apos;520000000000&apos;]</code></pre><p>数量操作符是对它之前的原子进行操作的，换言之，数量操作符的操作元是操作符之前的原子。</p><p>上一节提到，要注意区别：<code>er</code>、<code>[er]</code> 和 <code>(er)</code> 各不相同。</p><blockquote><ul><li><code>er</code> 是两个原子，<code>&#39;e&#39;</code> 之后 <code>&#39;r&#39;</code></li><li><code>[er]</code> 是一个原子，或者 <code>&#39;e&#39;</code> 或者 <code>&#39;r&#39;</code>；</li><li><code>(er)</code> 是一个原子，<code>&#39;er&#39;</code></li></ul></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> IPython.core.interactiveshell <span class="keyword">import</span> InteractiveShell</span><br><span class="line">InteractiveShell.ast_node_interactivity = <span class="string">"all"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">str = <span class="string">'error wonderer severeness'</span></span><br><span class="line"></span><br><span class="line">pttn = <span class="string">r'er'</span></span><br><span class="line">re.findall(pttn, str)</span><br><span class="line"></span><br><span class="line">pttn = <span class="string">r'[er]'</span></span><br><span class="line">re.findall(pttn, str)</span><br><span class="line"></span><br><span class="line">pttn = <span class="string">r'(er)'</span></span><br><span class="line">re.findall(pttn, str)</span><br></pre></td></tr></table></figure><pre><code>[&apos;er&apos;, &apos;er&apos;, &apos;er&apos;, &apos;er&apos;][&apos;e&apos;, &apos;r&apos;, &apos;r&apos;, &apos;r&apos;, &apos;e&apos;, &apos;r&apos;, &apos;e&apos;, &apos;r&apos;, &apos;e&apos;, &apos;e&apos;, &apos;r&apos;, &apos;e&apos;, &apos;e&apos;][&apos;er&apos;, &apos;er&apos;, &apos;er&apos;, &apos;er&apos;]</code></pre><p>在以上的例子中，看不出 <code>er</code> 和 <code>(er)</code> 的区别，但是，加上数量操作符就不一样了 —— 因为<em>数量操作符只对它之前的那一个原子进行操作</em>：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> IPython.core.interactiveshell <span class="keyword">import</span> InteractiveShell</span><br><span class="line">InteractiveShell.ast_node_interactivity = <span class="string">"all"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">str = <span class="string">'error wonderer severeness'</span></span><br><span class="line"></span><br><span class="line">pttn = <span class="string">r'er+'</span></span><br><span class="line">re.findall(pttn, str)</span><br><span class="line"></span><br><span class="line">pttn = <span class="string">r'[er]+'</span></span><br><span class="line">re.findall(pttn, str)</span><br><span class="line"></span><br><span class="line">pttn = <span class="string">r'(er)+'</span></span><br><span class="line">re.findall(pttn, str)</span><br></pre></td></tr></table></figure><pre><code>[&apos;err&apos;, &apos;er&apos;, &apos;er&apos;, &apos;er&apos;][&apos;err&apos;, &apos;r&apos;, &apos;erer&apos;, &apos;e&apos;, &apos;ere&apos;, &apos;e&apos;][&apos;er&apos;, &apos;er&apos;, &apos;er&apos;]</code></pre><h2 id="或操作符"><a href="#或操作符" class="headerlink" title="或操作符 |"></a>或操作符 <code>|</code></h2><p>或操作符 <code>|</code> 是所有操作符中优先级最低的，数量操作符的优先级比它高，所以，在 <code>|</code> 前后的原子被数量操作符（如果有的话）操作之后才交给 <code>|</code> 操作。</p><p>于是，<a href="https://regexper.com#begin%7Cbegan%7Cbegun" target="_blank" rel="noopener"><code>begin|began|begun</code></a> 能够匹配 <code>begin</code> 或 <code>began</code> 或 <code>begun</code>。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">str = <span class="string">'begin began begun begins beginn'</span></span><br><span class="line">pttn = <span class="string">r'begin|began|begun'</span></span><br><span class="line">re.findall(pttn, str)</span><br></pre></td></tr></table></figure><pre><code>[&apos;begin&apos;, &apos;began&apos;, &apos;begun&apos;, &apos;begin&apos;, &apos;begin&apos;]</code></pre><p>在集合原子中（即，<code>[]</code> 内的原子）各个原子之间的关系，只有 “或” —— 相当于方括号中的每个原子之间都有一个被省略的 <code>|</code>。</p><p><strong>注意</strong>：方括号的 <code>|</code> 不被当作特殊符号，而是被当作 <code>|</code> 这个符号本身。在方括号中的圆括号，也被当作圆括号 <code>()</code> 本身，而无分组含义。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> IPython.core.interactiveshell <span class="keyword">import</span> InteractiveShell</span><br><span class="line">InteractiveShell.ast_node_interactivity = <span class="string">"all"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">str = <span class="string">'achroiocythaemia achroiocythemia a|e'</span></span><br><span class="line">pttn = <span class="string">r'[a|ae]'</span></span><br><span class="line">re.findall(pttn, str)</span><br><span class="line"></span><br><span class="line">pttn = <span class="string">r'[a|e]'</span></span><br><span class="line">re.findall(pttn, str)</span><br><span class="line"></span><br><span class="line">pttn = <span class="string">r'[ae]'</span></span><br><span class="line">re.findall(pttn, str)</span><br><span class="line"></span><br><span class="line">pttn = <span class="string">r'[(ae)]'</span></span><br><span class="line">re.findall(pttn, str)</span><br><span class="line"></span><br><span class="line">pttn = <span class="string">r'[a|ae|(ae)]'</span></span><br><span class="line">re.findall(pttn, str)</span><br></pre></td></tr></table></figure><pre><code>[&apos;a&apos;, &apos;a&apos;, &apos;e&apos;, &apos;a&apos;, &apos;a&apos;, &apos;e&apos;, &apos;a&apos;, &apos;a&apos;, &apos;|&apos;, &apos;e&apos;]</code></pre><h2 id="匹配并捕获"><a href="#匹配并捕获" class="headerlink" title="匹配并捕获"></a>匹配并捕获</h2><p>捕获（Capture），使用的是圆括号 <code>()</code>。使用圆括号得到的匹配的值被暂存成一个带有索引的列表，第一个是 <code>$1</code>，第二个是 <code>$2</code>…… 以此类推。随后，我们可以在替换的过程中使用 <code>$1</code> <code>$2</code> 中所保存的值。</p><p><strong>注意</strong>：在 Python 语言中调用 <code>re</code> 模块之后，在 <code>re.sub()</code> 中调用被匹配的值，用的索引方法是 <code>\1</code>、<code>\2</code>…… 以此类推。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line">str = <span class="string">'The white dog wears a black hat.'</span></span><br><span class="line">pttn = <span class="string">r'The (white|black) dog wears a (white|black) hat.'</span></span><br><span class="line">re.findall(pttn, str)</span><br><span class="line"></span><br><span class="line">repl = <span class="string">r'The \2 dog wears a \1 hat.'</span></span><br><span class="line">re.sub(pttn, repl, str)</span><br><span class="line"></span><br><span class="line">repl = <span class="string">r'The \1 dog wears a \1 hat.'</span></span><br><span class="line">re.sub(pttn, repl, str)</span><br></pre></td></tr></table></figure><pre><code>[(&apos;white&apos;, &apos;black&apos;)]&apos;The black dog wears a white hat.&apos;&apos;The white dog wears a white hat.&apos;</code></pre><h2 id="非捕获匹配"><a href="#非捕获匹配" class="headerlink" title="非捕获匹配"></a>非捕获匹配</h2><p>有时，你并不想捕获圆括号中的内容，在那个地方你使用括号的目的只是分组，而非捕获，那么，你就在圆括号内最开头加上 <code>?:</code> —— <code>(?:...)</code>：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line">str = <span class="string">'The white dog wears a black hat.'</span></span><br><span class="line">pttn = <span class="string">r'The (?:white|black) dog wears a (white|black) hat.'</span></span><br><span class="line">re.findall(pttn, str)                   <span class="comment"># 只捕获了一处，也就是说只有一个值将来可以被引用</span></span><br><span class="line"></span><br><span class="line">repl = <span class="string">r'The \1 dog wears a \1 hat.'</span>    <span class="comment"># 之前的一处捕获，在替换时可被多次引用</span></span><br><span class="line">書評</span><br><span class="line">re.sub(pttn, repl, str)</span><br></pre></td></tr></table></figure><pre><code>[&apos;black&apos;]&apos;The black dog wears a black hat.&apos;</code></pre><p>在 Python 代码中使用正则表达式，匹配和捕获以及随后的替换，有更灵活的方式，因为可以对那些值直接编程。<code>re.sub()</code> 中，<code>repl</code> 参数甚至可以接收另外一个函数作为参数 —— 以后你肯定会自行认真阅读以下页面中的所有内容：</p><blockquote><p><a href="https://docs.python.org/3/library/re.html" target="_blank" rel="noopener">https://docs.python.org/3/library/re.html</a></p></blockquote><p>非捕获匹配，还有若干个操作符：</p><p> <code>(?=pattern)</code></p><blockquote><p>正向肯定预查（look ahead positive assert），在任何匹配规则的字符串开始处匹配查找字符串。这是一个非获取匹配，也就是说，该匹配不需要获取供以后使用。例如，<a href="https://regexper.com#%60Windows(?=95%7C98%7CNT%7C2000)%60" target="_blank" rel="noopener"><code>Windows(?=95|98|NT|2000)</code></a><br>能匹配 <code>Windows2000</code> 中的 <code>Windows</code>，但不能匹配 <code>Windows3.1</code> 中的 <code>Windows</code>。预查不消耗字符，也就是说，在一个匹配发生后，在最后一次匹配之后立即开始下一次匹配的搜索，而不是从包含预查的字符之后开始。</p></blockquote><p><code>(?!pattern)</code></p><blockquote><p>正向否定预查（negative assert），在任何不匹配规则的字符串开始处匹配查找字符串。这是一个非获取匹配，也就是说，该匹配不需要获取供以后使用。例如<a href="https://regexper.com#Windows(?=95%7C98%7CNT%7C2000)" target="_blank" rel="noopener"><code>Windows(?!95|98|NT|2000)</code></a><br>能匹配 <code>Windows3.1</code> 中的 <code>Windows</code>，但不能匹配 <code>Windows2000</code> 中的 <code>Windows</code>。预查不消耗字符，也就是说，在一个匹配发生后，在最后一次匹配之后立即开始下一次匹配的搜索，而不是从包含预查的字符之后开始。</p></blockquote><p><code>(?&lt;=pattern)</code></p><blockquote><p>反向（look behind）肯定预查，与正向肯定预查类似，只是方向相反。例如，<a href="https://regexper.com#(?%3C=95%7C98%7CNT%7C2000)Windows" target="_blank" rel="noopener"><code>(?&lt;=95|98|NT|2000)Windows</code></a><br>能匹配 <code>2000Windows</code> 中的 <code>Windows</code>，但不能匹配 <code>3.1Windows</code> 中的 <code>Windows</code>。</p></blockquote><p> <code>(?&lt;!pattern)</code></p><blockquote><p>反向否定预查，与正向否定预查类似，只是方向相反。例如 <code>(?&lt;!95|98|NT|2000)Windows</code><br>能匹配 <code>3.1Windows</code> 中的 <code>Windows</code>，但不能匹配 <code>2000Windows</code> 中的 <code>Windows</code>。</p></blockquote><h2 id="控制标记"><a href="#控制标记" class="headerlink" title="控制标记"></a>控制标记</h2><p>有几个全局控制标记（Flag）需要了解，其中最常默认指定的有 <code>G</code> 和 <code>M</code>：</p><p><code>A</code>/<code>ASCII</code>，默认为 <code>False</code></p><blockquote><ul><li><code>\d</code>, <code>\D</code>, <code>\w</code>, <code>\W</code>, <code>\s</code>, <code>\S</code>, <code>\b</code>, 和 <code>\B</code> 等只限于 ASCII 字符</li><li>行内写法：<code>(?a)</code></li><li>Python re 模块中的常量：<code>re.A</code> <code>re.ASCII</code></li></ul></blockquote><p><code>I</code>/<code>IGNORECASE</code>，默认为 <code>False</code></p><blockquote><ul><li>忽略字母大小写</li><li>行内写法：<code>(?i)</code></li><li>Python re 模块中的常量：<code>re.I</code> <code>re.IGNORECASE</code></li></ul></blockquote><p><code>G</code>/<code>GLOBAL</code>，默认为 <code>True</code></p><blockquote><ul><li>找到第一个 match 之后不返回</li><li>行内写法：<code>(?g)</code></li><li>Python re 模块中这个标记不能更改，默认为 TRUE</li></ul></blockquote><p><code>L</code>/<code>LOCALE</code>，默认为 <code>False</code></p><blockquote><ul><li>由本地语言设置决定 <code>\d</code>, <code>\D</code>, <code>\w</code>, <code>\W</code>, <code>\s</code>, <code>\S</code>, <code>\b</code>, 和 <code>\B</code> 等等的内容</li><li>行内写法：<code>(?L)</code></li><li>Python re 模块中的常量：<code>re.L</code> <code>re.LOCALE</code></li></ul></blockquote><p><code>M</code>/<code>MULTILINE</code>，默认为 <code>True</code></p><blockquote><ul><li>使用本标志后，<code>^</code> 和 <code>$</code> 匹配行首和行尾时，会增加换行符之前和之后的位置。</li><li>行内写法：<code>(?m)</code></li><li>Python re 模块中的常量：<code>re.M</code> <code>re.MULTILINE</code></li></ul></blockquote><p><code>S</code>/<code>DOTALL</code>，默认为 <code>False</code></p><blockquote><ul><li>使 <code>.</code> 完全匹配任何字符，包括换行；没有这个标志，<code>.</code> 匹配除了 <code>n</code> <code>r</code> 之外的任何字符。</li><li>行内写法：<code>(?s)</code></li><li>Python re 模块中的常量：<code>re.S</code> <code>re.DOTALL</code></li></ul></blockquote><p><code>X</code>/<code>VERBOSE</code>，默认为 <code>False</code></p><blockquote><ul><li>当该标志被指定时，Pattern 中的的空白符会被忽略，除非该空白符在圆括号或方括号中，或在反斜杠 <code>\</code> 之后。这样做的结果是允许将注释写入 Pattern，这些注释会被 Regex 解析引擎忽略。注释用 <code>#</code> 号来标识，不过该符号不能在字符串或反斜杠之后。</li><li>行内写法：<code>(?x)</code></li><li>Python re 模块中的常量：<code>re.X</code> <code>re.VERBOSE</code></li></ul></blockquote><h2 id="几个最常用的-Regex"><a href="#几个最常用的-Regex" class="headerlink" title="几个最常用的 Regex"></a>几个最常用的 Regex</h2><p>以下是几个常用的 Regex<a href="#fn2" name="fn2b"><sup>[2]</sup></a>，值得保存：</p><ul><li><p>matching username</p><blockquote><p><a href="https://regexper.com#/%5E[a-z0-9_-]%7B3,16%7D$/" target="_blank" rel="noopener"><code>/^[a-z0-9_-]{3,16}$/</code></a></p></blockquote></li><li><p>matching password<a href="#fn3" name="fn3b"><sup>[3]</sup></a></p><blockquote><p><a href="https://regexper.com#/%5E[a-z0-9_-]%7B6,18%7D$/" target="_blank" rel="noopener"><code>/^[a-z0-9_-]{6,18}$/</code></a></p></blockquote></li><li><p>matching a HEX value</p><blockquote><p><a href="https://regexper.com#/%5E#?([a-f0-9]%7B6%7D%7C[a-f0-9]%7B3%7D)$/" target="_blank" rel="noopener"><code>/^#?([a-f0-9]{6}|[a-f0-9]{3})$/</code></a></p></blockquote></li><li><p>matching a slug</p><blockquote><p><a href="https://regexper.com#/%5E[a-z0-9-]+$/" target="_blank" rel="noopener"><code>/^[a-z0-9-]+$/</code></a></p></blockquote></li><li><p>matching email address</p><blockquote><p><a href="https://regexper.com#/%5E([a-z0-9_%5C.-]+)@([%5Cda-z%5C.-]+)%5C.([a-z%5C.]%7B2,6%7D)$/" target="_blank" rel="noopener"><code>/^([a-z0-9_\.-]+)@([\da-z\.-]+)\.([a-z\.]{2,6})$/</code></a></p></blockquote></li><li><p>matching a URL</p><blockquote><p><a href="https://regexper.com#/%5E(https?:%5C/%5C/)?([%5Cda-z%5C.-]+)%5C.([a-z%5C.]%7B2,6%7D)([%5C/%5Cw%20%5C.-]*)*%5C/?$/" target="_blank" rel="noopener"><code>/^(https?:\/\/)?([\da-z\.-]+)\.([a-z\.]{2,6})([\/\w \.-]*)*\/?$/</code></a></p></blockquote></li><li><p>matching an IP address</p><blockquote><p><a href="https://regexper.com/#%2F%5E%28%3F%3A%28%3F%3A25%5B0-5%5D%7C2%5B0-4%5D%5B0-9%5D%7C%5B01%5D%3F%5B0-9%5D%5B0-9%5D%3F%29%5C.%29%7B3%7D%28%3F%3A25%5B0-5%5D%7C2%5B0-4%5D%5B0-9%5D%7C%5B01%5D%3F%5B0-9%5D%5B0-9%5D%3F%29%24%2F" target="_blank" rel="noopener"><code>/^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/</code></a></p></blockquote></li><li><p>matching a HTML tag</p><blockquote><p><a href="https://regexper.com/#%2F%5E<%28%5Ba-z%5D%2B%29%28%5B%5E<%5D%2B%29*%28%3F%3A>%28.*%29<%5C%2F%5C1>%7C%5Cs%2B%5C%2F>%29%24%2F" target="_blank" rel="noopener"><code>/^&lt;([a-z]+)([^&lt;]+)*(?:&gt;(.*)&lt;\/\1&gt;|\s+\/&gt;)$/</code></a></p></blockquote></li></ul><p>对了，告诉你一个小秘密：</p><blockquote><p>以上的正则表达式，点击都能连接到 <a href="https://regexper.com" target="_blank" rel="noopener">regexper.com</a>，在那里你能查看这些正则表达式的图形化示意图。另外，本文中，处于 markdown cell 的绝大多数正则表达式都有这样的连接…… 你可以重读的时候试试。</p></blockquote><p>写 Regex 最烧脑的地方在于 “使其全面” —— 要考虑到各种意外情况。</p><p>当然，除非必要，也不要在 “全面” 这事上面花太多时间 —— 给你看一个据说是 “最大程度上能够匹配所有 email 地址的 Regex” <a href="#fn4" name="fn4b"><sup>[4]</sup></a>，我都懒得测试的一个正则表达式：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">(?:(?:\r\n)?[ \t])*(?:(?:(?:[^()&lt;&gt;@,;:\\&quot;.\[\] \000-\031]+(?:(?:(?:\r\n)?[ \t]</span><br><span class="line">)+|\Z|(?=[\[&quot;()&lt;&gt;@,;:\\&quot;.\[\]]))|&quot;(?:[^\&quot;\r\\]|\\.|(?:(?:\r\n)?[ \t]))*&quot;(?:(?:</span><br><span class="line">\r\n)?[ \t])*)(?:\.(?:(?:\r\n)?[ \t])*(?:[^()&lt;&gt;@,;:\\&quot;.\[\] \000-\031]+(?:(?:(</span><br><span class="line">?:\r\n)?[ \t])+|\Z|(?=[\[&quot;()&lt;&gt;@,;:\\&quot;.\[\]]))|&quot;(?:[^\&quot;\r\\]|\\.|(?:(?:\r\n)?[</span><br><span class="line">\t]))*&quot;(?:(?:\r\n)?[ \t])*))*@(?:(?:\r\n)?[ \t])*(?:[^()&lt;&gt;@,;:\\&quot;.\[\] \000-\0</span><br><span class="line">31]+(?:(?:(?:\r\n)?[ \t])+|\Z|(?=[\[&quot;()&lt;&gt;@,;:\\&quot;.\[\]]))|\[([^\[\]\r\\]|\\.)*\</span><br><span class="line">](?:(?:\r\n)?[ \t])*)(?:\.(?:(?:\r\n)?[ \t])*(?:[^()&lt;&gt;@,;:\\&quot;.\[\] \000-\031]+</span><br><span class="line">(?:(?:(?:\r\n)?[ \t])+|\Z|(?=[\[&quot;()&lt;&gt;@,;:\\&quot;.\[\]]))|\[([^\[\]\r\\]|\\.)*\](?:</span><br><span class="line">(?:\r\n)?[ \t])*))*|(?:[^()&lt;&gt;@,;:\\&quot;.\[\] \000-\031]+(?:(?:(?:\r\n)?[ \t])+|\Z</span><br><span class="line">|(?=[\[&quot;()&lt;&gt;@,;:\\&quot;.\[\]]))|&quot;(?:[^\&quot;\r\\]|\\.|(?:(?:\r\n)?[ \t]))*&quot;(?:(?:\r\n)</span><br><span class="line">?[ \t])*)*\&lt;(?:(?:\r\n)?[ \t])*(?:@(?:[^()&lt;&gt;@,;:\\&quot;.\[\] \000-\031]+(?:(?:(?:\</span><br><span class="line">r\n)?[ \t])+|\Z|(?=[\[&quot;()&lt;&gt;@,;:\\&quot;.\[\]]))|\[([^\[\]\r\\]|\\.)*\](?:(?:\r\n)?[</span><br><span class="line"> \t])*)(?:\.(?:(?:\r\n)?[ \t])*(?:[^()&lt;&gt;@,;:\\&quot;.\[\] \000-\031]+(?:(?:(?:\r\n)</span><br><span class="line">?[ \t])+|\Z|(?=[\[&quot;()&lt;&gt;@,;:\\&quot;.\[\]]))|\[([^\[\]\r\\]|\\.)*\](?:(?:\r\n)?[ \t]</span><br><span class="line">)*))*(?:,@(?:(?:\r\n)?[ \t])*(?:[^()&lt;&gt;@,;:\\&quot;.\[\] \000-\031]+(?:(?:(?:\r\n)?[</span><br><span class="line"> \t])+|\Z|(?=[\[&quot;()&lt;&gt;@,;:\\&quot;.\[\]]))|\[([^\[\]\r\\]|\\.)*\](?:(?:\r\n)?[ \t])*</span><br><span class="line">)(?:\.(?:(?:\r\n)?[ \t])*(?:[^()&lt;&gt;@,;:\\&quot;.\[\] \000-\031]+(?:(?:(?:\r\n)?[ \t]</span><br><span class="line">)+|\Z|(?=[\[&quot;()&lt;&gt;@,;:\\&quot;.\[\]]))|\[([^\[\]\r\\]|\\.)*\](?:(?:\r\n)?[ \t])*))*)</span><br><span class="line">*:(?:(?:\r\n)?[ \t])*)?(?:[^()&lt;&gt;@,;:\\&quot;.\[\] \000-\031]+(?:(?:(?:\r\n)?[ \t])+</span><br><span class="line">|\Z|(?=[\[&quot;()&lt;&gt;@,;:\\&quot;.\[\]]))|&quot;(?:[^\&quot;\r\\]|\\.|(?:(?:\r\n)?[ \t]))*&quot;(?:(?:\r</span><br><span class="line">\n)?[ \t])*)(?:\.(?:(?:\r\n)?[ \t])*(?:[^()&lt;&gt;@,;:\\&quot;.\[\] \000-\031]+(?:(?:(?:</span><br><span class="line">\r\n)?[ \t])+|\Z|(?=[\[&quot;()&lt;&gt;@,;:\\&quot;.\[\]]))|&quot;(?:[^\&quot;\r\\]|\\.|(?:(?:\r\n)?[ \t</span><br><span class="line">]))*&quot;(?:(?:\r\n)?[ \t])*))*@(?:(?:\r\n)?[ \t])*(?:[^()&lt;&gt;@,;:\\&quot;.\[\] \000-\031</span><br><span class="line">]+(?:(?:(?:\r\n)?[ \t])+|\Z|(?=[\[&quot;()&lt;&gt;@,;:\\&quot;.\[\]]))|\[([^\[\]\r\\]|\\.)*\](</span><br><span class="line">?:(?:\r\n)?[ \t])*)(?:\.(?:(?:\r\n)?[ \t])*(?:[^()&lt;&gt;@,;:\\&quot;.\[\] \000-\031]+(?</span><br><span class="line">:(?:(?:\r\n)?[ \t])+|\Z|(?=[\[&quot;()&lt;&gt;@,;:\\&quot;.\[\]]))|\[([^\[\]\r\\]|\\.)*\](?:(?</span><br><span class="line">:\r\n)?[ \t])*))*\&gt;(?:(?:\r\n)?[ \t])*)|(?:[^()&lt;&gt;@,;:\\&quot;.\[\] \000-\031]+(?:(?</span><br><span class="line">:(?:\r\n)?[ \t])+|\Z|(?=[\[&quot;()&lt;&gt;@,;:\\&quot;.\[\]]))|&quot;(?:[^\&quot;\r\\]|\\.|(?:(?:\r\n)?</span><br><span class="line">[ \t]))*&quot;(?:(?:\r\n)?[ \t])*)*:(?:(?:\r\n)?[ \t])*(?:(?:(?:[^()&lt;&gt;@,;:\\&quot;.\[\]</span><br><span class="line">\000-\031]+(?:(?:(?:\r\n)?[ \t])+|\Z|(?=[\[&quot;()&lt;&gt;@,;:\\&quot;.\[\]]))|&quot;(?:[^\&quot;\r\\]|</span><br><span class="line">\\.|(?:(?:\r\n)?[ \t]))*&quot;(?:(?:\r\n)?[ \t])*)(?:\.(?:(?:\r\n)?[ \t])*(?:[^()&lt;&gt;</span><br><span class="line">@,;:\\&quot;.\[\] \000-\031]+(?:(?:(?:\r\n)?[ \t])+|\Z|(?=[\[&quot;()&lt;&gt;@,;:\\&quot;.\[\]]))|&quot;</span><br><span class="line">(?:[^\&quot;\r\\]|\\.|(?:(?:\r\n)?[ \t]))*&quot;(?:(?:\r\n)?[ \t])*))*@(?:(?:\r\n)?[ \t]</span><br><span class="line">)*(?:[^()&lt;&gt;@,;:\\&quot;.\[\] \000-\031]+(?:(?:(?:\r\n)?[ \t])+|\Z|(?=[\[&quot;()&lt;&gt;@,;:\\</span><br><span class="line">&quot;.\[\]]))|\[([^\[\]\r\\]|\\.)*\](?:(?:\r\n)?[ \t])*)(?:\.(?:(?:\r\n)?[ \t])*(?</span><br><span class="line">:[^()&lt;&gt;@,;:\\&quot;.\[\] \000-\031]+(?:(?:(?:\r\n)?[ \t])+|\Z|(?=[\[&quot;()&lt;&gt;@,;:\\&quot;.\[</span><br><span class="line">\]]))|\[([^\[\]\r\\]|\\.)*\](?:(?:\r\n)?[ \t])*))*|(?:[^()&lt;&gt;@,;:\\&quot;.\[\] \000-</span><br><span class="line">\031]+(?:(?:(?:\r\n)?[ \t])+|\Z|(?=[\[&quot;()&lt;&gt;@,;:\\&quot;.\[\]]))|&quot;(?:[^\&quot;\r\\]|\\.|(</span><br><span class="line">?:(?:\r\n)?[ \t]))*&quot;(?:(?:\r\n)?[ \t])*)*\&lt;(?:(?:\r\n)?[ \t])*(?:@(?:[^()&lt;&gt;@,;</span><br><span class="line">:\\&quot;.\[\] \000-\031]+(?:(?:(?:\r\n)?[ \t])+|\Z|(?=[\[&quot;()&lt;&gt;@,;:\\&quot;.\[\]]))|\[([</span><br><span class="line">^\[\]\r\\]|\\.)*\](?:(?:\r\n)?[ \t])*)(?:\.(?:(?:\r\n)?[ \t])*(?:[^()&lt;&gt;@,;:\\&quot;</span><br><span class="line">.\[\] \000-\031]+(?:(?:(?:\r\n)?[ \t])+|\Z|(?=[\[&quot;()&lt;&gt;@,;:\\&quot;.\[\]]))|\[([^\[\</span><br><span class="line">]\r\\]|\\.)*\](?:(?:\r\n)?[ \t])*))*(?:,@(?:(?:\r\n)?[ \t])*(?:[^()&lt;&gt;@,;:\\&quot;.\</span><br><span class="line">[\] \000-\031]+(?:(?:(?:\r\n)?[ \t])+|\Z|(?=[\[&quot;()&lt;&gt;@,;:\\&quot;.\[\]]))|\[([^\[\]\</span><br><span class="line">r\\]|\\.)*\](?:(?:\r\n)?[ \t])*)(?:\.(?:(?:\r\n)?[ \t])*(?:[^()&lt;&gt;@,;:\\&quot;.\[\]</span><br><span class="line">\000-\031]+(?:(?:(?:\r\n)?[ \t])+|\Z|(?=[\[&quot;()&lt;&gt;@,;:\\&quot;.\[\]]))|\[([^\[\]\r\\]</span><br><span class="line">|\\.)*\](?:(?:\r\n)?[ \t])*))*)*:(?:(?:\r\n)?[ \t])*)?(?:[^()&lt;&gt;@,;:\\&quot;.\[\] \0</span><br><span class="line">00-\031]+(?:(?:(?:\r\n)?[ \t])+|\Z|(?=[\[&quot;()&lt;&gt;@,;:\\&quot;.\[\]]))|&quot;(?:[^\&quot;\r\\]|\\</span><br><span class="line">.|(?:(?:\r\n)?[ \t]))*&quot;(?:(?:\r\n)?[ \t])*)(?:\.(?:(?:\r\n)?[ \t])*(?:[^()&lt;&gt;@,</span><br><span class="line">;:\\&quot;.\[\] \000-\031]+(?:(?:(?:\r\n)?[ \t])+|\Z|(?=[\[&quot;()&lt;&gt;@,;:\\&quot;.\[\]]))|&quot;(?</span><br><span class="line">:[^\&quot;\r\\]|\\.|(?:(?:\r\n)?[ \t]))*&quot;(?:(?:\r\n)?[ \t])*))*@(?:(?:\r\n)?[ \t])*</span><br><span class="line">(?:[^()&lt;&gt;@,;:\\&quot;.\[\] \000-\031]+(?:(?:(?:\r\n)?[ \t])+|\Z|(?=[\[&quot;()&lt;&gt;@,;:\\&quot;.</span><br><span class="line">\[\]]))|\[([^\[\]\r\\]|\\.)*\](?:(?:\r\n)?[ \t])*)(?:\.(?:(?:\r\n)?[ \t])*(?:[</span><br><span class="line">^()&lt;&gt;@,;:\\&quot;.\[\] \000-\031]+(?:(?:(?:\r\n)?[ \t])+|\Z|(?=[\[&quot;()&lt;&gt;@,;:\\&quot;.\[\]</span><br><span class="line">]))|\[([^\[\]\r\\]|\\.)*\](?:(?:\r\n)?[ \t])*))*\&gt;(?:(?:\r\n)?[ \t])*)(?:,\s*(</span><br><span class="line">?:(?:[^()&lt;&gt;@,;:\\&quot;.\[\] \000-\031]+(?:(?:(?:\r\n)?[ \t])+|\Z|(?=[\[&quot;()&lt;&gt;@,;:\\</span><br><span class="line">&quot;.\[\]]))|&quot;(?:[^\&quot;\r\\]|\\.|(?:(?:\r\n)?[ \t]))*&quot;(?:(?:\r\n)?[ \t])*)(?:\.(?:(</span><br><span class="line">?:\r\n)?[ \t])*(?:[^()&lt;&gt;@,;:\\&quot;.\[\] \000-\031]+(?:(?:(?:\r\n)?[ \t])+|\Z|(?=[</span><br><span class="line">\[&quot;()&lt;&gt;@,;:\\&quot;.\[\]]))|&quot;(?:[^\&quot;\r\\]|\\.|(?:(?:\r\n)?[ \t]))*&quot;(?:(?:\r\n)?[ \t</span><br><span class="line">])*))*@(?:(?:\r\n)?[ \t])*(?:[^()&lt;&gt;@,;:\\&quot;.\[\] \000-\031]+(?:(?:(?:\r\n)?[ \t</span><br><span class="line">])+|\Z|(?=[\[&quot;()&lt;&gt;@,;:\\&quot;.\[\]]))|\[([^\[\]\r\\]|\\.)*\](?:(?:\r\n)?[ \t])*)(?</span><br><span class="line">:\.(?:(?:\r\n)?[ \t])*(?:[^()&lt;&gt;@,;:\\&quot;.\[\] \000-\031]+(?:(?:(?:\r\n)?[ \t])+|</span><br><span class="line">\Z|(?=[\[&quot;()&lt;&gt;@,;:\\&quot;.\[\]]))|\[([^\[\]\r\\]|\\.)*\](?:(?:\r\n)?[ \t])*))*|(?:</span><br><span class="line">[^()&lt;&gt;@,;:\\&quot;.\[\] \000-\031]+(?:(?:(?:\r\n)?[ \t])+|\Z|(?=[\[&quot;()&lt;&gt;@,;:\\&quot;.\[\</span><br><span class="line">]]))|&quot;(?:[^\&quot;\r\\]|\\.|(?:(?:\r\n)?[ \t]))*&quot;(?:(?:\r\n)?[ \t])*)*\&lt;(?:(?:\r\n)</span><br><span class="line">?[ \t])*(?:@(?:[^()&lt;&gt;@,;:\\&quot;.\[\] \000-\031]+(?:(?:(?:\r\n)?[ \t])+|\Z|(?=[\[&quot;</span><br><span class="line">()&lt;&gt;@,;:\\&quot;.\[\]]))|\[([^\[\]\r\\]|\\.)*\](?:(?:\r\n)?[ \t])*)(?:\.(?:(?:\r\n)</span><br><span class="line">?[ \t])*(?:[^()&lt;&gt;@,;:\\&quot;.\[\] \000-\031]+(?:(?:(?:\r\n)?[ \t])+|\Z|(?=[\[&quot;()&lt;&gt;</span><br><span class="line">@,;:\\&quot;.\[\]]))|\[([^\[\]\r\\]|\\.)*\](?:(?:\r\n)?[ \t])*))*(?:,@(?:(?:\r\n)?[</span><br><span class="line"> \t])*(?:[^()&lt;&gt;@,;:\\&quot;.\[\] \000-\031]+(?:(?:(?:\r\n)?[ \t])+|\Z|(?=[\[&quot;()&lt;&gt;@,</span><br><span class="line">;:\\&quot;.\[\]]))|\[([^\[\]\r\\]|\\.)*\](?:(?:\r\n)?[ \t])*)(?:\.(?:(?:\r\n)?[ \t]</span><br><span class="line">)*(?:[^()&lt;&gt;@,;:\\&quot;.\[\] \000-\031]+(?:(?:(?:\r\n)?[ \t])+|\Z|(?=[\[&quot;()&lt;&gt;@,;:\\</span><br><span class="line">&quot;.\[\]]))|\[([^\[\]\r\\]|\\.)*\](?:(?:\r\n)?[ \t])*))*)*:(?:(?:\r\n)?[ \t])*)?</span><br><span class="line">(?:[^()&lt;&gt;@,;:\\&quot;.\[\] \000-\031]+(?:(?:(?:\r\n)?[ \t])+|\Z|(?=[\[&quot;()&lt;&gt;@,;:\\&quot;.</span><br><span class="line">\[\]]))|&quot;(?:[^\&quot;\r\\]|\\.|(?:(?:\r\n)?[ \t]))*&quot;(?:(?:\r\n)?[ \t])*)(?:\.(?:(?:</span><br><span class="line">\r\n)?[ \t])*(?:[^()&lt;&gt;@,;:\\&quot;.\[\] \000-\031]+(?:(?:(?:\r\n)?[ \t])+|\Z|(?=[\[</span><br><span class="line">&quot;()&lt;&gt;@,;:\\&quot;.\[\]]))|&quot;(?:[^\&quot;\r\\]|\\.|(?:(?:\r\n)?[ \t]))*&quot;(?:(?:\r\n)?[ \t])</span><br><span class="line">*))*@(?:(?:\r\n)?[ \t])*(?:[^()&lt;&gt;@,;:\\&quot;.\[\] \000-\031]+(?:(?:(?:\r\n)?[ \t])</span><br><span class="line">+|\Z|(?=[\[&quot;()&lt;&gt;@,;:\\&quot;.\[\]]))|\[([^\[\]\r\\]|\\.)*\](?:(?:\r\n)?[ \t])*)(?:\</span><br><span class="line">.(?:(?:\r\n)?[ \t])*(?:[^()&lt;&gt;@,;:\\&quot;.\[\] \000-\031]+(?:(?:(?:\r\n)?[ \t])+|\Z</span><br><span class="line">|(?=[\[&quot;()&lt;&gt;@,;:\\&quot;.\[\]]))|\[([^\[\]\r\\]|\\.)*\](?:(?:\r\n)?[ \t])*))*\&gt;(?:(</span><br><span class="line">?:\r\n)?[ \t])*))*)?;\s*)</span><br></pre></td></tr></table></figure><h2 id="趣事一则"><a href="#趣事一则" class="headerlink" title="趣事一则"></a>趣事一则</h2><p><a href="https://en.wikipedia.org/wiki/ELIZA" target="_blank" rel="noopener">ELIZA</a> 是人类史上第一个 “聊天机器人” 程序，上个世纪六十年代，1966 年实现的。核心就是使用正则表达式匹配对方语句中的关键词汇，再经过替换，形成看似有意义的 “回应” —— 事实上，ELIZA 完全不知道自己在说什么……</p><p>几年后，就是七十年代初，1972 年，另外一个聊天机器人 <a href="https://en.wikipedia.org/wiki/PARRY" target="_blank" rel="noopener">Parry</a> <a href="#fn5" name="fn5b"><sup>[5]</sup></a>被写了出来…… 随后第二年，这两个聊天机器人在 ARPANET “碰面” 好好地聊了一下<a href="#fn6" name="fn6b"><sup>[6]</sup></a>：</p><blockquote><p>ELIZA: Good Evening. Tell me your problems. Please terminate input with a period or a question mark.</p><p>PARRY: People get on my nerves sometimes.</p><p>ELIZA: I am not sure I understand you fully.</p><p>PARRY: You should pay more attention.</p><p>ELIZA: Suppose you should pay more attention.</p><p>PARRY: You’re entitled to your own opinion.</p><p>ELIZA: What makes you think I am entitled to my own opinion?</p><p>PARRY: It bothers me just to be around people in general.</p><p>ELIZA: Please go on.</p><p>PARRY: I went to the track at Bay Meadows a while back.</p><p>ELIZA: What does that suggest to you?</p><p>PARRY: I went to the races.</p><p>……</p></blockquote><p>以下是后人用 Python 重新实现的 ELIZA 的程序代码，你可以直接执行它，尝试一下与 ELIZA 聊聊天：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># %load https://raw.githubusercontent.com/jezhiggins/eliza.py/master/eliza.py</span></span><br><span class="line"><span class="comment">#----------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">#  eliza.py</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  a cheezy little Eliza knock-off by Joe Strout</span></span><br><span class="line"><span class="comment">#  with some updates by Jeff Epler</span></span><br><span class="line"><span class="comment">#  hacked into a module and updated by Jez Higgins</span></span><br><span class="line"><span class="comment">#----------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">eliza</span>:</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">    self.keys = list(map(<span class="keyword">lambda</span> x:re.compile(x[<span class="number">0</span>], re.IGNORECASE),gPats))</span><br><span class="line">    self.values = list(map(<span class="keyword">lambda</span> x:x[<span class="number">1</span>],gPats))</span><br><span class="line"></span><br><span class="line">  <span class="comment">#----------------------------------------------------------------------</span></span><br><span class="line">  <span class="comment"># translate: take a string, replace any words found in dict.keys()</span></span><br><span class="line">  <span class="comment">#  with the corresponding dict.values()</span></span><br><span class="line">  <span class="comment">#----------------------------------------------------------------------</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">translate</span><span class="params">(self,str,dict)</span>:</span></span><br><span class="line">    words = str.lower().split()</span><br><span class="line">    keys = dict.keys();</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,len(words)):</span><br><span class="line">      <span class="keyword">if</span> words[i] <span class="keyword">in</span> keys:</span><br><span class="line">        words[i] = dict[words[i]]</span><br><span class="line">    <span class="keyword">return</span> <span class="string">' '</span>.join(words)</span><br><span class="line"></span><br><span class="line">  <span class="comment">#----------------------------------------------------------------------</span></span><br><span class="line">  <span class="comment">#  respond: take a string, a set of regexps, and a corresponding</span></span><br><span class="line">  <span class="comment">#    set of response lists; find a match, and return a randomly</span></span><br><span class="line">  <span class="comment">#    chosen response from the corresponding list.</span></span><br><span class="line">  <span class="comment">#----------------------------------------------------------------------</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">respond</span><span class="params">(self,str)</span>:</span></span><br><span class="line">    <span class="comment"># find a match among keys</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>, len(self.keys)):</span><br><span class="line">      match = self.keys[i].match(str)</span><br><span class="line">      <span class="keyword">if</span> match:</span><br><span class="line">        <span class="comment"># found a match ... stuff with corresponding value</span></span><br><span class="line">        <span class="comment"># chosen randomly from among the available options</span></span><br><span class="line">        resp = random.choice(self.values[i])</span><br><span class="line">        <span class="comment"># we've got a response... stuff in reflected text where indicated</span></span><br><span class="line">        pos = resp.find(<span class="string">'%'</span>)</span><br><span class="line">        <span class="keyword">while</span> pos &gt; <span class="number">-1</span>:</span><br><span class="line">          num = int(resp[pos+<span class="number">1</span>:pos+<span class="number">2</span>])</span><br><span class="line">          resp = resp[:pos] + \</span><br><span class="line">            self.translate(match.group(num),gReflections) + \</span><br><span class="line">            resp[pos+<span class="number">2</span>:]</span><br><span class="line">          pos = resp.find(<span class="string">'%'</span>)</span><br><span class="line">        <span class="comment"># fix munged punctuation at the end</span></span><br><span class="line">        <span class="keyword">if</span> resp[<span class="number">-2</span>:] == <span class="string">'?.'</span>: resp = resp[:<span class="number">-2</span>] + <span class="string">'.'</span></span><br><span class="line">        <span class="keyword">if</span> resp[<span class="number">-2</span>:] == <span class="string">'??'</span>: resp = resp[:<span class="number">-2</span>] + <span class="string">'?'</span></span><br><span class="line">        <span class="keyword">return</span> resp</span><br><span class="line"></span><br><span class="line"><span class="comment">#----------------------------------------------------------------------</span></span><br><span class="line"><span class="comment"># gReflections, a translation table used to convert things you say</span></span><br><span class="line"><span class="comment">#    into things the computer says back, e.g. "I am" --&gt; "you are"</span></span><br><span class="line"><span class="comment">#----------------------------------------------------------------------</span></span><br><span class="line">gReflections = &#123;</span><br><span class="line">  <span class="string">"am"</span>   : <span class="string">"are"</span>,</span><br><span class="line">  <span class="string">"was"</span>  : <span class="string">"were"</span>,</span><br><span class="line">  <span class="string">"i"</span>    : <span class="string">"you"</span>,</span><br><span class="line">  <span class="string">"i'd"</span>  : <span class="string">"you would"</span>,</span><br><span class="line">  <span class="string">"i've"</span>  : <span class="string">"you have"</span>,</span><br><span class="line">  <span class="string">"i'll"</span>  : <span class="string">"you will"</span>,</span><br><span class="line">  <span class="string">"my"</span>  : <span class="string">"your"</span>,</span><br><span class="line">  <span class="string">"are"</span>  : <span class="string">"am"</span>,</span><br><span class="line">  <span class="string">"you've"</span>: <span class="string">"I have"</span>,</span><br><span class="line">  <span class="string">"you'll"</span>: <span class="string">"I will"</span>,</span><br><span class="line">  <span class="string">"your"</span>  : <span class="string">"my"</span>,</span><br><span class="line">  <span class="string">"yours"</span>  : <span class="string">"mine"</span>,</span><br><span class="line">  <span class="string">"you"</span>  : <span class="string">"me"</span>,</span><br><span class="line">  <span class="string">"me"</span>  : <span class="string">"you"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#----------------------------------------------------------------------</span></span><br><span class="line"><span class="comment"># gPats, the main response table.  Each element of the list is a</span></span><br><span class="line"><span class="comment">#  two-element list; the first is a regexp, and the second is a</span></span><br><span class="line"><span class="comment">#  list of possible responses, with group-macros labelled as</span></span><br><span class="line"><span class="comment">#  %1, %2, etc.</span></span><br><span class="line"><span class="comment">#----------------------------------------------------------------------</span></span><br><span class="line">gPats = [</span><br><span class="line">  [<span class="string">r'I need (.*)'</span>,</span><br><span class="line">  [  <span class="string">"Why do you need %1?"</span>,</span><br><span class="line">    <span class="string">"Would it really help you to get %1?"</span>,</span><br><span class="line">    <span class="string">"Are you sure you need %1?"</span>]],</span><br><span class="line"></span><br><span class="line">  [<span class="string">r'Why don\'?t you ([^\?]*)\??'</span>,</span><br><span class="line">  [  <span class="string">"Do you really think I don't %1?"</span>,</span><br><span class="line">    <span class="string">"Perhaps eventually I will %1."</span>,</span><br><span class="line">    <span class="string">"Do you really want me to %1?"</span>]],</span><br><span class="line"></span><br><span class="line">  [<span class="string">r'Why can\'?t I ([^\?]*)\??'</span>,</span><br><span class="line">  [  <span class="string">"Do you think you should be able to %1?"</span>,</span><br><span class="line">    <span class="string">"If you could %1, what would you do?"</span>,</span><br><span class="line">    <span class="string">"I don't know -- why can't you %1?"</span>,</span><br><span class="line">    <span class="string">"Have you really tried?"</span>]],</span><br><span class="line"></span><br><span class="line">  [<span class="string">r'I can\'?t (.*)'</span>,</span><br><span class="line">  [  <span class="string">"How do you know you can't %1?"</span>,</span><br><span class="line">    <span class="string">"Perhaps you could %1 if you tried."</span>,</span><br><span class="line">    <span class="string">"What would it take for you to %1?"</span>]],</span><br><span class="line"></span><br><span class="line">  [<span class="string">r'I am (.*)'</span>,</span><br><span class="line">  [  <span class="string">"Did you come to me because you are %1?"</span>,</span><br><span class="line">    <span class="string">"How long have you been %1?"</span>,</span><br><span class="line">    <span class="string">"How do you feel about being %1?"</span>]],</span><br><span class="line"></span><br><span class="line">  [<span class="string">r'I\'?m (.*)'</span>,</span><br><span class="line">  [  <span class="string">"How does being %1 make you feel?"</span>,</span><br><span class="line">    <span class="string">"Do you enjoy being %1?"</span>,</span><br><span class="line">    <span class="string">"Why do you tell me you're %1?"</span>,</span><br><span class="line">    <span class="string">"Why do you think you're %1?"</span>]],</span><br><span class="line"></span><br><span class="line">  [<span class="string">r'Are you ([^\?]*)\??'</span>,</span><br><span class="line">  [  <span class="string">"Why does it matter whether I am %1?"</span>,</span><br><span class="line">    <span class="string">"Would you prefer it if I were not %1?"</span>,</span><br><span class="line">    <span class="string">"Perhaps you believe I am %1."</span>,</span><br><span class="line">    <span class="string">"I may be %1 -- what do you think?"</span>]],</span><br><span class="line"></span><br><span class="line">  [<span class="string">r'What (.*)'</span>,</span><br><span class="line">  [  <span class="string">"Why do you ask?"</span>,</span><br><span class="line">    <span class="string">"How would an answer to that help you?"</span>,</span><br><span class="line">    <span class="string">"What do you think?"</span>]],</span><br><span class="line"></span><br><span class="line">  [<span class="string">r'How (.*)'</span>,</span><br><span class="line">  [  <span class="string">"How do you suppose?"</span>,</span><br><span class="line">    <span class="string">"Perhaps you can answer your own question."</span>,</span><br><span class="line">    <span class="string">"What is it you're really asking?"</span>]],</span><br><span class="line"></span><br><span class="line">  [<span class="string">r'Because (.*)'</span>,</span><br><span class="line">  [  <span class="string">"Is that the real reason?"</span>,</span><br><span class="line">    <span class="string">"What other reasons come to mind?"</span>,</span><br><span class="line">    <span class="string">"Does that reason apply to anything else?"</span>,</span><br><span class="line">    <span class="string">"If %1, what else must be true?"</span>]],</span><br><span class="line"></span><br><span class="line">  [<span class="string">r'(.*) sorry (.*)'</span>,</span><br><span class="line">  [  <span class="string">"There are many times when no apology is needed."</span>,</span><br><span class="line">    <span class="string">"What feelings do you have when you apologize?"</span>]],</span><br><span class="line"></span><br><span class="line">  [<span class="string">r'Hello(.*)'</span>,</span><br><span class="line">  [  <span class="string">"Hello... I'm glad you could drop by today."</span>,</span><br><span class="line">    <span class="string">"Hi there... how are you today?"</span>,</span><br><span class="line">    <span class="string">"Hello, how are you feeling today?"</span>]],</span><br><span class="line"></span><br><span class="line">  [<span class="string">r'I think (.*)'</span>,</span><br><span class="line">  [  <span class="string">"Do you doubt %1?"</span>,</span><br><span class="line">    <span class="string">"Do you really think so?"</span>,</span><br><span class="line">    <span class="string">"But you're not sure %1?"</span>]],</span><br><span class="line"></span><br><span class="line">  [<span class="string">r'(.*) friend (.*)'</span>,</span><br><span class="line">  [  <span class="string">"Tell me more about your friends."</span>,</span><br><span class="line">    <span class="string">"When you think of a friend, what comes to mind?"</span>,</span><br><span class="line">    <span class="string">"Why don't you tell me about a childhood friend?"</span>]],</span><br><span class="line"></span><br><span class="line">  [<span class="string">r'Yes'</span>,</span><br><span class="line">  [  <span class="string">"You seem quite sure."</span>,</span><br><span class="line">    <span class="string">"OK, but can you elaborate a bit?"</span>]],</span><br><span class="line"></span><br><span class="line">  [<span class="string">r'(.*) computer(.*)'</span>,</span><br><span class="line">  [  <span class="string">"Are you really talking about me?"</span>,</span><br><span class="line">    <span class="string">"Does it seem strange to talk to a computer?"</span>,</span><br><span class="line">    <span class="string">"How do computers make you feel?"</span>,</span><br><span class="line">    <span class="string">"Do you feel threatened by computers?"</span>]],</span><br><span class="line"></span><br><span class="line">  [<span class="string">r'Is it (.*)'</span>,</span><br><span class="line">  [  <span class="string">"Do you think it is %1?"</span>,</span><br><span class="line">    <span class="string">"Perhaps it's %1 -- what do you think?"</span>,</span><br><span class="line">    <span class="string">"If it were %1, what would you do?"</span>,</span><br><span class="line">    <span class="string">"It could well be that %1."</span>]],</span><br><span class="line"></span><br><span class="line">  [<span class="string">r'It is (.*)'</span>,</span><br><span class="line">  [  <span class="string">"You seem very certain."</span>,</span><br><span class="line">    <span class="string">"If I told you that it probably isn't %1, what would you feel?"</span>]],</span><br><span class="line"></span><br><span class="line">  [<span class="string">r'Can you ([^\?]*)\??'</span>,</span><br><span class="line">  [  <span class="string">"What makes you think I can't %1?"</span>,</span><br><span class="line">    <span class="string">"If I could %1, then what?"</span>,</span><br><span class="line">    <span class="string">"Why do you ask if I can %1?"</span>]],</span><br><span class="line"></span><br><span class="line">  [<span class="string">r'Can I ([^\?]*)\??'</span>,</span><br><span class="line">  [  <span class="string">"Perhaps you don't want to %1."</span>,</span><br><span class="line">    <span class="string">"Do you want to be able to %1?"</span>,</span><br><span class="line">    <span class="string">"If you could %1, would you?"</span>]],</span><br><span class="line"></span><br><span class="line">  [<span class="string">r'You are (.*)'</span>,</span><br><span class="line">  [  <span class="string">"Why do you think I am %1?"</span>,</span><br><span class="line">    <span class="string">"Does it please you to think that I'm %1?"</span>,</span><br><span class="line">    <span class="string">"Perhaps you would like me to be %1."</span>,</span><br><span class="line">    <span class="string">"Perhaps you're really talking about yourself?"</span>]],</span><br><span class="line"></span><br><span class="line">  [<span class="string">r'You\'?re (.*)'</span>,</span><br><span class="line">  [  <span class="string">"Why do you say I am %1?"</span>,</span><br><span class="line">    <span class="string">"Why do you think I am %1?"</span>,</span><br><span class="line">    <span class="string">"Are we talking about you, or me?"</span>]],</span><br><span class="line"></span><br><span class="line">  [<span class="string">r'I don\'?t (.*)'</span>,</span><br><span class="line">  [  <span class="string">"Don't you really %1?"</span>,</span><br><span class="line">    <span class="string">"Why don't you %1?"</span>,</span><br><span class="line">    <span class="string">"Do you want to %1?"</span>]],</span><br><span class="line"></span><br><span class="line">  [<span class="string">r'I feel (.*)'</span>,</span><br><span class="line">  [  <span class="string">"Good, tell me more about these feelings."</span>,</span><br><span class="line">    <span class="string">"Do you often feel %1?"</span>,</span><br><span class="line">    <span class="string">"When do you usually feel %1?"</span>,</span><br><span class="line">    <span class="string">"When you feel %1, what do you do?"</span>]],</span><br><span class="line"></span><br><span class="line">  [<span class="string">r'I have (.*)'</span>,</span><br><span class="line">  [  <span class="string">"Why do you tell me that you've %1?"</span>,</span><br><span class="line">    <span class="string">"Have you really %1?"</span>,</span><br><span class="line">    <span class="string">"Now that you have %1, what will you do next?"</span>]],</span><br><span class="line"></span><br><span class="line">  [<span class="string">r'I would (.*)'</span>,</span><br><span class="line">  [  <span class="string">"Could you explain why you would %1?"</span>,</span><br><span class="line">    <span class="string">"Why would you %1?"</span>,</span><br><span class="line">    <span class="string">"Who else knows that you would %1?"</span>]],</span><br><span class="line"></span><br><span class="line">  [<span class="string">r'Is there (.*)'</span>,</span><br><span class="line">  [  <span class="string">"Do you think there is %1?"</span>,</span><br><span class="line">    <span class="string">"It's likely that there is %1."</span>,</span><br><span class="line">    <span class="string">"Would you like there to be %1?"</span>]],</span><br><span class="line"></span><br><span class="line">  [<span class="string">r'My (.*)'</span>,</span><br><span class="line">  [  <span class="string">"I see, your %1."</span>,</span><br><span class="line">    <span class="string">"Why do you say that your %1?"</span>,</span><br><span class="line">    <span class="string">"When your %1, how do you feel?"</span>]],</span><br><span class="line"></span><br><span class="line">  [<span class="string">r'You (.*)'</span>,</span><br><span class="line">  [  <span class="string">"We should be discussing you, not me."</span>,</span><br><span class="line">    <span class="string">"Why do you say that about me?"</span>,</span><br><span class="line">    <span class="string">"Why do you care whether I %1?"</span>]],</span><br><span class="line"></span><br><span class="line">  [<span class="string">r'Why (.*)'</span>,</span><br><span class="line">  [  <span class="string">"Why don't you tell me the reason why %1?"</span>,</span><br><span class="line">    <span class="string">"Why do you think %1?"</span> ]],</span><br><span class="line"></span><br><span class="line">  [<span class="string">r'I want (.*)'</span>,</span><br><span class="line">  [  <span class="string">"What would it mean to you if you got %1?"</span>,</span><br><span class="line">    <span class="string">"Why do you want %1?"</span>,</span><br><span class="line">    <span class="string">"What would you do if you got %1?"</span>,</span><br><span class="line">    <span class="string">"If you got %1, then what would you do?"</span>]],</span><br><span class="line"></span><br><span class="line">  [<span class="string">r'(.*) mother(.*)'</span>,</span><br><span class="line">  [  <span class="string">"Tell me more about your mother."</span>,</span><br><span class="line">    <span class="string">"What was your relationship with your mother like?"</span>,</span><br><span class="line">    <span class="string">"How do you feel about your mother?"</span>,</span><br><span class="line">    <span class="string">"How does this relate to your feelings today?"</span>,</span><br><span class="line">    <span class="string">"Good family relations are important."</span>]],</span><br><span class="line"></span><br><span class="line">  [<span class="string">r'(.*) father(.*)'</span>,</span><br><span class="line">  [  <span class="string">"Tell me more about your father."</span>,</span><br><span class="line">    <span class="string">"How did your father make you feel?"</span>,</span><br><span class="line">    <span class="string">"How do you feel about your father?"</span>,</span><br><span class="line">    <span class="string">"Does your relationship with your father relate to your feelings today?"</span>,</span><br><span class="line">    <span class="string">"Do you have trouble showing affection with your family?"</span>]],</span><br><span class="line"></span><br><span class="line">  [<span class="string">r'(.*) child(.*)'</span>,</span><br><span class="line">  [  <span class="string">"Did you have close friends as a child?"</span>,</span><br><span class="line">    <span class="string">"What is your favorite childhood memory?"</span>,</span><br><span class="line">    <span class="string">"Do you remember any dreams or nightmares from childhood?"</span>,</span><br><span class="line">    <span class="string">"Did the other children sometimes tease you?"</span>,</span><br><span class="line">    <span class="string">"How do you think your childhood experiences relate to your feelings today?"</span>]],</span><br><span class="line"></span><br><span class="line">  [<span class="string">r'(.*)\?'</span>,</span><br><span class="line">  [  <span class="string">"Why do you ask that?"</span>,</span><br><span class="line">    <span class="string">"Please consider whether you can answer your own question."</span>,</span><br><span class="line">    <span class="string">"Perhaps the answer lies within yourself?"</span>,</span><br><span class="line">    <span class="string">"Why don't you tell me?"</span>]],</span><br><span class="line"></span><br><span class="line">  [<span class="string">r'quit'</span>,</span><br><span class="line">  [  <span class="string">"Thank you for talking with me."</span>,</span><br><span class="line">    <span class="string">"Good-bye."</span>,</span><br><span class="line">    <span class="string">"Thank you, that will be $150.  Have a good day!"</span>]],</span><br><span class="line"></span><br><span class="line">  [<span class="string">r'(.*)'</span>,</span><br><span class="line">  [  <span class="string">"Please tell me more."</span>,</span><br><span class="line">    <span class="string">"Let's change focus a bit... Tell me about your family."</span>,</span><br><span class="line">    <span class="string">"Can you elaborate on that?"</span>,</span><br><span class="line">    <span class="string">"Why do you say that %1?"</span>,</span><br><span class="line">    <span class="string">"I see."</span>,</span><br><span class="line">    <span class="string">"Very interesting."</span>,</span><br><span class="line">    <span class="string">"%1."</span>,</span><br><span class="line">    <span class="string">"I see.  And what does that tell you?"</span>,</span><br><span class="line">    <span class="string">"How does that make you feel?"</span>,</span><br><span class="line">    <span class="string">"How do you feel when you say that?"</span>]]</span><br><span class="line">  ]</span><br><span class="line"></span><br><span class="line"><span class="comment">#----------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">#  command_interface</span></span><br><span class="line"><span class="comment">#----------------------------------------------------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">command_interface</span><span class="params">()</span>:</span></span><br><span class="line">  print(<span class="string">'Therapist\n---------'</span>)</span><br><span class="line">  print(<span class="string">'Talk to the program by typing in plain English, using normal upper-'</span>)</span><br><span class="line">  print(<span class="string">'and lower-case letters and punctuation.  Enter "quit" when done.'</span>)</span><br><span class="line">  print(<span class="string">'='</span>*<span class="number">72</span>)</span><br><span class="line">  print(<span class="string">'Hello.  How are you feeling today?'</span>)</span><br><span class="line"></span><br><span class="line">  s = <span class="string">''</span></span><br><span class="line">  therapist = eliza();</span><br><span class="line">  <span class="keyword">while</span> s != <span class="string">'quit'</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">      s = input(<span class="string">'&gt; '</span>)</span><br><span class="line">    <span class="keyword">except</span> EOFError:</span><br><span class="line">      s = <span class="string">'quit'</span></span><br><span class="line">    print(s)</span><br><span class="line">    <span class="keyword">while</span> s[<span class="number">-1</span>] <span class="keyword">in</span> <span class="string">'!.'</span>:</span><br><span class="line">      s = s[:<span class="number">-1</span>]</span><br><span class="line">    print(therapist.respond(s))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">  command_interface()</span><br></pre></td></tr></table></figure><pre><code>Therapist---------Talk to the program by typing in plain English, using normal upper-and lower-case letters and punctuation.  Enter &quot;quit&quot; when done.========================================================================Hello.  How are you feeling today?</code></pre><hr><p><strong>脚注</strong></p><p><a name="fn1">[1]</a>：释义摘自苹果电脑上系统内建的《牛津英汉双解辞典》</p><p><a href="#fn1b"><small>↑Back to Content↑</small></a></p><p><a name="fn2">[2]</a>：<a href="https://bit.ly/2tz8v9n" target="_blank" rel="noopener">8 Regular Expressions You Should Know</a> by Vasili</p><p><a href="#fn2b"><small>↑Back to Content↑</small></a></p><p><a name="fn3">[3]</a>：关于校验密码强度的正则表达式，往往需要设置更为复杂的规则，Stackoverflow 上的一则答复中有很好的示例：<a href="https://stackoverflow.com/a/21456918" target="_blank" rel="noopener">https://stackoverflow.com/a/21456918</a></p><p><a href="#fn3b"><small>↑Back to Content↑</small></a></p><p><a name="fn4">[4]</a>：<a href="http://www.ex-parrot.com/pdw/Mail-RFC822-Address.html" target="_blank" rel="noopener">http://www.ex-parrot.com/pdw/Mail-RFC822-Address.html</a></p><p><a href="#fn4b"><small>↑Back to Content↑</small></a></p><p><a name="fn5">[5]</a>：Parry 的源代码（用 Lisp 写的）在这里：<a href="http://www.cs.cmu.edu/afs/cs/project/ai-repository/ai/areas/classics/parry/" target="_blank" rel="noopener">http://www.cs.cmu.edu/afs/cs/project/ai-repository/ai/areas/classics/parry/</a></p><p><a href="#fn5b"><small>↑Back to Content↑</small></a></p><p><a name="fn6">[6]</a>：ELIZA 和 Parry 的完整聊天记录在这里：<a href="https://tools.ietf.org/html/rfc439" target="_blank" rel="noopener">https://tools.ietf.org/html/rfc439</a></p><p><a href="#fn6b"><small>↑Back to Content↑</small></a></p>]]></content>
      
      
      
        <tags>
            
            <tag> Python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HMM 隐式马尔可夫模型</title>
      <link href="/2019/08/29/HMM_example/"/>
      <url>/2019/08/29/HMM_example/</url>
      
        <content type="html"><![CDATA[<h2 id="Hidden-Markov-Model-隐含马尔可夫模型和-Viterbi-algorithm-维特比算法示例"><a href="#Hidden-Markov-Model-隐含马尔可夫模型和-Viterbi-algorithm-维特比算法示例" class="headerlink" title="Hidden Markov Model 隐含马尔可夫模型和 Viterbi algorithm 维特比算法示例"></a>Hidden Markov Model 隐含马尔可夫模型和 Viterbi algorithm 维特比算法示例</h2><p>基本概念：首先它得是一个统计模型，通过已有的样本来预测马尔可夫过程中的隐含参数。</p><p>可见状态链：观测得到的样本组成的数据集</p><p>隐含状态链：样本背后的隐含的数据集</p><p>转换概率 transition probability：可随意设定转换概率，根据不同的转换概率会得到不同的HMM模型</p><p>输出概率 emission probability：从隐含状态转换为可见状态时的概率，也可自由设定</p><a id="more"></a> <p>提到马尔可夫链，基本上指的都是隐含状态链，因为在隐含状态链之间存在转换概率。我们在求马尔可夫过程的时候，可以分为以下情况：</p><p>​                知道<strong><em>隐含状态数量</em></strong>，知道<strong><em>转换概率</em></strong>，根据<strong><em>可见状态链</em></strong>，求<strong><em>隐含状态链</em></strong>。这是最简单的解码问题，有两种解决方法，两种都对，但结果的意义不一样。一种解法，通过最大似然直接对链的整体找到最可能的解，另一种通过对每一个单次事件概率。两种的差异个人觉得在于看中整体与局部。</p><p>​                知道<strong><em>隐含状态数量</em></strong>，知道<strong><em>转换概率</em></strong>，根据<strong><em>可见状态链</em></strong>，求<strong><em>发生可见状态链的概率</em></strong>。这种问题是用来检测数据是否真的与模型吻合。</p><p>​                知道<strong><em>隐含状态数量</em></strong>，不知道<strong><em>转换概率</em></strong>，根据<strong><em>可见状态链</em></strong>，求<strong><em>转换概率</em></strong>。这种为最常见的情况。此处用到Viterbi algorithm 算法。直接以下面的晴雨天为例子</p><blockquote><p> 说两句废话，答主认为呢，要了解一个算法，要做到以下两点：会其意，知其形。答主回答的，其实主要是第一点。但是这一点呢，恰恰是最重要，而且很多书上不会讲的。正如你在追一个姑娘，姑娘对你说“你什么都没做错！”你要是只看姑娘的表达形式呢，认为自己什么都没做错，显然就理解错了。你要理会姑娘的意思，“你赶紧给我道歉！”这样当你看到对应的表达形式呢，赶紧认错，跪地求饶就对了。数学也是一样，你要是不理解意思，光看公式，往往一头雾水。不过呢，数学的表达顶多也就是晦涩了点，姑娘的表达呢，有的时候就完全和本意相反。所以答主一直认为理解姑娘比理解数学难多了。</p></blockquote><p>HMM（隐马尔可夫模型）是用来描述隐含未知参数的统计模型，举一个经典的例子：一个东京的朋友每天根据天气{下雨，天晴}决定当天的活动{公园散步,购物,清理房间}中的一种，我每天只能在twitter上看到她发的推“啊，我前天公园散步、昨天购物、今天清理房间了！”，那么我可以根据她发的推特推断东京这三天的天气。在这个例子里，显状态是活动，隐状态是天气</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># Filename: viterbi.py</span></span><br><span class="line"><span class="comment"># Author：hankcs</span></span><br><span class="line"><span class="comment"># Date: 2014-05-13 下午8:51</span></span><br><span class="line"></span><br><span class="line">states = (<span class="string">'Rainy'</span>, <span class="string">'Sunny'</span>)</span><br><span class="line"></span><br><span class="line">observations = (<span class="string">'walk'</span>, <span class="string">'shop'</span>, <span class="string">'clean'</span>)</span><br><span class="line"></span><br><span class="line">start_probability = &#123;<span class="string">'Rainy'</span>: <span class="number">0.6</span>, <span class="string">'Sunny'</span>: <span class="number">0.4</span>&#125;</span><br><span class="line"></span><br><span class="line">transition_probability = &#123;</span><br><span class="line">    <span class="string">'Rainy'</span>: &#123;<span class="string">'Rainy'</span>: <span class="number">0.7</span>, <span class="string">'Sunny'</span>: <span class="number">0.3</span>&#125;,</span><br><span class="line">    <span class="string">'Sunny'</span>: &#123;<span class="string">'Rainy'</span>: <span class="number">0.4</span>, <span class="string">'Sunny'</span>: <span class="number">0.6</span>&#125;,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">emission_probability = &#123;</span><br><span class="line">    <span class="string">'Rainy'</span>: &#123;<span class="string">'walk'</span>: <span class="number">0.1</span>, <span class="string">'shop'</span>: <span class="number">0.4</span>, <span class="string">'clean'</span>: <span class="number">0.5</span>&#125;,</span><br><span class="line">    <span class="string">'Sunny'</span>: &#123;<span class="string">'walk'</span>: <span class="number">0.6</span>, <span class="string">'shop'</span>: <span class="number">0.3</span>, <span class="string">'clean'</span>: <span class="number">0.1</span>&#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 打印路径概率表</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">print_dptable</span><span class="params">(V)</span>:</span></span><br><span class="line">    print(<span class="string">"    "</span>),</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(len(V)):</span><br><span class="line">        print(<span class="string">"%7d"</span> % i),</span><br><span class="line">    <span class="keyword">print</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> y <span class="keyword">in</span> V[<span class="number">0</span>].keys():</span><br><span class="line">        print(<span class="string">"%.5s: "</span> % y),</span><br><span class="line">        <span class="keyword">for</span> t <span class="keyword">in</span> range(len(V)):</span><br><span class="line">            print(<span class="string">"%.7s"</span> % (<span class="string">"%f"</span> % V[t][y])),</span><br><span class="line">        <span class="keyword">print</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">viterbi</span><span class="params">(obs, states, start_p, trans_p, emit_p)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    # 任何一个HMM都可以通过下列五元组来描述</span></span><br><span class="line"><span class="string">    :param obs:观测序列</span></span><br><span class="line"><span class="string">    :param states:隐状态</span></span><br><span class="line"><span class="string">    :param start_p:初始概率（隐状态）</span></span><br><span class="line"><span class="string">    :param trans_p:转移概率（隐状态）</span></span><br><span class="line"><span class="string">    :param emit_p: 发射概率 （隐状态表现为显状态的概率）</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="comment"># 路径概率表 V[时间][隐状态] = 概率</span></span><br><span class="line">    V = [&#123;&#125;]</span><br><span class="line">    <span class="comment"># 一个中间变量，代表当前状态是哪个隐状态</span></span><br><span class="line">    path = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 初始化初始状态 (t == 0)</span></span><br><span class="line">    print(<span class="string">'Day 1(walk): '</span>)</span><br><span class="line">    <span class="keyword">for</span> y <span class="keyword">in</span> states:</span><br><span class="line">        V[<span class="number">0</span>][y] = start_p[y] * emit_p[y][obs[<span class="number">0</span>]]</span><br><span class="line">        path[y] = [y]</span><br><span class="line">        <span class="keyword">print</span> y, V[<span class="number">0</span>][y], <span class="string">'='</span>, start_p[y], <span class="string">'*'</span>, emit_p[y][obs[<span class="number">0</span>]]</span><br><span class="line">    print(<span class="string">'_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _'</span>)</span><br><span class="line">    <span class="keyword">print</span><span class="string">'V: '</span>, V</span><br><span class="line">    print(<span class="string">'__________________________________________'</span>)</span><br><span class="line">    <span class="comment"># 对 t &gt; 0 跑一遍维特比算法</span></span><br><span class="line">    <span class="keyword">for</span> t <span class="keyword">in</span> range(<span class="number">1</span>, len(obs)):</span><br><span class="line">        V.append(&#123;&#125;)</span><br><span class="line">        newpath = &#123;&#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">print</span> <span class="string">'Day'</span>, t+<span class="number">1</span>, <span class="string">'('</span>+obs[t]+<span class="string">')'</span></span><br><span class="line">        <span class="keyword">for</span> y <span class="keyword">in</span> states:</span><br><span class="line">            <span class="comment"># 概率 隐状态 =    前状态是y0的概率 * y0转移到y的概率 * y表现为当前状态的概率</span></span><br><span class="line">            <span class="comment"># (prob, state) = max([(V[t - 1][y0] * trans_p[y0][y] * emit_p[y][obs[t]], y0) for y0 in states])</span></span><br><span class="line">            tmpList = []</span><br><span class="line">            <span class="keyword">print</span></span><br><span class="line">            <span class="keyword">for</span> y0 <span class="keyword">in</span> states:</span><br><span class="line">                tmpList.append((V[t - <span class="number">1</span>][y0] * trans_p[y0][y] * \</span><br><span class="line">                emit_p[y][obs[t]], y0))</span><br><span class="line"></span><br><span class="line">                <span class="keyword">print</span> <span class="string">'當天'</span>+y+<span class="string">': '</span>, <span class="string">"%.7s"</span> % (V[t - <span class="number">1</span>][y0] * trans_p[y0][y] * \</span><br><span class="line">emit_p[y][obs[t]]),</span><br><span class="line">                <span class="keyword">print</span> <span class="string">'='</span>,</span><br><span class="line">                <span class="keyword">print</span> V[t - <span class="number">1</span>][y0], <span class="string">'(前一天 '</span>+y0+<span class="string">')'</span>, <span class="string">'*'</span>,</span><br><span class="line">                <span class="keyword">print</span> trans_p[y0][y], <span class="string">'('</span>+y0+<span class="string">' to '</span>+y+<span class="string">')'</span>, <span class="string">'*'</span>,</span><br><span class="line">                <span class="keyword">print</span> emit_p[y][obs[t]], <span class="string">'('</span>+y, obs[t]+<span class="string">')'</span></span><br><span class="line">            <span class="keyword">print</span> <span class="string">'當天'</span>+y+<span class="string">'  最大的是: '</span>, max(tmpList)[<span class="number">0</span>]</span><br><span class="line">            (prob, state) = max(tmpList)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 记录最大概率</span></span><br><span class="line">            V[t][y] = prob</span><br><span class="line">            <span class="comment"># 记录路径</span></span><br><span class="line">            newpath[y] = path[state] + [y]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 不需要保留旧路径</span></span><br><span class="line">        path = newpath</span><br><span class="line">        print(<span class="string">'__________________________________________'</span>)</span><br><span class="line"></span><br><span class="line">    print_dptable(V)</span><br><span class="line">    (prob, state) = max([(V[len(obs) - <span class="number">1</span>][y], y) <span class="keyword">for</span> y <span class="keyword">in</span> states])</span><br><span class="line">    <span class="keyword">return</span> (prob, path[state])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">example</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> viterbi(observations,</span><br><span class="line">                   states,</span><br><span class="line">                   start_probability,</span><br><span class="line">                   transition_probability,</span><br><span class="line">                   emission_probability)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">print(example())</span><br><span class="line"></span><br><span class="line">print(<span class="string">'\n訣竅: 從最後一天推算，\n1. Day3 機率最大的那條路徑\n2. 其Day2 機率最大那條路徑\n3. 的最可能Day1'</span>)</span><br></pre></td></tr></table></figure><p>所以说 逐渐增加长度，每增加一次长度，之后再重新算一遍在这个长度下最后一个位置的转换概率，计算到最后一位时，就知道了每个位置的最大概率。</p><p>结果：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">Day 1(walk): </span><br><span class="line">Rainy 0.06 = 0.6 * 0.1</span><br><span class="line">Sunny 0.24 = 0.4 * 0.6</span><br><span class="line">_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _</span><br><span class="line">V:  [&#123;&apos;Rainy&apos;: 0.06, &apos;Sunny&apos;: 0.24&#125;]</span><br><span class="line">__________________________________________</span><br><span class="line">Day 2 (shop)</span><br><span class="line"></span><br><span class="line">當天Rainy:  0.0168 = 0.06 (前一天 Rainy) * 0.7 (Rainy to Rainy) * 0.4 (Rainy shop)</span><br><span class="line">當天Rainy:  0.0384 = 0.24 (前一天 Sunny) * 0.4 (Sunny to Rainy) * 0.4 (Rainy shop)</span><br><span class="line">當天Rainy  最大的是:  0.0384</span><br><span class="line"></span><br><span class="line">當天Sunny:  0.0054 = 0.06 (前一天 Rainy) * 0.3 (Rainy to Sunny) * 0.3 (Sunny shop)</span><br><span class="line">當天Sunny:  0.0432 = 0.24 (前一天 Sunny) * 0.6 (Sunny to Sunny) * 0.3 (Sunny shop)</span><br><span class="line">當天Sunny  最大的是:  0.0432</span><br><span class="line">__________________________________________</span><br><span class="line">Day 3 (clean)</span><br><span class="line"></span><br><span class="line">當天Rainy:  0.01344 = 0.0384 (前一天 Rainy) * 0.7 (Rainy to Rainy) * 0.5 (Rainy clean)</span><br><span class="line">當天Rainy:  0.00864 = 0.0432 (前一天 Sunny) * 0.4 (Sunny to Rainy) * 0.5 (Rainy clean)</span><br><span class="line">當天Rainy  最大的是:  0.01344</span><br><span class="line"></span><br><span class="line">當天Sunny:  0.00115 = 0.0384 (前一天 Rainy) * 0.3 (Rainy to Sunny) * 0.1 (Sunny clean)</span><br><span class="line">當天Sunny:  0.00259 = 0.0432 (前一天 Sunny) * 0.6 (Sunny to Sunny) * 0.1 (Sunny clean)</span><br><span class="line">當天Sunny  最大的是:  0.002592</span><br><span class="line">__________________________________________</span><br><span class="line">           0       1       2</span><br><span class="line">Rainy:  0.06000 0.03840 0.01344</span><br><span class="line">Sunny:  0.24000 0.04320 0.00259</span><br><span class="line">(0.01344, [&apos;Sunny&apos;, &apos;Rainy&apos;, &apos;Rainy&apos;])</span><br><span class="line"></span><br><span class="line">訣竅: 從最後一天推算，</span><br><span class="line">1. Day3 機率最大的那條路徑</span><br><span class="line">2. 其Day2 機率最大那條路徑</span><br><span class="line">3. 的最可能Day1</span><br></pre></td></tr></table></figure><blockquote><p><a href="https://gist.github.com/yesseecity" target="_blank" rel="noopener">https://gist.github.com/yesseecity</a> 将步骤列出</p><p><a href="http://www.hankcs.com/nlp/hmm-and-segmentation-tagging-named-entity-recognition.html" target="_blank" rel="noopener">http://www.hankcs.com/nlp/hmm-and-segmentation-tagging-named-entity-recognition.html</a> 一个根据天气和推特的例子</p><p><a href="https://cloud.tencent.com/developer/article/1066699" target="_blank" rel="noopener">https://cloud.tencent.com/developer/article/1066699</a> 马尔可夫模型简单理解</p></blockquote>]]></content>
      
      
      
        <tags>
            
            <tag> HMM </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MAKER相关操作</title>
      <link href="/2019/08/21/MAKER%E7%9B%B8%E5%85%B3%E6%93%8D%E4%BD%9C/"/>
      <url>/2019/08/21/MAKER%E7%9B%B8%E5%85%B3%E6%93%8D%E4%BD%9C/</url>
      
        <content type="html"><![CDATA[<p>####maker pipeline</p><p>1.Initial MAKER Analysis</p><p>2.Training Gene Prediction (snap, augustus) </p><p>3.Round 2 MAKER Analysis</p><p>4.Training Gene Prediction (snap, augustus)</p><p>5.Round 3 MAKER Analysis</p><p>6.Create Maker standard gene set file</p><p>7.PASA </p><a id="more"></a> <h5 id="1-Initial-MAKER-Analysis"><a href="#1-Initial-MAKER-Analysis" class="headerlink" title="1.Initial MAKER Analysis"></a>1.Initial MAKER Analysis</h5><p>#创建第一次运行maker需要的config文件 </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">maker -CTL</span><br></pre></td></tr></table></figure><p>#查看修改opts文件，运行maker</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># set of ESTs or assembled mRNA-seq in fasta format 三代转录数据</span><br><span class="line"></span><br><span class="line">est=/home/Data/avianbase/Prunella_strophita_BWA_INDEX/polished.hq.fasta</span><br><span class="line"></span><br><span class="line"># protein sequence file in fasta format (i.e. from mutiple oransisms) 从ensembl数据库中下载的human mus chicken Tae 数据 cat合并</span><br><span class="line"> </span><br><span class="line">protein=/home/Data/avianbase/Prunella_strophita_BWA_INDEX/ensembl/all/merge_pep.fa </span><br><span class="line"></span><br><span class="line"># 首次运行maker将est2 genome 与protein2genome 设置为1 ，即从头预测</span><br><span class="line"></span><br><span class="line">est2genome=1 </span><br><span class="line">protein2genome=1</span><br><span class="line"></span><br><span class="line"># 设置完成后执行</span><br><span class="line"></span><br><span class="line">nohup mpiexec -n 40 maker &gt; run_maker.log</span><br></pre></td></tr></table></figure><hr><p>#maker产生的结果</p><p>​    -Prunella_strophita_assemble_master_datastore_index.log 记录了每一个contig 比对的情况</p><p>使用maker的 gff3_merge     ### fasta_merge ###  对log文件进行注释信息的提取，在得到的 Prunella_strophita_assemble.maker.gff 文件中，包含了est , protein,  repeat masker 以及 maker 的注释结果</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">#################</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># generate_gff.sh</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">#################</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># sed -i 's/rndN/-/g' generate_gff.sh</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 每一轮用sed替换rndN信息</span></span><br><span class="line">gff3_merge -s -d Prunella_strophita_assemble_master_datastore_index.log &gt; Prunella_strophita_assemble.maker.gff</span><br><span class="line">fasta_merge -d Prunella_strophita_assemble_master_datastore_index.log</span><br><span class="line">gff3_merge -n -s -d Prunella_strophita_assemble_master_datastore_index.log &gt; Prunella_strophita_assemble.maker.noseq.gff</span><br><span class="line"><span class="meta">#</span><span class="bash"> est alignments</span></span><br><span class="line">awk '&#123; if ($2 == "est2genome") print $0 &#125;' Prunella_strophita_assemble.maker.noseq.gff &gt; Prunella_rndN.maker.est2genome.gff</span><br><span class="line"><span class="meta">#</span><span class="bash"> protein alignments</span></span><br><span class="line">awk '&#123; if ($2 == "protein2genome") print $0 &#125;' Prunella_strophita_assemble.maker.noseq.gff &gt;  Prunella_rndN.maker.protein2genome.gff</span><br><span class="line"><span class="meta">#</span><span class="bash"> repeat alignments</span></span><br><span class="line">awk '&#123; if ($2 ~ "repeat") print $0 &#125;' Prunella_strophita_assemble.maker.noseq.gff &gt;  Prunella_rndN.maker.repeats.gff</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> current dir </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> /home/maker/20190718_version_maker/round1/Prunella_strophita_assemble.maker.output</span></span><br><span class="line"></span><br><span class="line">sed -i 's/rndN/rnd1/g' generate_gff.sh</span><br><span class="line">sh generate_gff.sh</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 对产生的gff统计基因数量与平均长度</span></span><br><span class="line">cat Prunella_strophita_assemble.maker.noseq.gff | awk '&#123; if ($3 == "gene") print $0 &#125;' | awk '&#123; sum += ($5 - $4) &#125; END &#123; print NR, sum / NR &#125;'</span><br><span class="line"></span><br><span class="line">sh gene_count.sh</span><br><span class="line">round1 result: 19711 7584.01</span><br></pre></td></tr></table></figure><h5 id="2-Training-Gene-Prediction"><a href="#2-Training-Gene-Prediction" class="headerlink" title="2.Training Gene Prediction"></a>2.Training Gene Prediction</h5><p>#将     snap.sh     busco.sh     gene_count.sh     cp到结果文件夹</p><p>通过训练基因模型再次注释提升预测的准确性</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">##################</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">## snap 基因结构预测</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">##################</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">## snap.sh</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">##################</span></span></span><br><span class="line"></span><br><span class="line">mkdir snap</span><br><span class="line">mkdir snap/round1</span><br><span class="line">cd snap/round1</span><br><span class="line">maker2zff -x 0.25 -l 50 -d ../../Prunella_strophita_assemble_master_datastore_index.log</span><br><span class="line">rename genome Prunella_rnd1.zff.length50_aed0.25 genome*</span><br><span class="line">fathom Prunella_rnd1.zff.length50_aed0.25.ann Prunella_rnd1.zff.length50_aed0.25.dna -gene-stats &gt; gene-stats.log 2&gt;&amp;1</span><br><span class="line">fathom  Prunella_rnd1.zff.length50_aed0.25.ann Prunella_rnd1.zff.length50_aed0.25.dna -validate &gt; validate.log 2&gt;&amp;1</span><br><span class="line">fathom  Prunella_rnd1.zff.length50_aed0.25.ann Prunella_rnd1.zff.length50_aed0.25.dna -categorize 1000 &gt; categorize.log 2&gt;&amp;1</span><br><span class="line">fathom uni.ann uni.dna -export 1000 -plus &gt; uni-plus.log 2&gt;&amp;1</span><br><span class="line">mkdir params</span><br><span class="line">cd params</span><br><span class="line">forge ../export.ann ../export.dna &gt; ../forge.log 2&gt;&amp;1</span><br><span class="line">cd ..</span><br><span class="line">hmm-assembler.pl Prunella_rnd1.zff.length50_aed0.25 params &gt; Prunella_rnd1.zff.length50_aed0.25.hmm</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">###################</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">## BUSCO 基因结构预测</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">###################</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">首先为了预测环境的准确性，将第一轮maker运行结果中的gff文件添加首末端1000bp的长度，可能会导致某些注释的mrna超过scaffold的边界，从而会导致bedtools报错，可以统计前后mrna的数量用以计算，而且此项影响较小。</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">## run_BUSCO.sh</span></span></span><br><span class="line">awk -v OFS="\t" '&#123; if ($3 == "mRNA") print $1, $4, $5 &#125;' Prunella_strophita_assemble.maker.noseq.gff | \</span><br><span class="line">  awk -v OFS="\t" '&#123; if ($2 &lt; 1000) print $1, "0", $3+1000; else print $1, $2-1000, $3+1000 &#125;' | \</span><br><span class="line">  bedtools getfasta -fi /home/Data/avianbase/Prunella_strophita_INDEX/Prunella_strophita_assemble.fa  -bed - -fo Prunella_rnd1.all.maker.transcripts1000.fasta</span><br><span class="line"></span><br><span class="line">mkdir busco</span><br><span class="line">cd busco</span><br><span class="line">BUSCO.py -i Prunella_rnd1.all.maker.transcripts1000.fasta -o Prunella_rnd1 -l /home/maker/software/maker/exe/busco/ave_odb9/ -m genome -c 8 --long -sp human -z --augustus_prameters '--progress=true'</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> busco 的结果需要提取并修改为 augustus 物种进行下一轮的预测</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># BUSCO_rndN_number  oringin</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># species_name       target</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">###############</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">## generate_species.sh</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">###############</span></span></span><br><span class="line"></span><br><span class="line">rename BUSCO_rndN_number species_name *</span><br><span class="line">sed -i 's/BUSCO_rndN_number/species_name/g' species_name_parameters.cfg</span><br><span class="line">sed -i 's/BUSCO_rndN_number/species_name/g' species_name_parameters.cfg.orig1</span><br><span class="line">mkdir ~/software/maker/exe/augustus/config/species/species_name</span><br><span class="line">cp species_name* ~/software/maker/exe/augustus/config/species/species_name</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> current dir /home/maker/20190718_version_maker/round1/Prunella_strophita_assemble.maker.output</span></span><br><span class="line">sh snap.sh</span><br><span class="line">sh run_busco.sh</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cd /home/maker/20190718_version_maker/round/Prunella_strophita_assemble.maker.output/busco/run_0726_rnd1/augustus_output/retraining_parameters</span><br><span class="line">sed -i 's/rndN/rnd1/g' generate_species.sh</span><br><span class="line">sed -i 's/species_name/Prunella_chiecken_rnd1/g' generate_species.sh</span><br><span class="line">sh generate_species.sh</span><br></pre></td></tr></table></figure><p>#####3.Round 2 MAKER Analysis</p><p>将第一轮生成的gff结果中 est2genome.gff 和 protein2genome.gff 和 repeats.gff 以及 snap预测的基因模型中 hmm 文件输入第二轮的maker_opts.ctl</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">cd /home/maker/maker_0720/round2</span><br><span class="line"></span><br><span class="line">maker -CTL</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 将maker_opts文件中的 snap 与 Augustus 预测文件添加，将 est2genome.gff, protein2genome.gff,  repeats.gff 输入，将est2genome protein2genome 设置为0</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">est_gff=/home/maker/20190704_version_maker/rnd2_data/Prunella_rnd1.all.maker.est2genome.gff   <span class="comment">#aligned ESTs or mRNA-seq from an external GFF3 file</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">genome=/home/Data/avianbase/Prunella_strophita_BWA_INDEX/Prunella_strophita_assemble.fa </span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">protein_gff=/home/maker/20190704_version_maker/rnd2_data/Prunella_rnd1.all.maker.protein2genome.gff  <span class="comment">#aligned protein homology evidence from an external GFF3 file</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">rm_gff=/home/maker/20190704_version_maker/rnd2_data/Prunella_rnd1.all.maker.repeats.gff <span class="comment">#pre-identified repeat elements from an external GFF3 file</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">snaphmm=/home/maker/20190704_version_maker/rnd2_data/Prunella_rnd1.zff.length50_aed0.25.hmm <span class="comment">#SNAP HMM file</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">augustus_species=Prunell_strophita <span class="comment">#Augustus gene prediction species model</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">max_dna_len=300000 <span class="comment">#length for dividing up contigs into chunks (increases/decreases memory usage)</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">split_hit=20000 <span class="comment">#length for the splitting of hits (expected max intron size for evidence alignments)</span></span></span><br><span class="line"></span><br><span class="line">nohup mpiexec -n 40 maker &gt; run_maker.log</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">#################</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># generate_gff.sh</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">#################</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># sed -i 's/rndN/-/g' generate_gff.sh</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 每一轮用sed替换rndN信息</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 因为预测结果中使用基因结构预测</span></span><br><span class="line"></span><br><span class="line">gff3_merge -s -d Prunella_strophita_assemble_master_datastore_index.log &gt; Prunella_strophita_assemble.maker.gff</span><br><span class="line">fasta_merge -d Prunella_strophita_assemble_master_datastore_index.log</span><br><span class="line">gff3_merge -n -s -d Prunella_strophita_assemble_master_datastore_index.log &gt; Prunella_strophita_assemble.maker.noseq.gff</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> est alignments</span></span><br><span class="line">awk '&#123; if ($2 ~ "est2genome") print $0 &#125;' Prunella_strophita_assemble.maker.noseq.gff &gt; Prunella_rndN.maker.est2genome.gff</span><br><span class="line"><span class="meta">#</span><span class="bash"> protein alignments</span></span><br><span class="line">awk '&#123; if ($2 ~ "protein2genome") print $0 &#125;' Prunella_strophita_assemble.maker.noseq.gff &gt;  Prunella_rndN.maker.protein2genome.gff</span><br><span class="line"><span class="meta">#</span><span class="bash"> repeat alignments</span></span><br><span class="line">awk '&#123; if ($2 ~ "repeat") print $0 &#125;' Prunella_strophita_assemble.maker.noseq.gff &gt;  Prunella_rndN.maker.repeats.gff</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sed -i 's/rndN/rnd2/g' generate_gff.sh</span><br><span class="line">sh generate_gff.sh</span><br><span class="line"></span><br><span class="line">sh gene_count.sh</span><br><span class="line">18227 13821.9</span><br><span class="line"><span class="meta">#</span><span class="bash"> 由于第一轮是根据已有信息预测，长度在第二轮得到了修正</span></span><br></pre></td></tr></table></figure><h5 id="4-Training-Gene-Prediction"><a href="#4-Training-Gene-Prediction" class="headerlink" title="4.Training Gene Prediction"></a>4.Training Gene Prediction</h5><p># 与第二步相同, 将 snap.sh     busco.sh     gene_count.sh     cp到结果文件夹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sed -i 's/rnd1/rnd2/g' *.sh</span><br><span class="line">sed -i 's/round1/round2/g' snap.sh</span><br><span class="line">sed -i 's/00rnd1/01_rnd2/g' run_BUSCO.sh</span><br><span class="line">sh snap.sh</span><br><span class="line">sh run_BUSCO.sh</span><br><span class="line">cd busco/augustus_output/retraining_paramters</span><br><span class="line">sh generate_species.sh</span><br></pre></td></tr></table></figure><p>#####5.Round 3 MAKER analysis</p><p>将第二轮maker结果输入maker_opts.ctl 重复第三步</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim maker_opts.ctl</span><br><span class="line">nohup mpiexec -n 40 maker &gt; run_maker.log</span><br><span class="line">sh generate_gff.sh</span><br></pre></td></tr></table></figure><p>#####6.Create Maker standard gene set file</p><p># 对第三轮的maker 结果</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">awk -v OFS="\t" '&#123; if ($3 == "mRNA") print $1, $4, $5 &#125;' /home/maker/20190704_version_maker/02_rnd3/Prunella_strophita_assemble.output/Prunella_strophita_assemble.maker.noseq.gff | \</span><br><span class="line">  bedtools getfasta -fi /home/Data/avianbase/Prunella_strophita_INDEX/Prunella_strophita_assemble.fa -bed - -fo Prunella_rnd3.all.maker.fasta</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mkdir busco</span><br><span class="line">cd busco</span><br><span class="line"><span class="meta">#</span><span class="bash"> 不再再添加前后1000bp的片段，同时运行busco时将model改为 transcriptome </span></span><br><span class="line">run_BUSCO.py -i Prunella_rnd3.all.maker.transcripts.fasta -o Prunella_rnd3 -l /home/maker/software/busco-master/aves_odb9/  -m transcriptome -c 8 -sp Prunella_chicken_rnd2 -z --augustus_parameters='--progress=true'</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看busco的完整性检查结果</span></span><br><span class="line">less run_Prunella_rnd3/short_summary_Prunella_rnd3.txt</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> gne count</span></span><br><span class="line">sh gene_count.sh</span><br><span class="line">18148 13917.2</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 提取结果中maker注释的gff部分</span></span><br><span class="line">perl get_maker_gff.pl Prunella_strophita_assemble.maker.noseq.gff Prunella_strophita_assemble.maker.only.final.noseq.gff</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 替换gff中的ID</span></span><br><span class="line">maker_map_ids --prefix Prunella --justify 5 Prunella_strophita_assemble.maker.noseq.gff &gt;</span><br><span class="line">Prunella_rnd3.maker.name.map</span><br><span class="line"></span><br><span class="line">map_gff_ids Prunella_rnd3.maker.name.map Prunella_strophita_assemble.maker.only.final.noseq.gff</span><br></pre></td></tr></table></figure><table><thead><tr><th>Gene number</th><th>Gene average length</th><th>Info</th></tr></thead><tbody><tr><td>19711</td><td>7584.01</td><td>Round 1</td></tr><tr><td>18227</td><td>13821.9</td><td>Round 2</td></tr><tr><td>18148</td><td>13917.2</td><td>Round 3</td></tr></tbody></table><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">grep 'three_prime_UTR' Prunella_strophita_assemble.maker.only.final.noseq.gff | wc -l</span><br><span class="line">2752</span><br><span class="line">grep 'five_prime_UTR' Prunella_strophita_assemble.maker.only.final.noseq.gff | wc -l</span><br><span class="line">2494</span><br></pre></td></tr></table></figure><h5 id="7-PASA-prediect-utr-region"><a href="#7-PASA-prediect-utr-region" class="headerlink" title="7.PASA prediect utr region"></a>7.PASA prediect utr region</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> gmap cds2gff</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> clean cds 去除低质量序列</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> /data/maker/PASA_20/data</span></span><br><span class="line">/home/maker/software/PASApipeline/bin/seqclean XZ15142.hq.fasta</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> custom alignments gff  首先对基因组index然后比对生成 cds 和 gene 模式gff</span></span><br><span class="line">/home/maker/software/PASApipeline/scripts/process_GMAP_alignments_gff3_chimeras_ok.pl --genome Prunella_strophita_assemble.fa  --transcripts XZ15142.hq.fasta.clean --CPU 2 -N 2  -I 500000  &gt; gmap.spliced_alignments.gff3</span><br><span class="line"></span><br><span class="line">gmap -D . -d Prunella_strophita_assemble.fa.gmap -f 2 -n 2 -x 50 -t 2 -B 5  --max-intronlength-middle=500000 --max-intronlength-ends=500000 XZ15142.hq.fasta.clean</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Running Alignment Assembly 将基因组与cds信息比对</span></span><br><span class="line">/home/maker/software/PASApipeline/Launch_PASA_pipeline.pl -c sqlite_conf/alignAssembly.config -C -r -R -g data/Prunella_strophita_assemble.fa -t data/XZ15142.hq.fasta.clean -T -u data/XZ15142.hq.fasta --ALIGNERS blat --CPU 2 -N 2 --IMPORT_CUSTOM_ALIGNMENTS_GFF3 data/gmap.spliced_alignments.gff3</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Building comprehensive transcriptome database 将结果输入到sqlite数据库</span></span><br><span class="line">~/software/PASApipeline/scripts/build_comprehensive_transcriptome.dbi -c sqlite_conf/alignAssembly.config -t data/XZ15142.hq.fasta.clean</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> First round, using pre-existing gene structure annotations 对 gff进行update</span></span><br><span class="line">  ~/software/PASApipeline/Launch_PASA_pipeline.pl -c sqlite_conf/annotCompare.config -g data/Prunella_strophita_assemble.fa -t data/XZ15142.hq.fasta.clean -A -L --annots data/gmap_gene.gff3 --CPU 2</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Second round</span></span><br><span class="line">~/software/PASApipeline/Launch_PASA_pipeline.pl -c sqlite_conf/annotCompare.config -g data/Prunella_strophita_assemble.fa -t data/XZ15142.hq.fasta.clean -A -L --annots  --CPU 2</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> Markdown, maker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hello World</title>
      <link href="/2019/08/13/hello-world/"/>
      <url>/2019/08/13/hello-world/</url>
      
        <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="noopener">GitHub</a>.</p><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="noopener">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="noopener">Deployment</a></p>]]></content>
      
      
      
    </entry>
    
    
  
  
</search>
